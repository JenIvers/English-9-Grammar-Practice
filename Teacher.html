<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
      body{font-family:'Nunito',sans-serif;background-color:#f4f7f6;color:#34495e;margin:0;padding:20px}
      .container{background-color:#fff;padding:2em 3em;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.1);width:100%;max-width:1200px;margin:0 auto;text-align:center}
      .hidden{display:none}
      h1,h2,h3{font-family:'Patrick Hand',cursive;color:#2c3e50}
      h1{font-size:3.5em;margin-bottom:.2em;margin-top:0}
      h2{font-size:2.2em;color:#34495e;margin-top:0;border-bottom:2px solid #ecf0f1;padding-bottom:0.5em}
      h3{font-size:1.8em;margin-top:1.5em;margin-bottom:0.5em}
      
      /* --- Overview Styles --- */
      #overview-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:25px;margin-top:2em;text-align:left}
      .unit-overview-card{background-color:#fdfdfd;border:1px solid #e0e0e0;border-radius:10px;padding:20px;box-shadow:0 4px 8px rgba(0,0,0,0.05);transition:transform .2s,box-shadow .2s;cursor:pointer}
      .unit-overview-card:hover{transform:translateY(-5px);box-shadow:0 8px 16px rgba(0,0,0,0.1)}
      .unit-overview-card h3{margin-top:0}.proficiency-bar{display:flex;height:30px;border-radius:5px;overflow:hidden;margin-top:10px;border:1px solid #ccc}
      .bar-segment{display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.8em;white-space:nowrap;transition:width .5s ease}
      .bar-developing{background-color:#E74C3C}
      .bar-proficient{background-color:#F39C12}
      .bar-mastered{background-color:#2ECC71}
      
      /* --- Unit Detail Styles --- */
      #unit-detail-screen { text-align: left; }
      #back-to-overview-btn{background-color:#6c757d;color:#fff;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-family:'Nunito';font-weight:700;margin-bottom:1.5em}
      #unit-detail-table{width:100%;border-collapse:collapse;margin-top:1em}
      #unit-detail-table th,#unit-detail-table td{padding:12px 15px;border:1px solid #ddd;text-align:left}
      #unit-detail-table th{background-color:#34495e;color:#fff;font-family:'Nunito'}
      #unit-detail-table tr:nth-child(even){background-color:#f8f9fa}
      .score-mastered{color:#2ECC71;font-weight:bold}
      .score-proficient{color:#F39C12;font-weight:bold}
      .score-developing{color:#E74C3C;font-weight:bold}
      .score-unattempted{color:#95a5a6;font-style:italic}
      
      .loading-indicator{padding:40px;text-align:center}
      .spinner{border:8px solid #f3f3f3;border-radius:50%;border-top:8px solid #3498db;width:60px;height:60px;animation:spin 1s linear infinite;margin:0 auto 20px}
      @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="container">
        <h1>Teacher Dashboard</h1>
        <h2 id="class-title"></h2>

        <!-- Main overview screen -->
        <div id="overview-screen">
            <div id="loading-indicator-overview" class="loading-indicator">
                <div class="spinner"></div>
                <p>Loading class overview...</p>
            </div>
            <div id="overview-grid"></div>
        </div>

        <!-- Detailed drill-down screen for a single unit -->
        <div id="unit-detail-screen" class="hidden">
            <button id="back-to-overview-btn">‚Üê Back to Overview</button>
            <h3 id="unit-detail-title"></h3>
            <div id="loading-indicator-detail" class="loading-indicator hidden">
                <div class="spinner"></div>
                <p>Loading unit details...</p>
            </div>
            <table id="unit-detail-table">
                <thead><tr><th>Student Name</th><th>Best Score</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div id="error-message" class="hidden"></div>
    </div>

    <script>
      const unitsOrder = ["Unit 1: Coming of Age","Unit 2: Personal Narrative","Unit 3: Novel Study","Unit 4: Short Story","Unit 5: Romeo and Juliet","Unit 5 (Enriched) Macbeth","Unit 6: Nonfiction","Unit 6 (Enriched) Frankenstein","Unit 7: Resilience","Unit 8: Annotated Bibliography & Documentary"];

      document.addEventListener('DOMContentLoaded', initializeDashboard);

      function initializeDashboard() {
        document.getElementById('back-to-overview-btn').onclick = showOverviewScreen;
        showOverviewScreen();
        google.script.run
          .withSuccessHandler(onOverviewLoaded)
          .withFailureHandler(onError)
          .getTeacherDashboardOverview();
      }

      function showScreen(screenId) {
          ['overview-screen', 'unit-detail-screen'].forEach(id => {
              document.getElementById(id).classList.add('hidden');
          });
          document.getElementById(screenId).classList.remove('hidden');
      }

      function showOverviewScreen() {
          showScreen('overview-screen');
      }

      function onOverviewLoaded(response) {
        document.getElementById('loading-indicator-overview').classList.add('hidden');
        if (!response.success) { onError(response); return; }

        const { teacherName, overview } = response;
        document.getElementById('class-title').textContent = `${teacherName}'s Class Overview`;
        
        const grid = document.getElementById('overview-grid');
        grid.innerHTML = '';

        if (Object.keys(overview).length === 0) {
            grid.innerHTML = '<p>No student data has been recorded yet.</p>';
            return;
        }

        // Sort units according to the predefined order
        const sortedUnitNames = Object.keys(overview).sort((a, b) => {
            return unitsOrder.indexOf(a) - unitsOrder.indexOf(b);
        });

        sortedUnitNames.forEach(unitName => {
            const stats = overview[unitName];
            const card = document.createElement('div');
            card.className = 'unit-overview-card';
            card.onclick = () => showUnitDetails(unitName);
            card.innerHTML = `
                <h3>${unitName}</h3>
                <p>${stats.total} student(s) have attempted this unit.</p>
                <div class="proficiency-bar">
                    <div class="bar-segment bar-developing" style="width: ${stats.developingPct}%" title="Developing: ${stats.developingPct}%"></div>
                    <div class="bar-segment bar-proficient" style="width: ${stats.proficientPct}%" title="Proficient: ${stats.proficientPct}%"></div>
                    <div class="bar-segment bar-mastered" style="width: ${stats.masteredPct}%" title="Mastered: ${stats.masteredPct}%"></div>
                </div>
            `;
            grid.appendChild(card);
        });
      }

      function showUnitDetails(unitName) {
          showScreen('unit-detail-screen');
          document.getElementById('loading-indicator-detail').classList.remove('hidden');
          document.getElementById('unit-detail-table').classList.add('hidden');
          document.getElementById('unit-detail-title').textContent = `Details for: ${unitName}`;

          google.script.run
              .withSuccessHandler(onUnitDetailsLoaded)
              .withFailureHandler(onError)
              .getUnitDetailsForTeacher(unitName);
      }

      function onUnitDetailsLoaded(response) {
          document.getElementById('loading-indicator-detail').classList.add('hidden');
          document.getElementById('unit-detail-table').classList.remove('hidden');
          if (!response.success) { onError(response); return; }

          const tbody = document.getElementById('unit-detail-table').getElementsByTagName('tbody')[0];
          tbody.innerHTML = '';
          
          if (!response.details || response.details.length === 0) {
              tbody.innerHTML = '<tr><td colspan="2">No data found for this unit.</td></tr>';
              return;
          }

          response.details.forEach(student => {
              let scoreCell = '<span class="score-unattempted">Not Attempted</span>';
              if (student.bestScore !== undefined && student.bestScore !== null) {
                  let scoreClass = 'developing';
                  if (student.bestScore >= 90) scoreClass = 'mastered';
                  else if (student.bestScore >= 70) scoreClass = 'proficient';
                  scoreCell = `<span class="score-${scoreClass}">${student.bestScore}%</span>`;
              }

              const row = tbody.insertRow();
              row.innerHTML = `<td>${student.studentName}</td><td>${scoreCell}</td>`;
          });
      }

      function onError(error) {
        document.getElementById('loading-indicator-overview').classList.add('hidden');
        document.getElementById('loading-indicator-detail').classList.add('hidden');
        const errorDiv = document.getElementById('error-message');
        errorDiv.innerHTML = `<h2>An Error Occurred</h2><p>${error.message || error.error}</p><button onclick="initializeDashboard()">Try Again</button>`;
        errorDiv.classList.remove('hidden');
      }
    </script>
</body>
</html>
