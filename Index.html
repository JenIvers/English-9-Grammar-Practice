<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
      body{font-family:'Nunito',sans-serif;background-color:#87CEEB;color:#34495e;margin:0;padding:20px;display:flex;justify-content:center;align-items:center;min-height:100vh}
      
.container{background-color:#fff;padding:2em 3em;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.15);width:100%;max-width:1200px;text-align:center;border:1px solid #f7f7f7}
      
.hidden{display:none}h1,h2,h3{font-family:'Patrick Hand',cursive;color:#2c3e50}h1{font-size:3.5em;margin-bottom:.2em;margin-top:0}h2{font-size:2em;color:#34495e;margin-top:0}h3{font-size:1.8em;margin-top:1.5em;margin-bottom:0.5em}

      /* Shared Unit Grid Styles */
      #unit-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:2em}
      .unit-button{display:block;text-decoration:none;color:#2c3e50;background-color:#f8f9fa;border-radius:8px;padding:20px;position:relative;overflow:visible;transition:transform .2s ease,box-shadow .2s ease;border:2px solid #dee2e6;cursor:pointer;text-align:center}
      .unit-button:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,.15);border-color:#adb5bd}
      .unit-title{font-family:'Patrick Hand',cursive;font-size:1.4em;margin-bottom:10px;font-weight:bold}
      .unit-progress{font-family:'Nunito',sans-serif;font-size:0.9em;color:#6c757d}

      /* Inline Unit Toggle Styles */
      .unit-toggle-wrapper{position:absolute;bottom:8px;right:8px;z-index:10}
      .unit-inline-toggle{position:relative;display:inline-block;width:32px;height:18px}
      .unit-inline-toggle input{opacity:0;width:0;height:0}
      .unit-inline-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.2s;border-radius:18px}
      .unit-inline-slider:before{position:absolute;content:"";height:14px;width:14px;left:2px;bottom:2px;background-color:white;transition:.2s;border-radius:50%}
      .unit-inline-toggle input:checked + .unit-inline-slider{background-color:#28a745}
      .unit-inline-toggle input:checked + .unit-inline-slider:before{transform:translateX(14px)}

      /* Quiz Interface Styles */
      #question-text{font-family:'Nunito',sans-serif;font-size:1.3em;margin:1em 0;min-height:60px}
      #answer-options{display:flex;flex-direction:column;gap:15px;margin:2em 0}
      .option-btn{font-family:'Nunito',sans-serif;font-size:1em;cursor:pointer;border:2px solid #ced4da;background-color:#fff;border-radius:8px;transition:all .2s ease;padding:15px;text-align:center}
      .option-btn:not([disabled]):hover{background-color:#e9ecef;border-color:#adb5bd}
      .option-btn.correct{background-color:#d1e7dd;border-color:#28a745;color:#0f5132}
      .option-btn.incorrect{background-color:#f8d7da;border-color:#dc3545;color:#842029}
      .option-btn:disabled{cursor:not-allowed;opacity:.8}
      #progress-container{text-align:right;color:#6c757d}
      #final-score{font-family:'Patrick Hand',cursive;font-size:2.5em;font-weight:700;margin:1em 0}
      #review-container{text-align:left;margin-top:2em;max-height:400px;overflow-y:auto;border-top:1px solid #ddd}
      .review-item{padding:15px;border-bottom:1px solid #ecf0f1}
      .review-question{font-weight:700}
      .review-answer-correct{color:#198754}
      .review-answer-incorrect{color:#dc3545;text-decoration:line-through}

      /* Teacher Modal Styles */
      .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5)}
      .modal.show{display:block}
      .modal-content{background-color:#fff;margin:10% auto;padding:30px;border-radius:15px;width:90%;max-width:500px;position:relative;box-shadow:0 10px 25px rgba(0,0,0,0.2)}
      .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer;position:absolute;right:15px;top:10px}
      .close:hover{color:#000}
      .teacher-actions{display:flex;flex-direction:column;gap:15px;margin-top:20px}
      .action-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;border:none;padding:15px 20px;border-radius:8px;cursor:pointer;font-size:1.1em;transition:all .2s ease;text-align:left}
      .action-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
      .practice-btn{background-color:#28a745}
      .results-btn{background-color:#007bff}
      .edit-btn{background-color:#6f42c1}


      /* Teacher Results Table */
      #teacher-results-table{width:100%;border-collapse:collapse;margin-top:1em}
      #teacher-results-table th,#teacher-results-table td{padding:12px 15px;border:1px solid #ddd;text-align:left}
      #teacher-results-table th{background-color:#34495e;color:#fff;font-family:'Nunito'}
      #teacher-results-table tr:nth-child(even){background-color:#f8f9fa}
      .score-mastered{color:#2ECC71;font-weight:bold}
      .score-proficient{color:#F39C12;font-weight:bold}
      .score-developing{color:#E74C3C;font-weight:bold}
      .score-unattempted{color:#95a5a6;font-style:italic}

      /* Exemplars Screen Styles */
      #exemplars-screen{text-align:center}
      .exemplar-container{background-color:#f8f9fa;border-radius:10px;padding:2em;margin:1em auto;max-width:800px;border:1px solid #dee2e6}
      .exemplar-header{text-align:center;margin-bottom:1.5em;position:relative}
      .exemplar-progress{color:#6c757d;font-size:0.9em;position:absolute;right:0;top:0}
      .exemplar-title{font-family:'Patrick Hand',cursive;font-size:1.8em;color:#2c3e50;margin-bottom:0.5em;text-align:center}
      .exemplar-subtitle{font-family:'Patrick Hand',cursive;font-size:1.2em;color:#6c757d;margin-bottom:1em;line-height:1.4;text-align:center}
      .exemplar-content{background-color:#fff;padding:1.5em;border-radius:8px;margin-bottom:1.5em;text-align:left;font-size:1.5em;line-height:1.6;border:1px solid #e9ecef;font-weight:500}
      .exemplar-explanation{background-color:#e3f2fd;padding:1.5em;border-radius:8px;text-align:left;font-size:1.2em;line-height:1.5;border-left:4px solid #2196f3}
      .exemplar-explanation h4{margin-top:0;color:#1565c0;font-family:'Nunito',sans-serif}
      .exemplar-buttons{display:flex;gap:15px;justify-content:center;margin-top:2em}
      .got-it-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;background-color:#28a745;border:none;padding:15px 30px;border-radius:50px;cursor:pointer;font-size:1.1em;transition:all .2s ease;box-shadow:0 2px 5px rgba(0,0,0,.1)}
      .got-it-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
      .exemplar-nav-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;background-color:#6c757d;border:none;padding:15px 30px;border-radius:50px;cursor:pointer;transition:all .2s ease;box-shadow:0 2px 5px rgba(0,0,0,.1)}
      .exemplar-nav-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
      .exemplar-help-btn{font-family:'Nunito',sans-serif;font-weight:600;color:#007bff;background-color:#fff;border:2px solid #007bff;padding:8px 16px;border-radius:20px;cursor:pointer;transition:all .2s ease;margin-top:1em}
      .exemplar-help-btn:hover{background-color:#007bff;color:#fff}
      .exemplar-edit-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;background-color:#6f42c1;border:none;padding:15px 30px;border-radius:50px;cursor:pointer;font-size:1.1em;transition:all .2s ease;box-shadow:0 2px 5px rgba(0,0,0,.1)}
      .exemplar-edit-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15);background-color:#5a2d91}

      /* Student Choice Screen Styles */
      #student-choice-screen{text-align:center}
      .choice-container{background-color:#fff;padding:2em 3em;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.15);width:100%;max-width:600px;margin:0 auto;border:1px solid #f7f7f7}
      .choice-buttons{display:flex;flex-direction:column;gap:20px;margin:2em 0}
      .choice-btn{font-family:'Nunito',sans-serif;font-weight:700;border:none;padding:25px 30px;border-radius:15px;cursor:pointer;font-size:1.2em;transition:all .3s ease;box-shadow:0 4px 10px rgba(0,0,0,.1);text-align:center;display:flex;flex-direction:column;align-items:center;gap:8px}
      .choice-btn:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.15)}
      .exemplars-choice{background-color:#e3f2fd;color:#1565c0;border:2px solid #2196f3}
      .exemplars-choice:hover{background-color:#bbdefb;border-color:#1976d2}
      .practice-choice{background-color:#e8f5e8;color:#2e7d32;border:2px solid #4caf50}
      .practice-choice:hover{background-color:#c8e6c9;border-color:#388e3c}
      .choice-description{font-size:0.9em;font-weight:400;opacity:0.8;font-style:italic}

      /* Teacher View Banner Styles */
      .teacher-banner{position:fixed;bottom:0;left:0;right:0;background-color:#dc3545;color:white;padding:10px 20px;text-align:center;font-family:'Nunito',sans-serif;font-weight:600;z-index:1000;box-shadow:0 -2px 10px rgba(0,0,0,0.2)}
      .teacher-banner button{background-color:white;color:#dc3545;border:none;padding:8px 16px;border-radius:20px;font-weight:600;cursor:pointer;margin-left:15px;transition:all .2s ease}
      .teacher-banner button:hover{background-color:#f8f9fa;transform:translateY(-1px)}

      /* Learning Portfolio Styles */
      #learning-portfolio-screen{text-align:center}
      #portfolio-unit-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:2em}
      .portfolio-unit-button{display:block;text-decoration:none;color:#2c3e50;background-color:#f8f9fa;border-radius:8px;padding:20px;position:relative;overflow:visible;transition:transform .2s ease,box-shadow .2s ease;border:2px solid #dee2e6;cursor:pointer;text-align:center}
      .portfolio-unit-button:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,.15);border-color:#adb5bd}
      .portfolio-unit-title{font-family:'Patrick Hand',cursive;font-size:1.4em;margin-bottom:10px;font-weight:bold}
      .portfolio-unit-status{font-family:'Nunito',sans-serif;font-size:0.9em;color:#6c757d}
      
      /* Unit Portfolio Screen Styles */
      #unit-portfolio-screen{text-align:center}
      .learning-target-item{background-color:#f8f9fa;border-radius:10px;padding:1.5em;margin:1em 0;border:1px solid #dee2e6;text-align:left}
      .target-title{font-family:'Patrick Hand',cursive;font-size:1.3em;color:#2c3e50;margin-bottom:0.5em}
      .target-description{font-family:'Nunito',sans-serif;font-size:1em;color:#495057;margin-bottom:1em;line-height:1.4}
      .proficiency-selector{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
      .proficiency-selector label{font-family:'Nunito',sans-serif;font-weight:600;margin-right:15px;color:#495057}
      .proficiency-option{display:flex;align-items:center;margin-right:20px;cursor:pointer}
      .proficiency-option input[type="radio"]{margin-right:8px;transform:scale(1.2)}
      .proficiency-option span{font-family:'Nunito',sans-serif;font-size:0.9em;padding:4px 12px;border-radius:15px;transition:all .2s ease}
      .proficiency-not-started{background-color:#e9ecef;color:#6c757d}
      .proficiency-developing{background-color:#fff3cd;color:#856404}
      .proficiency-proficient{background-color:#d1ecf1;color:#0c5460}
      .proficiency-mastered{background-color:#d1e7dd;color:#0f5132}
      
      /* Portfolio Toggle Styles */
      .portfolio-toggle-wrapper{position:absolute;bottom:8px;right:8px;z-index:10}
      .portfolio-inline-toggle{position:relative;display:inline-block;width:32px;height:18px}
      .portfolio-inline-toggle input{opacity:0;width:0;height:0}
      .portfolio-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.2s;border-radius:18px}
      .portfolio-slider:before{position:absolute;content:"";height:14px;width:14px;left:2px;bottom:2px;background-color:white;transition:.2s;border-radius:50%}
      .portfolio-inline-toggle input:checked + .portfolio-slider{background-color:#28a745}
      .portfolio-inline-toggle input:checked + .portfolio-slider:before{transform:translateX(14px)}

      /* Three-Phase Proficiency Styles */
      .proficiency-phases-container{display:flex;flex-direction:column;gap:30px;margin-top:20px}
      .proficiency-phase-section{background-color:#f8f9fa;border-radius:15px;padding:25px;border:2px solid #dee2e6;position:relative}
      .phase-header{text-align:center;margin-bottom:20px;position:relative}
      .phase-title{font-family:'Patrick Hand',cursive;font-size:2em;color:#2c3e50;margin:0;text-shadow:1px 1px 2px rgba(0,0,0,0.1)}
      .phase-subtitle{font-family:'Nunito',sans-serif;font-size:1em;color:#6c757d;margin-top:5px;font-style:italic}
      .phase-beginning{border-color:#ffc107;background-color:#fff8e1}
      .phase-beginning .phase-title{color:#f57c00}
      .phase-middle{border-color:#17a2b8;background-color:#e3f2fd}
      .phase-middle .phase-title{color:#0277bd}
      .phase-end{border-color:#28a745;background-color:#e8f5e8}
      .phase-end .phase-title{color:#2e7d32}
      .phase-targets-grid{display:grid;gap:15px}
      .phase-learning-target{background-color:#fff;border-radius:10px;padding:15px;border:1px solid #e0e0e0;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
      .phase-target-title{font-family:'Patrick Hand',cursive;font-size:1.2em;color:#2c3e50;margin-bottom:8px;font-weight:bold}
      .phase-target-description{font-family:'Nunito',sans-serif;font-size:0.95em;color:#495057;margin-bottom:12px;line-height:1.4}
      .phase-proficiency-selector{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
      .phase-proficiency-selector select{font-family:'Nunito',sans-serif;padding:8px 12px;border:2px solid #dee2e6;border-radius:8px;background-color:#fff;color:#495057;font-size:0.9em;cursor:pointer;transition:all .2s ease;min-width:140px}
      .phase-proficiency-selector select:focus{outline:none;border-color:#007bff;box-shadow:0 0 5px rgba(0,123,255,0.3)}
      .phase-proficiency-selector select option{padding:5px}
      .phase-save-indicator{position:absolute;top:15px;right:15px;font-size:0.8em;color:#28a745;opacity:0;transition:opacity .3s ease}
      .phase-save-indicator.visible{opacity:1}

      /* Unit 1 Grid Table Styles */
      .unit1-proficiency-table {
        font-family: 'Nunito', sans-serif;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      .unit1-proficiency-table .target-row {
        transition: background-color 0.2s ease;
      }
      .unit1-proficiency-table .target-row:hover {
        background-color: #f8f9fa;
      }
      .unit1-proficiency-table .target-name {
        padding: 15px;
        border: 1px solid #dee2e6;
        vertical-align: top;
        background-color: #fff;
        min-width: 200px;
      }
      .unit1-proficiency-table .target-title {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.1em;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
      }
      .unit1-proficiency-table .phase-cell {
        padding: 15px;
        border: 1px solid #dee2e6;
        text-align: center;
        vertical-align: middle;
        width: 150px;
      }
      .unit1-proficiency-table select {
        font-family: 'Nunito', sans-serif;
        font-size: 0.9em;
      }

      /* Independent Reading Button Hover */
      #independent-reading-btn:hover {
        background-color: #e1bee7 !important;
        border-color: #8e24aa !important;
      }

      /* Independent Reading Styles */
      .ir-semester-section {
        background-color: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        border: 2px solid #dee2e6;
      }
      .ir-semester-title {
        font-family: 'Patrick Hand', cursive;
        font-size: 2em;
        color: #2c3e50;
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #7b1fa2;
        padding-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }
      .ir-semester-title:hover {
        color: #7b1fa2;
      }
      .ir-semester-title::after {
        content: '‚ñº';
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        transition: transform 0.3s ease;
        font-size: 0.7em;
      }
      .ir-semester-title.collapsed::after {
        transform: translateY(-50%) rotate(-90deg);
      }
      .ir-semester-content {
        transition: all 0.3s ease;
        max-height: 2000px;
        overflow: hidden;
      }
      .ir-semester-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        margin-top: 0;
        margin-bottom: 0;
      }
      .ir-book-info {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
      }
      .ir-reflections h4 {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.5em;
        color: #2c3e50;
        margin-bottom: 15px;
        text-align: center;
      }
      .ir-reflection-item {
        background-color: #fff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .ir-reflection-item h5 {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.3em;
        color: #7b1fa2;
        margin-bottom: 15px;
        text-align: center;
      }
      .ir-reflection-fields {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }
      .ir-reflection-fields .form-group {
        margin-bottom: 0;
      }
      .save-reflection-btn {
        font-family: 'Nunito', sans-serif;
        font-weight: 700;
        color: #fff;
        background-color: #7b1fa2;
        border: none;
        padding: 12px 24px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all .2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,.1);
        display: block;
        margin: 15px auto 0;
      }
      .save-reflection-btn:hover {
        background-color: #6a1b9a;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,.15);
      }
      .save-reflection-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
      }
      
      /* Teacher IR View Styles */
      .teacher-ir-student {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
      }
      .teacher-ir-student-name {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.4em;
        color: #2c3e50;
        margin-bottom: 10px;
      }
      .teacher-ir-book {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #7b1fa2;
      }
      .teacher-ir-book-title {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
      }
      .teacher-ir-reflection {
        background-color: #f0f8ff;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        font-size: 0.9em;
      }
      .teacher-ir-reflection-header {
        font-weight: bold;
        color: #7b1fa2;
        margin-bottom: 5px;
      }
      
      /* Teacher Dashboard Styles */
      .ir-teacher-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }
      .ir-view-toggle {
        font-family: 'Nunito', sans-serif;
        font-weight: 600;
        color: #fff;
        background-color: #6c757d;
        border: none;
        padding: 12px 24px;
        border-radius: 50px;
        cursor: pointer;
        transition: all .2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,.1);
      }
      .ir-view-toggle.active {
        background-color: #7b1fa2;
      }
      .ir-view-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,.15);
      }
      .ir-dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .ir-stat-card {
        background-color: #fff;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .ir-stat-number {
        font-family: 'Patrick Hand', cursive;
        font-size: 3em;
        color: #7b1fa2;
        margin: 0;
      }
      .ir-stat-label {
        font-family: 'Nunito', sans-serif;
        color: #6c757d;
        margin-top: 5px;
      }
      .ir-student-table {
        background-color: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .ir-student-table table {
        width: 100%;
        border-collapse: collapse;
      }
      .ir-student-table th {
        background-color: #7b1fa2;
        color: #fff;
        padding: 15px;
        font-family: 'Nunito', sans-serif;
        font-weight: 600;
        text-align: left;
      }
      .ir-student-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #dee2e6;
        font-family: 'Nunito', sans-serif;
      }
      .ir-student-table tr:hover {
        background-color: #f8f9fa;
      }
      .ir-progress-bar {
        background-color: #e9ecef;
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
        position: relative;
      }
      .ir-progress-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 0.8em;
        font-weight: bold;
      }
      .ir-progress-semester1 {
        background-color: #28a745;
      }
      .ir-progress-semester2 {
        background-color: #007bff;
      }
      .ir-status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
        color: #fff;
      }
      .ir-status-not-started {
        background-color: #6c757d;
      }
      .ir-status-in-progress {
        background-color: #ffc107;
        color: #212529;
      }
      .ir-status-completed {
        background-color: #28a745;
      }

      /* Button Styles */
      #try-again-btn,#main-menu-btn,#back-to-home-btn,#register-btn,#back-to-units-btn,#back-to-units-from-results-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;border:none;padding:12px 24px;border-radius:50px;cursor:pointer;margin-top:10px;transition:all .2s ease;box-shadow:0 2px 5px rgba(0,0,0,.1)}
      #try-again-btn:hover,#main-menu-btn:hover,#back-to-home-btn:hover,#register-btn:hover,#back-to-units-btn:hover,#back-to-units-from-results-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
      #try-again-btn{background-color:#198754;margin-right:10px}
      #main-menu-btn,#back-to-home-btn,#back-to-units-btn,#back-to-units-from-results-btn{background-color:#6c757d}
      #register-btn{background-color:#0d6efd}

      /* Common Styles */
      .loading-indicator{padding:40px;text-align:center}
      .spinner{border:8px solid #f3f3f3;border-radius:50%;border-top:8px solid #3498db;width:60px;height:60px;animation:spin 1s linear infinite;margin:0 auto 20px}
      @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
      .form-group{margin-bottom:1.5em;text-align:left}.form-group label{display:block;margin-bottom:.5em;font-weight:700}.form-group input,.form-group select{width:100%;padding:10px;border-radius:5px;border:1px solid #ccc;font-size:1em;box-sizing: border-box;}
    </style>
  </head>
  <body>
    <div class="container">
      <h1>English 9 Learning Hub</h1>
      
      <!-- Main Landing Screen -->
      <div id="main-landing-screen">
        <h2 id="main-welcome-message">Welcome to English 9</h2>
        <div class="choice-container">
          <p>What would you like to do today?</p>
          <div class="choice-buttons">
            <button id="learning-portfolio-btn" class="choice-btn exemplars-choice">
              üìö Learning Portfolio
              <span class="choice-description">Track your progress and proficiency levels</span>
            </button>
            <button id="grammar-practice-btn" class="choice-btn practice-choice">
              üéØ Grammar Practice
              <span class="choice-description">Practice grammar concepts with interactive quizzes</span>
            </button>
            <button id="independent-reading-btn" class="choice-btn" style="background-color:#f3e5f5; color:#7b1fa2; border:2px solid #9c27b0;">
              üìñ Independent Reading
              <span class="choice-description">Track your independent reading progress</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Shared Unit Selection Screen -->
      <div id="unit-selection-screen" class="hidden">
        <h2 id="welcome-message">Choose a Unit to Practice</h2>
        <div id="unit-grid">Loading units...</div>
        <button id="back-to-main-btn" class="exemplar-nav-btn" style="margin-top: 20px;">‚Üê Back to Main Menu</button>
      </div>

      <!-- Learning Portfolio Screen -->
      <div id="learning-portfolio-screen" class="hidden">
        <h2 id="portfolio-welcome-message">Learning Portfolio</h2>
        <p>Track your learning progress and set proficiency goals for each unit.</p>
        
        <div id="portfolio-unit-grid">Loading portfolio...</div>
        <button id="back-to-main-from-portfolio-btn" class="exemplar-nav-btn" style="margin-top: 20px;">‚Üê Back to Main Menu</button>
      </div>

      <!-- Individual Unit Portfolio Screen -->
      <div id="unit-portfolio-screen" class="hidden">
        <h2 id="unit-portfolio-title">Unit Portfolio</h2>
        <div id="learning-targets-container">
          <div id="loading-targets" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading learning targets...</p>
          </div>
          <div id="targets-content"></div>
        </div>
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
          <button id="back-to-portfolio-btn" class="exemplar-nav-btn">‚Üê Back to Portfolio</button>
          <button id="save-portfolio-btn" class="got-it-btn">üíæ Save Progress</button>
        </div>
      </div>

      <!-- Independent Reading Screen -->
      <div id="independent-reading-screen" class="hidden">
        <h2>Independent Reading</h2>
        <p>Track your independent reading progress and reflections throughout the year.</p>
        
        <div id="independent-reading-content">
          <div id="loading-ir" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading independent reading data...</p>
          </div>
          
          <!-- Teacher Controls -->
          <div id="teacher-ir-controls" class="hidden ir-teacher-controls">
            <button id="ir-dashboard-btn" class="ir-view-toggle active">üìä Dashboard</button>
            <button id="ir-student-view-btn" class="ir-view-toggle">üë§ Student View</button>
          </div>
          
          <!-- Teacher Dashboard -->
          <div id="ir-dashboard-container" class="hidden">
            <div id="ir-dashboard-stats" class="ir-dashboard-stats">
              <!-- Stats cards will be populated by JavaScript -->
            </div>
            <div id="ir-student-progress-table" class="ir-student-table">
              <!-- Student progress table will be populated by JavaScript -->
            </div>
          </div>
          
          <!-- Semester Sections -->
          <div id="ir-semesters-container" class="hidden">
            <!-- Semester 1 -->
            <div class="ir-semester-section">
              <h3 class="ir-semester-title" onclick="toggleSemester('semester1')">Semester 1</h3>
              <div id="semester1-content" class="ir-semester-content">
                <div class="ir-book-info">
                <div class="form-group">
                  <label for="s1-book-title">Book Title:</label>
                  <input type="text" id="s1-book-title" placeholder="Enter the title of your book">
                </div>
                <div class="form-group">
                  <label for="s1-book-author">Author:</label>
                  <input type="text" id="s1-book-author" placeholder="Enter the author's name">
                </div>
              </div>
              
              <div class="ir-reflections">
                <h4>Reading Reflections</h4>
                <!-- Reflection 1 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 1</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s1-r1-date">Date:</label>
                      <input type="date" id="s1-r1-date">
                    </div>
                    <div class="form-group">
                      <label for="s1-r1-pages-read">Pages Read:</label>
                      <input type="number" id="s1-r1-pages-read" placeholder="150">
                    </div>
                    <div class="form-group">
                      <label for="s1-r1-total-pages">Total Pages:</label>
                      <input type="number" id="s1-r1-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s1-r1-text">Reflection:</label>
                    <textarea id="s1-r1-text" rows="4" placeholder="Write your thoughts about the book so far..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 1', 0)">üíæ Save Reflection 1</button>
                </div>
                
                <!-- Reflection 2 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 2</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s1-r2-date">Date:</label>
                      <input type="date" id="s1-r2-date">
                    </div>
                    <div class="form-group">
                      <label for="s1-r2-pages-read">Pages Read:</label>
                      <input type="number" id="s1-r2-pages-read" placeholder="250">
                    </div>
                    <div class="form-group">
                      <label for="s1-r2-total-pages">Total Pages:</label>
                      <input type="number" id="s1-r2-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s1-r2-text">Reflection:</label>
                    <textarea id="s1-r2-text" rows="4" placeholder="Write your thoughts about the book so far..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 1', 1)">üíæ Save Reflection 2</button>
                </div>
                
                <!-- Reflection 3 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 3</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s1-r3-date">Date:</label>
                      <input type="date" id="s1-r3-date">
                    </div>
                    <div class="form-group">
                      <label for="s1-r3-pages-read">Pages Read:</label>
                      <input type="number" id="s1-r3-pages-read" placeholder="300">
                    </div>
                    <div class="form-group">
                      <label for="s1-r3-total-pages">Total Pages:</label>
                      <input type="number" id="s1-r3-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s1-r3-text">Reflection:</label>
                    <textarea id="s1-r3-text" rows="4" placeholder="Write your final thoughts about the book..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 1', 2)">üíæ Save Reflection 3</button>
                </div>
              </div>
              </div>
            </div>
            
            <!-- Semester 2 -->
            <div class="ir-semester-section">
              <h3 class="ir-semester-title" onclick="toggleSemester('semester2')">Semester 2</h3>
              <div id="semester2-content" class="ir-semester-content">
                <div class="ir-book-info">
                <div class="form-group">
                  <label for="s2-book-title">Book Title:</label>
                  <input type="text" id="s2-book-title" placeholder="Enter the title of your book">
                </div>
                <div class="form-group">
                  <label for="s2-book-author">Author:</label>
                  <input type="text" id="s2-book-author" placeholder="Enter the author's name">
                </div>
              </div>
              
              <div class="ir-reflections">
                <h4>Reading Reflections</h4>
                <!-- Reflection 1 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 1</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s2-r1-date">Date:</label>
                      <input type="date" id="s2-r1-date">
                    </div>
                    <div class="form-group">
                      <label for="s2-r1-pages-read">Pages Read:</label>
                      <input type="number" id="s2-r1-pages-read" placeholder="150">
                    </div>
                    <div class="form-group">
                      <label for="s2-r1-total-pages">Total Pages:</label>
                      <input type="number" id="s2-r1-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s2-r1-text">Reflection:</label>
                    <textarea id="s2-r1-text" rows="4" placeholder="Write your thoughts about the book so far..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 2', 0)">üíæ Save Reflection 1</button>
                </div>
                
                <!-- Reflection 2 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 2</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s2-r2-date">Date:</label>
                      <input type="date" id="s2-r2-date">
                    </div>
                    <div class="form-group">
                      <label for="s2-r2-pages-read">Pages Read:</label>
                      <input type="number" id="s2-r2-pages-read" placeholder="250">
                    </div>
                    <div class="form-group">
                      <label for="s2-r2-total-pages">Total Pages:</label>
                      <input type="number" id="s2-r2-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s2-r2-text">Reflection:</label>
                    <textarea id="s2-r2-text" rows="4" placeholder="Write your thoughts about the book so far..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 2', 1)">üíæ Save Reflection 2</button>
                </div>
                
                <!-- Reflection 3 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 3</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s2-r3-date">Date:</label>
                      <input type="date" id="s2-r3-date">
                    </div>
                    <div class="form-group">
                      <label for="s2-r3-pages-read">Pages Read:</label>
                      <input type="number" id="s2-r3-pages-read" placeholder="300">
                    </div>
                    <div class="form-group">
                      <label for="s2-r3-total-pages">Total Pages:</label>
                      <input type="number" id="s2-r3-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s2-r3-text">Reflection:</label>
                    <textarea id="s2-r3-text" rows="4" placeholder="Write your final thoughts about the book..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 2', 2)">üíæ Save Reflection 3</button>
                </div>
              </div>
              </div>
            </div>
          </div>
        </div>
        
        <button id="back-to-main-from-reading-btn" class="exemplar-nav-btn" style="margin-top: 20px;">‚Üê Back to Main Menu</button>
      </div>
      
      <!-- Teacher Independent Reading View Screen -->
      <div id="teacher-ir-screen" class="hidden">
        <h2>All Student Independent Reading</h2>
        <div id="teacher-ir-content">
          <div id="loading-teacher-ir" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading student reading data...</p>
          </div>
          <div id="teacher-ir-data"></div>
        </div>
        <button id="back-to-ir-from-teacher-btn" class="exemplar-nav-btn" style="margin-top: 20px;">‚Üê Back to Independent Reading</button>
      </div>

      <!-- Student Registration Screen -->
      <div id="registration-screen" class="hidden">
        <h2>Welcome! Let's get you set up.</h2>
        <p>Since this is your first time here, please enter your full name and select your teacher.</p>
        <div class="form-group">
            <label for="student-name">Full Name</label>
            <input type="text" id="student-name" placeholder="e.g., Jane Doe">
        </div>
        <div class="form-group">
            <label for="teacher-select">Teacher</label>
            <select id="teacher-select">
                <option value="">-- Please Select --</option>
            </select>
        </div>
        <button id="register-btn">Complete Registration</button>
        <button id="back-to-units-btn">Back to Units</button>
      </div>

      <!-- Student Choice Screen -->
      <div id="student-choice-screen" class="hidden">
        <h2 id="choice-unit-title">Unit Title</h2>
        <div class="choice-container">
          <p>How would you like to approach this unit?</p>
          <div class="choice-buttons">
            <button id="learn-exemplars-btn" class="choice-btn exemplars-choice">
              üìñ Learn with exemplars
              <span class="choice-description">View examples and explanations first</span>
            </button>
            <button id="begin-practice-btn" class="choice-btn practice-choice">
              üéØ Begin practice
              <span class="choice-description">Start with questions immediately</span>
            </button>
          </div>
          <button id="back-from-choice-btn" class="exemplar-nav-btn">‚Üê Back to Units</button>
        </div>
        <div id="choice-teacher-banner"></div>
      </div>

      <!-- Exemplars Screen -->
      <div id="exemplars-screen" class="hidden">
        <h2 id="exemplars-unit-title">Unit Exemplars</h2>
        <div class="exemplar-container">
          <div class="exemplar-header">
            <h3 id="exemplar-title">Exemplar Title</h3>
            <div class="exemplar-progress" id="exemplar-progress">1 of 3</div>
          </div>
          <div id="exemplar-content" class="exemplar-content">
            <!-- Exemplar content will be loaded here -->
          </div>
          <div id="exemplar-explanation" class="exemplar-explanation">
            <h4>Why this works:</h4>
            <div id="exemplar-explanation-text">
              <!-- Explanation will be loaded here -->
            </div>
          </div>
          <div class="exemplar-buttons">
            <button id="exemplar-back-btn" class="exemplar-nav-btn">‚Üê Back to Units</button>
            <button id="got-it-btn" class="got-it-btn">I've got it!</button>
          </div>
        </div>
        <div id="exemplar-teacher-banner"></div>
      </div>

      <!-- Quiz Screen -->
      <div id="quiz-screen" class="hidden"></div>
      
      <!-- Results Screen -->
      <div id="results-screen" class="hidden">
        <div id="results-teacher-banner"></div>
      </div>

      <!-- Teacher Action Modal -->
      <div id="teacher-modal" class="modal hidden">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h3 id="modal-unit-title"></h3>
          <div class="teacher-actions">
            <button id="practice-as-student-btn" class="action-btn practice-btn">
              üìù View practice as student
            </button>
            <button id="view-results-btn" class="action-btn results-btn">
              üìä View results as teacher
            </button>
            <button id="teach-with-exemplars-btn" class="action-btn" style="background-color:#17a2b8">
              üìñ Teach with exemplars
            </button>
            <button id="edit-questions-btn" class="action-btn edit-btn">
              ‚úèÔ∏è Edit questions
            </button>
          </div>
        </div>
      </div>

      <!-- Teacher Results Screen -->
      <div id="teacher-results-screen" class="hidden">
        <button id="back-to-units-from-results-btn">‚Üê Back to Units</button>
        <h3 id="teacher-results-title"></h3>
        <div id="loading-indicator-teacher" class="loading-indicator hidden">
          <div class="spinner"></div>
          <p>Loading results...</p>
        </div>
        <table id="teacher-results-table">
          <thead><tr><th>Student Name</th><th>Best Score</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Loading/Error -->
      <div id="loading-indicator" class="hidden">
        <div class="spinner"></div>
        <p>Loading...</p>
      </div>
      <div id="error-message" class="hidden"></div>
    </div>

    <script>
      // Global variables
      let allQuestions = [], currentQuestionIndex = 0, score = 0, userAnswers = [], currentUnit = '';
      let userInfo = {};
      let isTeacher = false;
      let isTeacherViewingAsStudent = false; // Track if teacher is in student view mode
      let availableUnits = []; // This will be populated based on user type and teacher settings
      let teacherUnitSettings = {}; // Store teacher's unit enable/disable settings
      
      // Exemplar variables
      let allExemplars = [], currentExemplarIndex = 0;
      
      // Learning Portfolio variables
      let portfolioUnits = []; // Units available in portfolio
      let portfolioUnitSettings = {}; // Store portfolio unit enable/disable settings for teachers
      let currentPortfolioUnit = '';
      let learningTargetsData = [];
      let studentProficiencyData = {};
      
      document.addEventListener('DOMContentLoaded', initializeApp);

      function initializeApp() {
        showScreen('loading-indicator');
        google.script.run.withSuccessHandler(onAppDataLoaded).withFailureHandler(onLoadError).getRoleAndUserInfo();
      }

      function onAppDataLoaded(response) {
        hideScreen('loading-indicator');
        
        if (response.error) {
          onLoadError({ message: response.error });
          return;
        }
        
        userInfo = response;
        isTeacher = response.isTeacher;
        
        // Set available units based on user type
        if (isTeacher) {
          // Teachers see all units
          availableUnits = ["Unit 1: Coming of Age", "Unit 2: Personal Narrative", "Unit 3: Novel Study", "Unit 4: Short Story", "Unit 5: Romeo and Juliet", "Unit 5 (Enriched) Macbeth", "Unit 6: Nonfiction", "Unit 6 (Enriched) Frankenstein", "Unit 7: Resilience", "Unit 8: Annotated Bibliography & Documentary"];
        } else if (response.isRegistered && response.enabledUnits) {
          // Registered students see only their teacher's enabled units
          availableUnits = response.enabledUnits;
        } else {
          // Unregistered students see all units
          availableUnits = ["Unit 1: Coming of Age", "Unit 2: Personal Narrative", "Unit 3: Novel Study", "Unit 4: Short Story", "Unit 5: Romeo and Juliet", "Unit 5 (Enriched) Macbeth", "Unit 6: Nonfiction", "Unit 6 (Enriched) Frankenstein", "Unit 7: Resilience", "Unit 8: Annotated Bibliography & Documentary"];
        }
        
        // Update welcome messages based on user type
        if (isTeacher) {
          document.getElementById('main-welcome-message').textContent = `Welcome, ${userInfo.teacherName}!`;
          document.getElementById('welcome-message').textContent = `Welcome, ${userInfo.teacherName}! Choose a Unit`;
          document.getElementById('portfolio-welcome-message').textContent = `${userInfo.teacherName}'s Learning Portfolio`;
        } else if (response.isRegistered) {
          document.getElementById('main-welcome-message').textContent = `Welcome, ${userInfo.name}!`;
          document.getElementById('welcome-message').textContent = `Welcome, ${userInfo.name}! Choose a Unit to Practice`;
          document.getElementById('portfolio-welcome-message').textContent = `${userInfo.name}'s Learning Portfolio`;
        } else {
          document.getElementById('main-welcome-message').textContent = `Welcome to English 9`;
          document.getElementById('welcome-message').textContent = `Choose a Unit to Practice`;
          document.getElementById('portfolio-welcome-message').textContent = `Learning Portfolio`;
        }
        
        // Set up main landing page button handlers
        setupMainLandingHandlers();
        
        // Show main landing page
        showScreen('main-landing-screen');
      }

      function setupMainLandingHandlers() {
        document.getElementById('grammar-practice-btn').onclick = () => {
          loadUnitsForSharedView();
        };
        
        document.getElementById('learning-portfolio-btn').onclick = () => {
          showLearningPortfolio();
        };
        
        document.getElementById('independent-reading-btn').onclick = () => {
          showIndependentReading();
        };
      }

      function loadUnitsForSharedView() {
        const container = document.getElementById('unit-grid');
        container.innerHTML = '';
        
        if (isTeacher) {
          // For teachers, load unit settings first, then display
          loadTeacherUnitSettings();
        } else if (userInfo.isRegistered) {
          // For students, load progress data
          google.script.run.withSuccessHandler(displayUnitsWithProgress).withFailureHandler(onLoadError).getStudentProgress();
        } else {
          // For unregistered students, show simple unit buttons
          displayUnitsWithProgress({ success: true, progress: {} });
        }
      }

      function loadTeacherUnitSettings() {
        google.script.run
          .withSuccessHandler(onTeacherUnitSettingsLoaded)
          .withFailureHandler(onLoadError)
          .getTeacherUnitSettings();
      }

      function onTeacherUnitSettingsLoaded(response) {
        if (!response.success) {
          onLoadError({ message: response.error });
          return;
        }
        
        teacherUnitSettings = response.settings;
        // Now display units with toggle controls
        displayUnitsWithProgress({ success: true, progress: {} });
      }

      function displayUnitsWithProgress(progressResponse) {
        const container = document.getElementById('unit-grid');
        container.innerHTML = '';
        
        const progressData = progressResponse.progress || {};
        
        availableUnits.forEach(unit => {
          const bestScore = progressData[unit] || 0;
          let progressText = isTeacher ? 'Click to select action' : 'Not attempted';
          
          if (!isTeacher && bestScore > 0) {
            if (bestScore >= 90) progressText = `Mastered (${bestScore}%)`;
            else if (bestScore >= 70) progressText = `Proficient (${bestScore}%)`;
            else progressText = `Developing (${bestScore}%)`;
          }
          
          const button = document.createElement('div');
          button.className = 'unit-button';
          button.onclick = (e) => handleUnitClick(unit, e);
          
          let toggleHTML = '';
          if (isTeacher) {
            const isEnabled = teacherUnitSettings[unit] !== false; // Default to true if not set
            
            toggleHTML = `
              <div class="unit-toggle-wrapper" onclick="event.stopPropagation()">
                <label class="unit-inline-toggle">
                  <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="handleInlineUnitToggle('${unit}', this.checked, this)">
                  <span class="unit-inline-slider"></span>
                </label>
              </div>
            `;
          }
          
          button.innerHTML = `
            ${toggleHTML}
            <div class="unit-title">${unit}</div>
            <div class="unit-progress">${progressText}</div>
          `;
          container.appendChild(button);
        });
        
        // Set up back to main button
        document.getElementById('back-to-main-btn').onclick = () => {
          showScreen('main-landing-screen');
        };
        
        showScreen('unit-selection-screen');
      }

      function handleUnitClick(unitName, event) {
        // Prevent click if it's from the toggle area
        if (event && event.target.closest('.unit-toggle-wrapper')) {
          return;
        }
        
        currentUnit = unitName;
        
        if (isTeacher) {
          showTeacherModal(unitName);
        } else {
          // For students - check if registered, then show choice screen
          if (userInfo.isRegistered) {
            showStudentChoiceScreen(unitName);
          } else {
            // Show registration screen first
            populateTeacherDropdown(userInfo.teachers);
            showScreen('registration-screen');
            document.getElementById('register-btn').onclick = submitRegistration;
            document.getElementById('back-to-units-btn').onclick = () => showScreen('main-landing-screen');
          }
        }
      }

      // Inline Unit Toggle Handler
      function handleInlineUnitToggle(unitName, isEnabled, toggleElement) {
        // Update local settings immediately for UI responsiveness
        teacherUnitSettings[unitName] = isEnabled;
        
        // Save to backend
        google.script.run
          .withSuccessHandler(() => {
            // Success - settings already updated locally
            console.log(`Unit ${unitName} ${isEnabled ? 'enabled' : 'disabled'}`);
          })
          .withFailureHandler((error) => {
            // Revert on error
            teacherUnitSettings[unitName] = !isEnabled;
            toggleElement.checked = !isEnabled;
            onLoadError({ message: error.message });
          })
          .updateTeacherUnitSettings(unitName, isEnabled);
      }

      // Teacher Modal Functions
      function showTeacherModal(unitName) {
        document.getElementById('modal-unit-title').textContent = unitName;
        document.getElementById('teacher-modal').classList.add('show');
        
        // Set up modal event handlers
        document.querySelector('.close').onclick = closeTeacherModal;
        document.getElementById('practice-as-student-btn').onclick = () => {
          closeTeacherModal();
          enterStudentView(unitName);
        };
        document.getElementById('view-results-btn').onclick = () => {
          closeTeacherModal();
          showTeacherResults(unitName);
        };
        document.getElementById('teach-with-exemplars-btn').onclick = () => {
          closeTeacherModal();
          startExemplars(unitName);
        };
        document.getElementById('edit-questions-btn').onclick = () => {
          closeTeacherModal();
          alert('Question editing feature coming soon!');
        };
        
        // Close modal when clicking outside
        window.onclick = (event) => {
          if (event.target.classList.contains('modal')) {
            closeTeacherModal();
          }
        };
      }

      function closeTeacherModal() {
        document.getElementById('teacher-modal').classList.remove('show');
      }


      function showTeacherResults(unitName) {
        document.getElementById('teacher-results-title').textContent = `Results for: ${unitName}`;
        document.getElementById('loading-indicator-teacher').classList.remove('hidden');
        document.getElementById('teacher-results-table').classList.add('hidden');
        showScreen('teacher-results-screen');
        
        document.getElementById('back-to-units-from-results-btn').onclick = () => showScreen('unit-selection-screen');
        
        google.script.run
          .withSuccessHandler(onTeacherResultsLoaded)
          .withFailureHandler(onLoadError)
          .getUnitDetailsForTeacher(unitName);
      }

      function onTeacherResultsLoaded(response) {
        document.getElementById('loading-indicator-teacher').classList.add('hidden');
        document.getElementById('teacher-results-table').classList.remove('hidden');
        
        if (!response.success) {
          onLoadError({ message: response.error });
          return;
        }

        const tbody = document.getElementById('teacher-results-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        
        if (!response.details || response.details.length === 0) {
          tbody.innerHTML = '<tr><td colspan="2">No data found for this unit.</td></tr>';
          return;
        }

        response.details.forEach(student => {
          let scoreCell = '<span class="score-unattempted">Not Attempted</span>';
          if (student.bestScore !== undefined && student.bestScore !== null) {
            let scoreClass = 'developing';
            if (student.bestScore >= 90) scoreClass = 'mastered';
            else if (student.bestScore >= 70) scoreClass = 'proficient';
            scoreCell = `<span class="score-${scoreClass}">${student.bestScore}%</span>`;
          }

          const row = tbody.insertRow();
          row.innerHTML = `<td>${student.studentName}</td><td>${scoreCell}</td>`;
        });
      }

      // Student Registration Functions
      function populateTeacherDropdown(teachers) {
        const select = document.getElementById('teacher-select');
        select.innerHTML = '<option value="">-- Please Select --</option>';
        teachers.forEach(teacher => {
          const option = document.createElement('option');
          option.value = teacher;
          option.textContent = teacher;
          select.appendChild(option);
        });
      }

      function submitRegistration() {
        const name = document.getElementById('student-name').value.trim();
        const teacher = document.getElementById('teacher-select').value;
        if (!name || !teacher) {
          alert('Please enter your full name and select a teacher.');
          return;
        }
        
        showScreen('loading-indicator');
        const studentData = { name: name, teacher: teacher };
        google.script.run
          .withSuccessHandler(onRegistrationSuccess)
          .withFailureHandler(onLoadError)
          .registerStudent(studentData);
      }

      function onRegistrationSuccess(response) {
        if (!response || !response.success) {
          onLoadError({ message: response.error || 'Registration failed unexpectedly.' });
          return;
        }
        
        // Update user info and restart app
        userInfo.isRegistered = true;
        userInfo.name = response.name;
        userInfo.teacher = response.teacher;
        
        // Start the quiz they originally clicked on
        showStudentChoiceScreen(currentUnit);
      }

      // Student Choice Screen Functions
      function showStudentChoiceScreen(unitName) {
        currentUnit = unitName;
        document.getElementById('choice-unit-title').textContent = unitName;
        
        // Add teacher banner if in teacher view mode
        document.getElementById('choice-teacher-banner').innerHTML = addTeacherBanner();
        
        showScreen('student-choice-screen');
        
        // Set up button handlers
        document.getElementById('learn-exemplars-btn').onclick = () => {
          startExemplars(unitName);
        };
        
        document.getElementById('begin-practice-btn').onclick = () => {
          startQuiz(unitName);
        };
        
        document.getElementById('back-from-choice-btn').onclick = () => {
          if (isTeacherViewingAsStudent) {
            returnToTeacherView();
          } else {
            showScreen('unit-selection-screen');
          }
        };
      }

      // Exemplar Functions

      function startExemplars(unitName) {
        currentUnit = unitName;
        showScreen('loading-indicator');
        google.script.run
          .withSuccessHandler(onExemplarsLoaded)
          .withFailureHandler(onLoadError)
          .getExemplarsForUnit(unitName);
      }

      function onExemplarsLoaded(response) {
        // Log debug information
        if (response.debugInfo) {
          console.log('[onExemplarsLoaded] Debug info:', response.debugInfo);
        }
        
        if (!response.success) {
          let errorMessage = response.error || 'Failed to load exemplars';
          
          // Show detailed error information if available
          if (response.debugInfo && response.debugInfo.missingColumns) {
            errorMessage = response.error; // Use the full detailed error message
            console.error('[Exemplars Error] Detailed debug info:', response.debugInfo);
          }
          
          onLoadError({ message: errorMessage });
          return;
        }

        allExemplars = response.exemplars || [];
        
        currentExemplarIndex = 0;
        document.getElementById('exemplars-unit-title').textContent = `${currentUnit} - Exemplars`;
        
        // Add teacher banner
        document.getElementById('exemplar-teacher-banner').innerHTML = addTeacherBanner();
        
        showScreen('exemplars-screen');
        
        if (allExemplars.length === 0) {
          // No exemplars found, show empty state with debug info
          displayEmptyExemplarState(response.debugInfo);
        } else {
          displayExemplar();
        }
      }

      function displayEmptyExemplarState(debugInfo) {
        document.getElementById('exemplar-title').textContent = 'No Exemplars Available';
        document.getElementById('exemplar-progress').textContent = '';
        
        let contentHTML = '';
        
        if (isTeacher) {
          contentHTML = '<p>No exemplars have been added for this unit yet.</p>';
          contentHTML += '<p><strong>Teachers:</strong> To add exemplars for this unit:</p>';
          contentHTML += '<ol>';
          contentHTML += '<li>Open your Google Sheets document</li>';
          contentHTML += '<li>Go to the "Exemplars" tab (it will be created automatically if it doesn\'t exist)</li>';
          contentHTML += '<li>Add your exemplars with these exact column headers:</li>';
          contentHTML += '</ol>';
          contentHTML += '<div style="background-color:#f8f9fa; padding:10px; border-radius:5px; margin:10px 0;">';
          contentHTML += '<strong>Required Columns:</strong><br>';
          contentHTML += 'Unit | Topic | Use | Source Text | Exemplars | How It Works<br><br>';
          contentHTML += `<strong>Unit name to use:</strong> "${currentUnit}"<br>`;
          contentHTML += '<strong>Each row represents one exemplar</strong>';
          contentHTML += '</div>';
          
          if (debugInfo) {
            contentHTML += '<details style="margin-top:15px; font-size:0.9em; color:#666;">';
            contentHTML += '<summary>Debug Information (click to expand)</summary>';
            contentHTML += `<pre style="background:#f0f0f0; padding:10px; margin:5px 0; border-radius:3px; font-size:0.8em;">${JSON.stringify(debugInfo, null, 2)}</pre>`;
            contentHTML += '</details>';
          }
        } else {
          // Simple message for students
          contentHTML = '<p>No exemplars available yet. Please check back at a later time.</p>';
        }
        
        document.getElementById('exemplar-content').innerHTML = contentHTML;
        
        document.getElementById('exemplar-explanation-text').innerHTML = `
          <p>Exemplars are examples that help students understand key concepts before practicing.</p>
        `;
        
        // Update buttons for empty state
        const buttonsContainer = document.querySelector('.exemplar-buttons');
        buttonsContainer.innerHTML = `
          <button id="exemplar-back-btn" class="exemplar-nav-btn">‚Üê Back to Units</button>
          ${isTeacher ? '<button id="edit-exemplars-btn" class="exemplar-edit-btn">üìù Open Google Sheets</button>' : ''}
          ${!isTeacher ? '<button id="continue-to-quiz-btn" class="got-it-btn">Continue to Practice</button>' : ''}
        `;
        
        // Set up button handlers
        document.getElementById('exemplar-back-btn').onclick = () => {
          if (isTeacherViewingAsStudent) {
            returnToTeacherView();
          } else {
            showScreen('unit-selection-screen');
          }
        };
        
        if (isTeacher && document.getElementById('edit-exemplars-btn')) {
          document.getElementById('edit-exemplars-btn').onclick = () => {
            // Direct link to Google Sheets would be ideal, but we'll show instructions
            showExemplarEditInterface();
          };
        }
        
        if (!isTeacher && document.getElementById('continue-to-quiz-btn')) {
          document.getElementById('continue-to-quiz-btn').onclick = () => {
            completeExemplars();
          };
        }
      }

      function displayExemplar() {
        if (currentExemplarIndex >= allExemplars.length) {
          // All exemplars completed, save progress and start quiz
          completeExemplars();
          return;
        }

        const exemplar = allExemplars[currentExemplarIndex];
        
        // Update title and progress - progress is now positioned in top right
        document.getElementById('exemplar-title').textContent = exemplar.topic || `Exemplar ${currentExemplarIndex + 1}`;
        document.getElementById('exemplar-progress').textContent = `${currentExemplarIndex + 1} of ${allExemplars.length}`;
        
        // Create subtitle section for Use and Source Text (centered under the title)
        const headerContainer = document.querySelector('.exemplar-header');
        let existingSubtitle = headerContainer.querySelector('.exemplar-subtitle');
        if (existingSubtitle) {
          existingSubtitle.remove();
        }
        
        let subtitleHTML = '';
        if (exemplar.use) {
          subtitleHTML += `Use: ${exemplar.use}`;
        }
        if (exemplar.sourceText) {
          if (subtitleHTML) subtitleHTML += '<br>';
          subtitleHTML += `Source: ${exemplar.sourceText}`;
        }
        
        if (subtitleHTML) {
          const subtitleDiv = document.createElement('div');
          subtitleDiv.className = 'exemplar-subtitle';
          subtitleDiv.innerHTML = subtitleHTML;
          // Insert after the title but before the progress indicator
          const titleElement = document.getElementById('exemplar-title');
          titleElement.insertAdjacentElement('afterend', subtitleDiv);
        }
        
        // Main content now only shows the exemplar itself (bigger and more prominent)
        document.getElementById('exemplar-content').innerHTML = exemplar.exemplars || "No exemplar provided.";
        
        // Show "How It Works" in the explanation section
        document.getElementById('exemplar-explanation-text').innerHTML = exemplar.howItWorks || "No explanation provided.";
        
        // Update buttons for normal exemplar display
        const isLastExemplar = currentExemplarIndex === allExemplars.length - 1;
        const buttonText = isLastExemplar ? "Start Practice" : "I've got it!";
        
        const buttonsContainer = document.querySelector('.exemplar-buttons');
        buttonsContainer.innerHTML = `
          <button id="exemplar-back-btn" class="exemplar-nav-btn">‚Üê Back to Units</button>
          <button id="got-it-btn" class="got-it-btn">${buttonText}</button>
          ${isTeacher ? '<button id="edit-exemplars-btn" class="exemplar-edit-btn">üìù Edit Exemplars</button>' : ''}
        `;
        
        // Set up button handlers
        document.getElementById('exemplar-back-btn').onclick = () => {
          if (isTeacherViewingAsStudent) {
            returnToTeacherView();
          } else {
            showScreen('unit-selection-screen');
          }
        };
        document.getElementById('got-it-btn').onclick = () => {
          if (isLastExemplar) {
            // Save exemplar completion and start quiz
            completeExemplars();
          } else {
            // Move to next exemplar
            currentExemplarIndex++;
            displayExemplar();
          }
        };
        
        if (isTeacher && document.getElementById('edit-exemplars-btn')) {
          document.getElementById('edit-exemplars-btn').onclick = () => showExemplarEditInterface();
        }
      }

      function completeExemplars() {
        // After exemplars, show choice screen again so student can decide next step
        showStudentChoiceScreen(currentUnit);
      }

      function showExemplarEditInterface() {
        const message = `Exemplar Management for ${currentUnit}:

TO ADD EXEMPLARS:
1. Open your Google Sheets document at:
   https://docs.google.com/spreadsheets/d/173tUIsQFYL8QeI-65DW62SeyOuBEK8v2t5Lhtmq5qSo/edit

2. Go to the "Exemplars" tab (created automatically if missing)

3. Add rows with these exact column headers:
   ‚Ä¢ Unit: "${currentUnit}"
   ‚Ä¢ Topic: The topic/concept being taught
   ‚Ä¢ Use: How this exemplar is used
   ‚Ä¢ Source Text: The original text (if applicable)
   ‚Ä¢ Exemplars: The actual example
   ‚Ä¢ How It Works: Explanation of why it works

4. Refresh this page after adding exemplars

EXAMPLE ROW:
Unit: ${currentUnit}
Topic: Strong Opening Sentences
Use: To engage readers from the first line
Source Text: Coming-of-age narrative
Exemplars: "The first day of high school changed everything I thought I knew about myself."
How It Works: This opening immediately establishes the theme of personal growth, creates intrigue, and draws the reader into the narrator's transformation journey.

Each row represents one exemplar. Add multiple rows for multiple exemplars.`;

        alert(message);
      }

      // Quiz Functions
      function startQuiz(unitName) {
        currentUnit = unitName;
        showScreen('loading-indicator');
        google.script.run.withSuccessHandler(onQuestionsLoaded).withFailureHandler(onLoadError).getQuestionsForUnit(unitName);
      }

      function onQuestionsLoaded(questions) {
        if (questions.error || questions.length === 0) {
          onLoadError({ message: questions.error ? questions.message : `No questions found for "${currentUnit}".` });
          return;
        }
        
        allQuestions = questions.map(q => ({...q, options: shuffleArray(q.options)}));
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = [];
        showScreen('quiz-screen');
        displayQuestion();
      }

      function displayQuestion() {
        const question = allQuestions[currentQuestionIndex];
        
        const isLastQuestion = currentQuestionIndex === allQuestions.length - 1;
        const nextButtonText = isLastQuestion ? "See Results" : "Go to next question";
        
        document.getElementById('quiz-screen').innerHTML = `
          <div id="progress-container"><p>Question ${currentQuestionIndex + 1} of ${allQuestions.length}</p></div>
          <h2 id="question-text">${question.question}</h2>
          <div id="answer-options">${question.options.map(opt => `<button class="option-btn">${opt}</button>`).join('')}</div>
          <div id="question-answer-result" style="margin: 20px 0; min-height: 60px;"></div>
          <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
            <button id="back-to-home-btn" class="exemplar-nav-btn">Back to Units</button>
            <button id="next-question-btn" class="got-it-btn" disabled>${nextButtonText}</button>
          </div>
          ${addTeacherBanner()}
        `;
        
        document.querySelectorAll('.option-btn').forEach(btn => {
          btn.onclick = () => handleAnswer(btn.textContent, btn);
        });
        
        
        document.getElementById('back-to-home-btn').onclick = () => {
          if (isTeacherViewingAsStudent) {
            returnToTeacherView();
          } else {
            showScreen('unit-selection-screen');
          }
        };
        
        document.getElementById('next-question-btn').onclick = () => {
          currentQuestionIndex++;
          if (currentQuestionIndex < allQuestions.length) {
            displayQuestion();
          } else {
            showResults();
          }
        };
      }

      function handleAnswer(selectedOption, buttonElement) {
        const question = allQuestions[currentQuestionIndex];
        const isCorrect = selectedOption === question.answer;
        
        userAnswers.push({
          question: question.question,
          selected: selectedOption,
          correctAnswer: question.answer,
          isCorrect: isCorrect
        });
        
        if (isCorrect) score++;
        
        buttonElement.classList.add(isCorrect ? 'correct' : 'incorrect');
        document.querySelectorAll('.option-btn').forEach(btn => {
          btn.disabled = true;
          if (btn.textContent === question.answer) btn.classList.add('correct');
        });
        
        // Show result and enable next button
        const resultDiv = document.getElementById('question-answer-result');
        resultDiv.innerHTML = `
          <p style="font-weight: 600; color: ${isCorrect ? '#28a745' : '#dc3545'};">
            ${isCorrect ? '‚úì Correct!' : '‚úó Incorrect'}
          </p>
          ${!isCorrect ? `<p style="color: #6c757d;">The correct answer is: <strong>${question.answer}</strong></p>` : ''}
        `;
        
        document.getElementById('next-question-btn').disabled = false;
      }

      function showResults() {
        const resultData = { unit: currentUnit, score: score, total: allQuestions.length };
        
        // Save results for registered students
        if (!isTeacher && userInfo.isRegistered) {
          google.script.run.withFailureHandler(err => console.error('Failed to save result:', err)).saveQuizResult(resultData);
        }
        
        document.getElementById('results-screen').innerHTML = `
          <h2>Quiz Complete!</h2>
          <p id="final-score">You scored ${score} out of ${allQuestions.length}!</p>
          <h3>Review Your Answers:</h3>
          <div id="review-container">
            ${userAnswers.map(ua => `
              <div class="review-item">
                <p class="review-question">${ua.question}</p>
                ${ua.isCorrect ? 
                  `<p>Your answer: <span class="review-answer-correct">${ua.selected} (Correct)</span></p>` : 
                  `<p>Your answer: <span class="review-answer-incorrect">${ua.selected}</span></p>
                   <p>Correct answer: <span class="review-answer-correct">${ua.correctAnswer}</span></p>`
                }
              </div>
            `).join('')}
          </div>
          <button id="try-again-btn">Practice this Unit Again</button>
          <button id="main-menu-btn">Back to Units</button>
          <div id="results-teacher-banner">${addTeacherBanner()}</div>
        `;
        
        showScreen('results-screen');
        
        document.getElementById('try-again-btn').onclick = () => startQuiz(currentUnit);
        document.getElementById('main-menu-btn').onclick = () => {
          if (isTeacherViewingAsStudent) {
            returnToTeacherView();
          } else {
            showScreen('unit-selection-screen');
          }
        };
      }

      // Utility Functions
      function showScreen(screenId) {
        document.querySelectorAll('.container > div:not(.hidden)').forEach(el => el.classList.add('hidden'));
        document.getElementById(screenId).classList.remove('hidden');
      }

      function hideScreen(screenId) {
        document.getElementById(screenId).classList.add('hidden');
      }

      function onLoadError(error) {
        hideScreen('loading-indicator');
        const errorDiv = document.getElementById('error-message');
        errorDiv.innerHTML = `<h2>An Error Occurred</h2><p>${error.message}</p><button onclick="initializeApp()">Try Again</button>`;
        showScreen('error-message');
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      // Teacher View Functions
      function addTeacherBanner() {
        if (isTeacherViewingAsStudent) {
          return `
            <div class="teacher-banner">
              üéì Viewing as Student
              <button onclick="returnToTeacherView()">Return to Teacher View</button>
            </div>
          `;
        }
        return '';
      }

      function enterStudentView(unitName) {
        isTeacherViewingAsStudent = true;
        currentUnit = unitName;
        // Show the student choice screen just like a real student would see
        showStudentChoiceScreen(unitName);
      }

      function returnToTeacherView() {
        isTeacherViewingAsStudent = false;
        showScreen('unit-selection-screen');
      }
      
      // Independent Reading Functions
      let currentIRView = 'dashboard'; // dashboard, student, detailed
      
      function showIndependentReading() {
        showScreen('independent-reading-screen');
        
        // Show loading and hide all containers
        document.getElementById('loading-ir').classList.remove('hidden');
        document.getElementById('ir-semesters-container').classList.add('hidden');
        document.getElementById('teacher-ir-controls').classList.add('hidden');
        document.getElementById('ir-dashboard-container').classList.add('hidden');
        
        // Set up navigation buttons
        document.getElementById('back-to-main-from-reading-btn').onclick = () => {
          showScreen('main-landing-screen');
        };
        
        document.getElementById('back-to-ir-from-teacher-btn').onclick = () => {
          showIndependentReading();
        };
        
        // Set up teacher control buttons
        document.getElementById('ir-dashboard-btn').onclick = () => switchIRView('dashboard');
        document.getElementById('ir-student-view-btn').onclick = () => switchIRView('student');
        
        // Load appropriate data based on user type
        if (isTeacher) {
          loadTeacherIndependentReading();
        } else {
          loadStudentIndependentReading();
        }
      }
      
      function loadTeacherIndependentReading() {
        // Show teacher controls
        document.getElementById('teacher-ir-controls').classList.remove('hidden');
        
        // Load dashboard by default
        switchIRView('dashboard');
      }
      
      function loadStudentIndependentReading() {
        // Load student data
        google.script.run
          .withSuccessHandler(onIndependentReadingDataLoaded)
          .withFailureHandler(onIndependentReadingError)
          .getIndependentReadingData();
      }
      
      function switchIRView(view) {
        currentIRView = view;
        
        // Update button states
        document.querySelectorAll('.ir-view-toggle').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`ir-${view}-btn`).classList.add('active');
        
        // Hide all containers
        document.getElementById('ir-semesters-container').classList.add('hidden');
        document.getElementById('ir-dashboard-container').classList.add('hidden');
        
        if (view === 'dashboard') {
          loadIRDashboard();
        } else if (view === 'student') {
          loadTeacherStudentView();
        }
      }
      
      function loadTeacherStudentView() {
        // Show a demo student view for teachers
        document.getElementById('loading-ir').classList.remove('hidden');
        
        // Create demo data for teacher to see
        const demoData = {
          success: true,
          semester1: {
            title: "Example Book Title",
            author: "Example Author",
            reflections: [
              { date: "2024-01-15", pagesRead: "50", totalPages: "200", text: "This is an example reflection..." },
              { date: "", pagesRead: "", totalPages: "", text: "" },
              { date: "", pagesRead: "", totalPages: "", text: "" }
            ]
          },
          semester2: {
            title: "",
            author: "",
            reflections: [
              { date: "", pagesRead: "", totalPages: "", text: "" },
              { date: "", pagesRead: "", totalPages: "", text: "" },
              { date: "", pagesRead: "", totalPages: "", text: "" }
            ]
          }
        };
        
        // Simulate loading delay then show student interface
        setTimeout(() => {
          document.getElementById('loading-ir').classList.add('hidden');
          document.getElementById('ir-semesters-container').classList.remove('hidden');
          
          // Add teacher demo banner
          const existingBanner = document.getElementById('teacher-demo-banner');
          if (existingBanner) existingBanner.remove();
          
          const banner = document.createElement('div');
          banner.id = 'teacher-demo-banner';
          banner.style.cssText = `
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            border: 2px solid #2196f3;
          `;
          banner.innerHTML = 'üéì Teacher Demo Mode - This is how students see the Independent Reading interface';
          
          const container = document.getElementById('ir-semesters-container');
          container.insertBefore(banner, container.firstChild);
          
          // Populate with demo data
          populateIndependentReadingData(demoData.semester1, demoData.semester2);
          
          // Restore collapsed state
          setTimeout(() => restoreCollapsedState(), 100);
        }, 500);
      }
      
      function loadIRDashboard() {
        document.getElementById('loading-ir').classList.remove('hidden');
        google.script.run
          .withSuccessHandler(onIRDashboardLoaded)
          .withFailureHandler(onIndependentReadingError)
          .getIndependentReadingDashboard();
      }
      
      function onIRDashboardLoaded(response) {
        document.getElementById('loading-ir').classList.add('hidden');
        
        if (!response.success) {
          onIndependentReadingError({ message: response.error });
          return;
        }
        
        // Show dashboard container
        document.getElementById('ir-dashboard-container').classList.remove('hidden');
        
        // Populate stats
        const statsContainer = document.getElementById('ir-dashboard-stats');
        statsContainer.innerHTML = `
          <div class="ir-stat-card">
            <div class="ir-stat-number">${response.stats.totalStudents}</div>
            <div class="ir-stat-label">Total Students</div>
          </div>
          <div class="ir-stat-card">
            <div class="ir-stat-number">${response.stats.semester1Students}</div>
            <div class="ir-stat-label">Semester 1 Books</div>
          </div>
          <div class="ir-stat-card">
            <div class="ir-stat-number">${response.stats.semester2Students}</div>
            <div class="ir-stat-label">Semester 2 Books</div>
          </div>
          <div class="ir-stat-card">
            <div class="ir-stat-number">${response.stats.completedSemester1}</div>
            <div class="ir-stat-label">S1 Completed</div>
          </div>
          <div class="ir-stat-card">
            <div class="ir-stat-number">${response.stats.completedSemester2}</div>
            <div class="ir-stat-label">S2 Completed</div>
          </div>
        `;
        
        // Populate student table
        const tableContainer = document.getElementById('ir-student-progress-table');
        if (response.students.length === 0) {
          tableContainer.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <h3>No Student Data</h3>
              <p>No students have submitted independent reading data yet.</p>
            </div>
          `;
        } else {
          let tableHTML = `
            <table>
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Semester 1</th>
                  <th>S1 Progress</th>
                  <th>Semester 2</th>
                  <th>S2 Progress</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          response.students.forEach(student => {
            const s1Status = getProgressStatus(student.semester1);
            const s2Status = getProgressStatus(student.semester2);
            const s1Progress = student.semester1.reflectionsCompleted || 0;
            const s2Progress = student.semester2.reflectionsCompleted || 0;
            
            tableHTML += `
              <tr>
                <td><strong>${student.name}</strong></td>
                <td>
                  ${student.semester1.hasBook ? 
                    `"${student.semester1.bookTitle}" by ${student.semester1.bookAuthor}` : 
                    '<span style="color: #6c757d;">No book selected</span>'}
                </td>
                <td>
                  <div class="ir-progress-bar">
                    <div class="ir-progress-fill ir-progress-semester1" style="width: ${(s1Progress / 3) * 100}%">
                      ${s1Progress}/3
                    </div>
                  </div>
                </td>
                <td>
                  ${student.semester2.hasBook ? 
                    `"${student.semester2.bookTitle}" by ${student.semester2.bookAuthor}` : 
                    '<span style="color: #6c757d;">No book selected</span>'}
                </td>
                <td>
                  <div class="ir-progress-bar">
                    <div class="ir-progress-fill ir-progress-semester2" style="width: ${(s2Progress / 3) * 100}%">
                      ${s2Progress}/3
                    </div>
                  </div>
                </td>
              </tr>
            `;
          });
          
          tableHTML += `</tbody></table>`;
          tableContainer.innerHTML = tableHTML;
        }
      }
      
      function getProgressStatus(semesterData) {
        if (!semesterData.hasBook) return 'not-started';
        if (semesterData.reflectionsCompleted === 3) return 'completed';
        return 'in-progress';
      }
      
      function toggleSemester(semesterId) {
        const content = document.getElementById(`${semesterId}-content`);
        const title = document.querySelector(`[onclick="toggleSemester('${semesterId}')"]`);
        
        content.classList.toggle('collapsed');
        title.classList.toggle('collapsed');
        
        // Save collapsed state to localStorage
        const collapsedSemesters = JSON.parse(localStorage.getItem('collapsedSemesters') || '[]');
        const isCollapsed = content.classList.contains('collapsed');
        
        if (isCollapsed && !collapsedSemesters.includes(semesterId)) {
          collapsedSemesters.push(semesterId);
        } else if (!isCollapsed && collapsedSemesters.includes(semesterId)) {
          const index = collapsedSemesters.indexOf(semesterId);
          collapsedSemesters.splice(index, 1);
        }
        
        localStorage.setItem('collapsedSemesters', JSON.stringify(collapsedSemesters));
      }
      
      function restoreCollapsedState() {
        const collapsedSemesters = JSON.parse(localStorage.getItem('collapsedSemesters') || '[]');
        collapsedSemesters.forEach(semesterId => {
          const content = document.getElementById(`${semesterId}-content`);
          const title = document.querySelector(`[onclick="toggleSemester('${semesterId}')"]`);
          if (content && title) {
            content.classList.add('collapsed');
            title.classList.add('collapsed');
          }
        });
      }
      
      function onIndependentReadingDataLoaded(response) {
        document.getElementById('loading-ir').classList.add('hidden');
        
        if (!response.success) {
          onIndependentReadingError({ message: response.error });
          return;
        }
        
        // Show teacher controls if user is teacher
        if (isTeacher) {
          document.getElementById('teacher-ir-controls').classList.remove('hidden');
        }
        
        // Show semester containers
        document.getElementById('ir-semesters-container').classList.remove('hidden');
        
        // Populate data
        populateIndependentReadingData(response.semester1, response.semester2);
        
        // Restore collapsed state
        setTimeout(() => restoreCollapsedState(), 100);
      }
      
      function onIndependentReadingError(error) {
        document.getElementById('loading-ir').classList.add('hidden');
        document.getElementById('ir-semesters-container').innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h3>Error Loading Independent Reading</h3>
            <p>${error.message}</p>
            <button onclick="showIndependentReading()" class="got-it-btn">Try Again</button>
          </div>
        `;
        document.getElementById('ir-semesters-container').classList.remove('hidden');
      }
      
      function populateIndependentReadingData(semester1Data, semester2Data) {
        // Populate Semester 1
        if (semester1Data && semester1Data.title) {
          document.getElementById('s1-book-title').value = semester1Data.title;
          document.getElementById('s1-book-author').value = semester1Data.author || '';
          
          if (semester1Data.reflections) {
            semester1Data.reflections.forEach((reflection, index) => {
              const prefix = `s1-r${index + 1}`;
              document.getElementById(`${prefix}-date`).value = reflection.date || '';
              document.getElementById(`${prefix}-pages-read`).value = reflection.pagesRead || '';
              document.getElementById(`${prefix}-total-pages`).value = reflection.totalPages || '';
              document.getElementById(`${prefix}-text`).value = reflection.text || '';
            });
          }
        }
        
        // Populate Semester 2
        if (semester2Data && semester2Data.title) {
          document.getElementById('s2-book-title').value = semester2Data.title;
          document.getElementById('s2-book-author').value = semester2Data.author || '';
          
          if (semester2Data.reflections) {
            semester2Data.reflections.forEach((reflection, index) => {
              const prefix = `s2-r${index + 1}`;
              document.getElementById(`${prefix}-date`).value = reflection.date || '';
              document.getElementById(`${prefix}-pages-read`).value = reflection.pagesRead || '';
              document.getElementById(`${prefix}-total-pages`).value = reflection.totalPages || '';
              document.getElementById(`${prefix}-text`).value = reflection.text || '';
            });
          }
        }
      }
      
      function saveReflection(semester, reflectionIndex) {
        const semesterCode = semester === 'Semester 1' ? 's1' : 's2';
        const reflectionCode = `r${reflectionIndex + 1}`;
        
        // Get book info
        const bookTitle = document.getElementById(`${semesterCode}-book-title`).value.trim();
        const bookAuthor = document.getElementById(`${semesterCode}-book-author`).value.trim();
        
        // Get reflection info
        const date = document.getElementById(`${semesterCode}-${reflectionCode}-date`).value;
        const pagesRead = document.getElementById(`${semesterCode}-${reflectionCode}-pages-read`).value;
        const totalPages = document.getElementById(`${semesterCode}-${reflectionCode}-total-pages`).value;
        const reflectionText = document.getElementById(`${semesterCode}-${reflectionCode}-text`).value.trim();
        
        // Validation
        if (!bookTitle) {
          alert('Please enter a book title before saving reflections.');
          document.getElementById(`${semesterCode}-book-title`).focus();
          return;
        }
        
        if (!bookAuthor) {
          alert('Please enter the book author before saving reflections.');
          document.getElementById(`${semesterCode}-book-author`).focus();
          return;
        }
        
        if (!date || !pagesRead || !totalPages || !reflectionText) {
          alert('Please fill in all fields for this reflection.');
          return;
        }
        
        // Find the save button and show saving state
        const saveBtn = event.target;
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'üíæ Saving...';
        saveBtn.disabled = true;
        
        // Save to backend
        google.script.run
          .withSuccessHandler(() => {
            saveBtn.textContent = '‚úÖ Saved!';
            setTimeout(() => {
              saveBtn.textContent = originalText;
              saveBtn.disabled = false;
            }, 2000);
          })
          .withFailureHandler((error) => {
            saveBtn.textContent = '‚ùå Save Failed';
            setTimeout(() => {
              saveBtn.textContent = originalText;
              saveBtn.disabled = false;
            }, 2000);
            console.error('Save failed:', error);
            alert('Save failed: ' + error.message);
          })
          .saveIndependentReadingData(semester, bookTitle, bookAuthor, reflectionIndex, date, pagesRead, totalPages, reflectionText);
      }
      
      function showAllStudentReading() {
        showScreen('teacher-ir-screen');
        
        // Show loading
        document.getElementById('loading-teacher-ir').classList.remove('hidden');
        document.getElementById('teacher-ir-data').classList.add('hidden');
        
        // Load all student data
        google.script.run
          .withSuccessHandler(onAllStudentReadingLoaded)
          .withFailureHandler(onAllStudentReadingError)
          .getAllIndependentReadingData();
      }
      
      function onAllStudentReadingLoaded(response) {
        document.getElementById('loading-teacher-ir').classList.add('hidden');
        
        if (!response.success) {
          onAllStudentReadingError({ message: response.error });
          return;
        }
        
        const container = document.getElementById('teacher-ir-data');
        
        if (!response.students || response.students.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <h3>No Student Data</h3>
              <p>No students have submitted independent reading data yet.</p>
            </div>
          `;
        } else {
          // Group students by name and semester
          const studentGroups = {};
          response.students.forEach(entry => {
            const key = entry.studentName;
            if (!studentGroups[key]) {
              studentGroups[key] = { semester1: null, semester2: null };
            }
            if (entry.semester === 'Semester 1') {
              studentGroups[key].semester1 = entry;
            } else if (entry.semester === 'Semester 2') {
              studentGroups[key].semester2 = entry;
            }
          });
          
          let html = '';
          Object.entries(studentGroups).forEach(([studentName, data]) => {
            html += `
              <div class="teacher-ir-student">
                <div class="teacher-ir-student-name">${studentName}</div>
            `;
            
            // Semester 1
            if (data.semester1) {
              html += `
                <div class="teacher-ir-book">
                  <div class="teacher-ir-book-title">Semester 1: "${data.semester1.bookTitle}" by ${data.semester1.bookAuthor}</div>
                  ${data.semester1.reflections.map((reflection, index) => {
                    if (reflection.date || reflection.text) {
                      return `
                        <div class="teacher-ir-reflection">
                          <div class="teacher-ir-reflection-header">Reflection ${index + 1} - ${reflection.date} (${reflection.pagesRead}/${reflection.totalPages} pages)</div>
                          <div>${reflection.text || 'No reflection text'}</div>
                        </div>
                      `;
                    }
                    return '';
                  }).join('')}
                </div>
              `;
            }
            
            // Semester 2
            if (data.semester2) {
              html += `
                <div class="teacher-ir-book">
                  <div class="teacher-ir-book-title">Semester 2: "${data.semester2.bookTitle}" by ${data.semester2.bookAuthor}</div>
                  ${data.semester2.reflections.map((reflection, index) => {
                    if (reflection.date || reflection.text) {
                      return `
                        <div class="teacher-ir-reflection">
                          <div class="teacher-ir-reflection-header">Reflection ${index + 1} - ${reflection.date} (${reflection.pagesRead}/${reflection.totalPages} pages)</div>
                          <div>${reflection.text || 'No reflection text'}</div>
                        </div>
                      `;
                    }
                    return '';
                  }).join('')}
                </div>
              `;
            }
            
            if (!data.semester1 && !data.semester2) {
              html += `<p style="color: #666; font-style: italic;">No reading data submitted yet.</p>`;
            }
            
            html += `</div>`;
          });
          
          container.innerHTML = html;
        }
        
        document.getElementById('teacher-ir-data').classList.remove('hidden');
      }
      
      function onAllStudentReadingError(error) {
        document.getElementById('loading-teacher-ir').classList.add('hidden');
        document.getElementById('teacher-ir-data').innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h3>Error Loading Student Data</h3>
            <p>${error.message}</p>
            <button onclick="showAllStudentReading()" class="got-it-btn">Try Again</button>
          </div>
        `;
        document.getElementById('teacher-ir-data').classList.remove('hidden');
      }
      
      // Learning Portfolio Functions
      
      function showLearningPortfolio() {
        showScreen('learning-portfolio-screen');
        loadPortfolioUnits();
      }
      
      
      
      function loadPortfolioUnits() {
        showScreen('loading-indicator');
        google.script.run
          .withSuccessHandler(onPortfolioSummaryLoaded)
          .withFailureHandler(onLoadError)
          .getPortfolioSummary();
      }
      
      function onPortfolioSummaryLoaded(response) {
        hideScreen('loading-indicator');
        
        if (!response.success) {
          onLoadError({ message: response.error });
          return;
        }
        
        portfolioUnits = response.enabledUnits;
        displayPortfolioUnits(response.unitSummaries);
        
        // Show the portfolio unit grid
        document.getElementById('portfolio-unit-grid').style.display = 'block';
      }
      
      function displayPortfolioUnits(unitSummaries) {
        const container = document.getElementById('portfolio-unit-grid');
        container.innerHTML = '';
        
        unitSummaries.forEach(unitData => {
          const button = document.createElement('div');
          button.className = 'portfolio-unit-button';
          button.onclick = (e) => handlePortfolioUnitClick(unitData.unit, e);
          
          let toggleHTML = '';
          if (isTeacher) {
            const isEnabled = portfolioUnitSettings[unitData.unit] !== false; // Default to true if not set
            
            toggleHTML = `
              <div class="portfolio-toggle-wrapper" onclick="event.stopPropagation()">
                <label class="portfolio-inline-toggle">
                  <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="handlePortfolioUnitToggle('${unitData.unit}', this.checked, this)">
                  <span class="portfolio-slider"></span>
                </label>
              </div>
            `;
          }
          
          button.innerHTML = `
            ${toggleHTML}
            <div class="portfolio-unit-title">${unitData.unit}</div>
            <div class="portfolio-unit-status">${unitData.status} (${unitData.targetCount} targets)</div>
          `;
          container.appendChild(button);
        });
        
        // Set up back to main button
        document.getElementById('back-to-main-from-portfolio-btn').onclick = () => {
          showScreen('main-landing-screen');
        };
        
        showScreen('learning-portfolio-screen');
      }
      
      function handlePortfolioUnitClick(unitName, event) {
        // Prevent click if it's from the toggle area
        if (event && event.target.closest('.portfolio-toggle-wrapper')) {
          return;
        }
        
        currentPortfolioUnit = unitName;
        
        // All units now support the learning portfolio system
        showUnitPortfolio(unitName);
      }
      
      function showUnitPortfolio(unitName) {
        currentPortfolioUnit = unitName;
        document.getElementById('unit-portfolio-title').textContent = `${unitName} - Learning Portfolio`;
        
        // Show loading state
        document.getElementById('loading-targets').classList.remove('hidden');
        document.getElementById('targets-content').innerHTML = '';
        showScreen('unit-portfolio-screen');
        
        // All units now use the three-phase system
        const promises = [
          new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getLearningTargetsFromSheet(unitName);
          })
        ];
        
        // Only load student proficiency data for students, not teachers
        if (!isTeacher) {
          promises.push(
            new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getLearningPortfolioData(unitName);
            })
          );
        }
        
        Promise.all(promises).then((responses) => {
          document.getElementById('loading-targets').classList.add('hidden');
          
          const targetsResponse = responses[0];
          const proficiencyResponse = responses[1] || { success: true, proficiencyData: {} };
          
          if (!targetsResponse.success) {
            throw new Error(targetsResponse.error);
          }
          if (!proficiencyResponse.success) {
            throw new Error(proficiencyResponse.error);
          }
          
          learningTargetsData = targetsResponse.targets;
          studentProficiencyData = proficiencyResponse.proficiencyData;
          
          // Store proficiency options for display
          window.proficiencyOptions = targetsResponse.proficiencyOptions;
          
          displayThreePhases();
        }).catch(error => {
          document.getElementById('loading-targets').classList.add('hidden');
          onLoadError({ message: error.message || error.toString() });
        });
      }
      
      function displayThreePhases() {
        const container = document.getElementById('targets-content');
        
        if (learningTargetsData.length === 0) {
          container.innerHTML = '<p>No learning targets have been set up for this unit yet.</p>';
          return;
        }
        
        const phases = ['Beginning', 'Middle', 'End'];
        
        // Create table-style layout with learning targets as rows and phases as columns
        const targetsRowsHTML = learningTargetsData.map(target => {
          const phaseCellsHTML = phases.map(phase => {
            const currentLevel = (studentProficiencyData[target.target] && studentProficiencyData[target.target][phase]) || 0;
            
            if (isTeacher) {
              // Teacher view - interactive dropdowns that don't save
              return `
                <td class="phase-cell">
                  <select onchange="teacherDemoDropdown(this)" 
                          data-target="${target.target}" data-phase="${phase}"
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                    <option value="0">Not Started</option>
                    ${window.proficiencyOptions ? window.proficiencyOptions.map(option => 
                      `<option value="${option.value}">${option.label}</option>`
                    ).join('') : 
                    `<option value="1">Beginning</option>
                     <option value="2">Developing</option>
                     <option value="3">Proficient</option>
                     <option value="4">Mastery</option>`}
                  </select>
                </td>
              `;
            } else {
              // Student view - interactive dropdowns that save
              return `
                <td class="phase-cell">
                  <select onchange="updateProficiencyLevel('${target.target}', '${phase}', this.value)" 
                          data-target="${target.target}" data-phase="${phase}"
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="0" ${currentLevel == 0 ? 'selected' : ''}>Not Started</option>
                    ${window.proficiencyOptions ? window.proficiencyOptions.map(option => 
                      `<option value="${option.value}" ${currentLevel == option.value ? 'selected' : ''}>${option.label}</option>`
                    ).join('') : 
                    `<option value="1" ${currentLevel == 1 ? 'selected' : ''}>Beginning</option>
                     <option value="2" ${currentLevel == 2 ? 'selected' : ''}>Developing</option>
                     <option value="3" ${currentLevel == 3 ? 'selected' : ''}>Proficient</option>
                     <option value="4" ${currentLevel == 4 ? 'selected' : ''}>Mastery</option>`}
                  </select>
                </td>
              `;
            }
          }).join('');
          
          return `
            <tr class="target-row">
              <td class="target-name">
                <div class="target-title">${target.target}</div>
              </td>
              ${phaseCellsHTML}
            </tr>
          `;
        }).join('');
        
        container.innerHTML = `
          ${isTeacher ? 
            '<div style="background-color: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;"><strong>Teacher View:</strong> You can interact with the dropdowns to see how they work for students. Your selections are for demonstration only and will not be saved.</div>' : 
            ''}
          <div class="unit1-grid-container">
            <table class="unit1-proficiency-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
              <thead>
                <tr>
                  <th style="text-align: left; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; font-family: 'Patrick Hand', cursive; font-size: 1.2em;">Learning Target</th>
                  <th style="text-align: center; padding: 15px; background-color: #fff8e1; border: 1px solid #ffc107; font-family: 'Patrick Hand', cursive; font-size: 1.2em; color: #f57c00;">Beginning</th>
                  <th style="text-align: center; padding: 15px; background-color: #e3f2fd; border: 1px solid #2196f3; font-family: 'Patrick Hand', cursive; font-size: 1.2em; color: #0277bd;">Middle</th>
                  <th style="text-align: center; padding: 15px; background-color: #e8f5e8; border: 1px solid #4caf50; font-family: 'Patrick Hand', cursive; font-size: 1.2em; color: #2e7d32;">End</th>
                </tr>
              </thead>
              <tbody>
                ${targetsRowsHTML}
              </tbody>
            </table>
          </div>
        `;
        
        // Set up navigation buttons
        document.getElementById('back-to-portfolio-btn').onclick = () => {
          if (isTeacher) {
            showLearningPortfolio();
          } else {
            showScreen('main-landing-screen');
          }
        };
        
        if (isTeacher) {
          // Hide save button for teachers and update back button text
          document.getElementById('save-portfolio-btn').style.display = 'none';
          document.getElementById('back-to-portfolio-btn').textContent = '‚Üê Back to Portfolio';
        } else {
          document.getElementById('save-portfolio-btn').onclick = () => {
            saveAllProficiencyLevels();
          };
        }
      }

      function displayLearningTargets() {
        const container = document.getElementById('targets-content');
        const unitProficiencyData = studentProficiencyData[currentPortfolioUnit] || {};
        
        if (learningTargetsData.length === 0) {
          container.innerHTML = '<p>No learning targets have been set up for this unit yet.</p>';
          return;
        }
        
        container.innerHTML = learningTargetsData.map(target => {
          const currentLevel = unitProficiencyData[target.target] || 0;
          
          return `
            <div class="learning-target-item">
              <div class="target-title">${target.target}</div>
              <div class="target-description">${target.description}</div>
              <div class="proficiency-selector">
                <label>My current level:</label>
                <div class="proficiency-option">
                  <input type="radio" name="proficiency-${target.target}" value="0" ${currentLevel == 0 ? 'checked' : ''} onchange="updateProficiencyLevel('${target.target}', 0)">
                  <span class="proficiency-not-started">Not Started</span>
                </div>
                <div class="proficiency-option">
                  <input type="radio" name="proficiency-${target.target}" value="1" ${currentLevel == 1 ? 'checked' : ''} onchange="updateProficiencyLevel('${target.target}', 1)">
                  <span class="proficiency-developing">Developing</span>
                </div>
                <div class="proficiency-option">
                  <input type="radio" name="proficiency-${target.target}" value="2" ${currentLevel == 2 ? 'checked' : ''} onchange="updateProficiencyLevel('${target.target}', 2)">
                  <span class="proficiency-proficient">Proficient</span>
                </div>
                <div class="proficiency-option">
                  <input type="radio" name="proficiency-${target.target}" value="3" ${currentLevel == 3 ? 'checked' : ''} onchange="updateProficiencyLevel('${target.target}', 3)">
                  <span class="proficiency-mastered">Mastered</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        // Set up navigation buttons
        document.getElementById('back-to-portfolio-btn').onclick = () => {
          showLearningPortfolio();
        };
        
        document.getElementById('save-portfolio-btn').onclick = () => {
          saveAllProficiencyLevels();
        };
      }
      
      function updateProficiencyLevel(learningTarget, level) {
        // Update local data
        if (!studentProficiencyData[currentPortfolioUnit]) {
          studentProficiencyData[currentPortfolioUnit] = {};
        }
        studentProficiencyData[currentPortfolioUnit][learningTarget] = parseInt(level);
        
        // Auto-save to backend (optional - can be disabled for manual save only)
        google.script.run
          .withSuccessHandler(() => {
            console.log(`Auto-saved ${learningTarget}: ${level}`);
          })
          .withFailureHandler((error) => {
            console.error('Auto-save failed:', error);
          })
          .saveStudentProficiency(currentPortfolioUnit, learningTarget, parseInt(level));
      }
      
      function saveAllProficiencyLevels() {
        const saveButton = document.getElementById('save-portfolio-btn');
        const originalText = saveButton.textContent;
        saveButton.textContent = 'üíæ Saving...';
        saveButton.disabled = true;
        
        // Get all current selections and save them
        const targets = learningTargetsData;
        const savePromises = targets.map(target => {
          const selectedRadio = document.querySelector(`input[name="proficiency-${target.target}"]:checked`);
          if (selectedRadio) {
            const level = parseInt(selectedRadio.value);
            return new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .saveStudentProficiency(currentPortfolioUnit, target.target, level);
            });
          }
          return Promise.resolve();
        });
        
        Promise.all(savePromises).then(() => {
          saveButton.textContent = '‚úÖ Saved!';
          setTimeout(() => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          }, 2000);
        }).catch(error => {
          saveButton.textContent = '‚ùå Save Failed';
          setTimeout(() => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          }, 2000);
          console.error('Save failed:', error);
        });
      }
      
      function handlePortfolioUnitToggle(unitName, isEnabled, toggleElement) {
        // This function is for teachers to toggle portfolio units (similar to regular unit toggles)
        portfolioUnitSettings[unitName] = isEnabled;
        
        // For now, we'll use the same backend as regular unit settings
        // In a full implementation, you might want separate portfolio unit settings
        google.script.run
          .withSuccessHandler(() => {
            console.log(`Portfolio unit ${unitName} ${isEnabled ? 'enabled' : 'disabled'}`);
          })
          .withFailureHandler((error) => {
            portfolioUnitSettings[unitName] = !isEnabled;
            toggleElement.checked = !isEnabled;
            onLoadError({ message: error.message });
          })
          .updateTeacherUnitSettings(unitName, isEnabled);
      }
      
      // Three-Phase Functions
      function updateProficiencyLevel(learningTarget, phase, level) {
        // Update local data
        if (!studentProficiencyData[learningTarget]) {
          studentProficiencyData[learningTarget] = {};
        }
        studentProficiencyData[learningTarget][phase] = parseInt(level);
        
        // Auto-save to backend using Unit 1 specific function
        google.script.run
          .withSuccessHandler(() => {
            console.log(`Auto-saved ${learningTarget} ${phase}: ${level}`);
            // Show brief visual feedback
            const selector = document.querySelector(`select[data-target="${learningTarget}"][data-phase="${phase}"]`);
            if (selector) {
              const originalBg = selector.style.backgroundColor;
              selector.style.backgroundColor = '#d1e7dd';
              setTimeout(() => {
                selector.style.backgroundColor = originalBg;
              }, 1000);
            }
          })
          .withFailureHandler((error) => {
            console.error('Auto-save failed:', error);
            // Show error feedback
            const selector = document.querySelector(`select[data-target="${learningTarget}"][data-phase="${phase}"]`);
            if (selector) {
              const originalBg = selector.style.backgroundColor;
              selector.style.backgroundColor = '#f8d7da';
              setTimeout(() => {
                selector.style.backgroundColor = originalBg;
              }, 2000);
            }
          })
          .saveLearningPortfolioProficiency(learningTarget, parseInt(level), phase);
      }
      
      function saveAllProficiencyLevels() {
        const saveButton = document.getElementById('save-portfolio-btn');
        const originalText = saveButton.textContent;
        saveButton.textContent = 'üíæ Saving...';
        saveButton.disabled = true;
        
        // Get all current selections from the new grid layout and save them
        const targets = learningTargetsData;
        const phases = ['Beginning', 'Middle', 'End'];
        const savePromises = [];
        
        targets.forEach(target => {
          phases.forEach(phase => {
            const selector = document.querySelector(`select[data-target="${target.target}"][data-phase="${phase}"]`);
            if (selector && selector.value !== undefined) {
              const level = parseInt(selector.value);
              savePromises.push(new Promise((resolve, reject) => {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .saveLearningPortfolioProficiency(target.target, level, phase);
              }));
            }
          });
        });
        
        Promise.all(savePromises).then(() => {
          saveButton.textContent = '‚úÖ All Saved!';
          setTimeout(() => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          }, 2000);
        }).catch(error => {
          saveButton.textContent = '‚ùå Save Failed';
          setTimeout(() => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          }, 2000);
          console.error('Save failed:', error);
        });
      }
      
      // Teacher demo dropdown function (non-saving)
      function teacherDemoDropdown(selectElement) {
        // This function is called when teachers interact with dropdowns
        // It provides visual feedback but doesn't save data
        console.log(`Teacher demo: Selected ${selectElement.value} for ${selectElement.dataset.target} - ${selectElement.dataset.phase}`);
        
        // Optional: Add visual feedback that it's demo only
        selectElement.style.backgroundColor = '#fff3cd';
        setTimeout(() => {
          selectElement.style.backgroundColor = '#f8f9fa';
        }, 1000);
      }
    </script>
  </body>
</html>