<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
      body{font-family:'Nunito',sans-serif;background-color:#faf9f7;color:#34495e;margin:0;padding:20px;display:flex;justify-content:center;align-items:center;min-height:100vh}
      
.container{background-color:#fff;padding:2em 3em;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.15);width:100%;max-width:1200px;text-align:center;border:1px solid #f7f7f7}
      
.hidden{display:none}h1,h2,h3{font-family:'Patrick Hand',cursive;color:#2c3e50}h1{font-size:3.5em;margin-bottom:.2em;margin-top:0}h2{font-size:2em;color:#34495e;margin-top:0}h3{font-size:1.8em;margin-top:1.5em;margin-bottom:0.5em}

      /* Shared Unit Grid Styles */
      /* Grammar Practice Unit Grid - Grid Layout */
      #unit-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:2em}
      
      /* MCA Unit Grid - Grid Layout */
      #mca-unit-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:2em}
      
      /* Learning Portfolio Grid - Grid Layout */
      #portfolio-unit-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:2em}
      .unit-button{display:block;text-decoration:none;color:#2c3e50;background-color:#f8f9fa;border-radius:8px;padding:20px;position:relative;overflow:visible;transition:transform .2s ease,box-shadow .2s ease;border:2px solid #dee2e6;cursor:pointer;text-align:center}
      .unit-button:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,.15);border-color:#adb5bd}
      .unit-title{font-family:'Patrick Hand',cursive;font-size:1.4em;margin-bottom:10px;font-weight:bold}
      .unit-progress{font-family:'Nunito',sans-serif;font-size:0.9em;color:#6c757d}

      /* Inline Unit Toggle Styles */
      .unit-toggle-wrapper{position:absolute;bottom:8px;right:8px;z-index:10}
      .unit-inline-toggle{position:relative;display:inline-block;width:32px;height:18px}
      .unit-inline-toggle input{opacity:0;width:0;height:0}
      .unit-inline-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.2s;border-radius:18px}
      .unit-inline-slider:before{position:absolute;content:"";height:14px;width:14px;left:2px;bottom:2px;background-color:white;transition:.2s;border-radius:50%}
      .unit-inline-toggle input:checked + .unit-inline-slider{background-color:#28a745}
      .unit-inline-toggle input:checked + .unit-inline-slider:before{transform:translateX(14px)}

      /* Quiz Interface Styles */
      #question-text{font-family:'Nunito',sans-serif;font-size:1.3em;margin:1em 0;min-height:60px}
      #answer-options{display:flex;flex-direction:column;gap:15px;margin:2em 0}
      .option-btn{font-family:'Nunito',sans-serif;font-size:1em;cursor:pointer;border:2px solid #ced4da;background-color:#fff;border-radius:8px;transition:all .2s ease;padding:15px;text-align:center}
      .option-btn:not([disabled]):hover{background-color:#e9ecef;border-color:#adb5bd}
      .option-btn.correct{background-color:#d1e7dd;border-color:#28a745;color:#0f5132}
      .option-btn.incorrect{background-color:#f8d7da;border-color:#dc3545;color:#842029}
      .option-btn:disabled{cursor:not-allowed;opacity:.8}
      #progress-container{text-align:right;color:#6c757d}
      #final-score{font-family:'Patrick Hand',cursive;font-size:2.5em;font-weight:700;margin:1em 0}
      #review-container{text-align:left;margin-top:2em;max-height:400px;overflow-y:auto;border-top:1px solid #ddd}
      .review-item{padding:15px;border-bottom:1px solid #ecf0f1}
      .review-question{font-weight:700}
      .review-answer-correct{color:#198754}
      .review-answer-incorrect{color:#dc3545;text-decoration:line-through}

      /* Teacher Modal Styles */
      .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5)}
      .modal.show{display:block}
      .modal-content{background-color:#fff;margin:10% auto;padding:30px;border-radius:15px;width:90%;max-width:500px;position:relative;box-shadow:0 10px 25px rgba(0,0,0,0.2)}
      .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer;position:absolute;right:15px;top:10px}
      .close:hover{color:#000}
      .teacher-actions{display:flex;flex-direction:column;gap:15px;margin-top:20px}
      .action-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;border:none;padding:15px 20px;border-radius:8px;cursor:pointer;font-size:1.1em;transition:all .2s ease;text-align:left}
      .action-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
      .practice-btn{background-color:#28a745}
      .results-btn{background-color:#007bff}
      .edit-btn{background-color:#6f42c1}


      /* Teacher Results Table */
      #teacher-results-table{width:100%;border-collapse:collapse;margin-top:1em}
      #teacher-results-table th,#teacher-results-table td{padding:12px 15px;border:1px solid #ddd;text-align:left}
      #teacher-results-table th{background-color:#34495e;color:#fff;font-family:'Nunito'}
      #teacher-results-table tr:nth-child(even){background-color:#f8f9fa}
      .score-mastered{color:#2ECC71;font-weight:bold}
      .score-proficient{color:#F39C12;font-weight:bold}
      .score-developing{color:#E74C3C;font-weight:bold}
      .score-unattempted{color:#95a5a6;font-style:italic}

      /* Portfolio Dashboard Table */
      #portfolio-dashboard-table{width:100%;border-collapse:collapse;margin-top:1em}
      #portfolio-dashboard-table th,#portfolio-dashboard-table td{padding:12px 15px;border:1px solid #ddd;text-align:left}
      #portfolio-dashboard-table th{background-color:#34495e;color:#fff;font-family:'Nunito'}
      #portfolio-dashboard-table tr:nth-child(even){background-color:#f8f9fa}
      .proficiency-beginning{color:#95a5a6;font-style:italic}
      .proficiency-developing{color:#E74C3C;font-weight:bold}
      .proficiency-proficient{color:#F39C12;font-weight:bold}
      .proficiency-mastery{color:#2ECC71;font-weight:bold}

      /* Edit Targets Styles */
      .target-edit-item{background-color:#f8f9fa;border-radius:8px;padding:15px;margin-bottom:15px;border:1px solid #dee2e6}
      .target-edit-text{width:100%;padding:8px;border:1px solid #ced4da;border-radius:4px;font-size:1em;margin-bottom:10px}
      .target-phases{display:flex;gap:15px;align-items:center;margin-bottom:10px}
      .target-actions{display:flex;gap:10px;justify-content:flex-end}

      /* Exemplars Screen Styles */
      #exemplars-screen{text-align:center}
      .exemplar-container{background-color:#f8f9fa;border-radius:10px;padding:2em;margin:1em auto;max-width:800px;border:1px solid #dee2e6}
      .exemplar-header{text-align:center;margin-bottom:1.5em;position:relative}
      .exemplar-progress{color:#6c757d;font-size:0.9em;position:absolute;right:0;top:0}
      .exemplar-title{font-family:'Patrick Hand',cursive;font-size:1.8em;color:#2c3e50;margin-bottom:0.5em;text-align:center}
      .exemplar-subtitle{font-family:'Patrick Hand',cursive;font-size:1.2em;color:#6c757d;margin-bottom:1em;line-height:1.4;text-align:center}
      .exemplar-content{background-color:#fff;padding:1.5em;border-radius:8px;margin-bottom:1.5em;text-align:left;font-size:1.5em;line-height:1.6;border:1px solid #e9ecef;font-weight:500}
      .exemplar-explanation{background-color:#e3f2fd;padding:1.5em;border-radius:8px;text-align:left;font-size:1.2em;line-height:1.5;border-left:4px solid #2196f3}
      .exemplar-explanation h4{margin-top:0;color:#1565c0;font-family:'Nunito',sans-serif}
      .exemplar-buttons{display:flex;gap:15px;justify-content:center;margin-top:2em}
      .got-it-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;background-color:#28a745;border:none;padding:15px 30px;border-radius:50px;cursor:pointer;font-size:1.1em;transition:all .2s ease;box-shadow:0 2px 5px rgba(0,0,0,.1)}
      .got-it-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
      .exemplar-nav-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;background-color:#6c757d;border:none;padding:15px 30px;border-radius:50px;cursor:pointer;transition:all .2s ease;box-shadow:0 2px 5px rgba(0,0,0,.1)}
      .exemplar-nav-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
      .exemplar-help-btn{font-family:'Nunito',sans-serif;font-weight:600;color:#007bff;background-color:#fff;border:2px solid #007bff;padding:8px 16px;border-radius:20px;cursor:pointer;transition:all .2s ease;margin-top:1em}
      .exemplar-help-btn:hover{background-color:#007bff;color:#fff}
      .exemplar-edit-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;background-color:#6f42c1;border:none;padding:15px 30px;border-radius:50px;cursor:pointer;font-size:1.1em;transition:all .2s ease;box-shadow:0 2px 5px rgba(0,0,0,.1)}
      .exemplar-edit-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15);background-color:#5a2d91}

      /* Student Choice Screen Styles */
      #student-choice-screen{text-align:center}
      .choice-container{background-color:#fff;padding:2em 3em;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.15);width:100%;max-width:900px;margin:0 auto;border:1px solid #f7f7f7}
      .choice-buttons{display:flex;flex-direction:column;gap:15px;margin:2em 0}
      .choice-btn{font-family:'Nunito',sans-serif;font-weight:700;border:none;padding:25px 30px;border-radius:15px;cursor:pointer;font-size:1.2em;transition:all .3s ease;box-shadow:0 4px 10px rgba(0,0,0,.1);text-align:center;display:flex;flex-direction:column;align-items:center;gap:8px}
      .choice-btn:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.15)}
      .exemplars-choice{background-color:#e3f2fd;color:#1565c0;border:2px solid #2196f3}
      .exemplars-choice:hover{background-color:#bbdefb;border-color:#1976d2}
      .practice-choice{background-color:#e8f5e8;color:#2e7d32;border:2px solid #4caf50}
      .practice-choice:hover{background-color:#c8e6c9;border-color:#388e3c}
      .choice-description{font-size:0.9em;font-weight:400;opacity:0.8;font-style:italic}

      /* Teacher View Banner Styles */
      .teacher-banner{position:fixed;bottom:0;left:0;right:0;background-color:#dc3545;color:white;padding:10px 20px;text-align:center;font-family:'Nunito',sans-serif;font-weight:600;z-index:1000;box-shadow:0 -2px 10px rgba(0,0,0,0.2)}
      .teacher-banner button{background-color:white;color:#dc3545;border:none;padding:8px 16px;border-radius:20px;font-weight:600;cursor:pointer;margin-left:15px;transition:all .2s ease}
      .teacher-banner button:hover{background-color:#f8f9fa;transform:translateY(-1px)}

      /* Learning Portfolio Styles */
      #learning-portfolio-screen{text-align:center}
      .portfolio-unit-status{font-family:'Nunito',sans-serif;font-size:0.9em;color:#6c757d}
      
      /* Unit Portfolio Screen Styles */
      #unit-portfolio-screen{text-align:center}
      .learning-target-item{background-color:#f8f9fa;border-radius:10px;padding:1.5em;margin:1em 0;border:1px solid #dee2e6;text-align:left}
      .target-title{font-family:'Patrick Hand',cursive;font-size:1.3em;color:#2c3e50;margin-bottom:0.5em}
      .target-description{font-family:'Nunito',sans-serif;font-size:1em;color:#495057;margin-bottom:1em;line-height:1.4}
      .proficiency-selector{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
      .proficiency-selector label{font-family:'Nunito',sans-serif;font-weight:600;margin-right:15px;color:#495057}
      .proficiency-option{display:flex;align-items:center;margin-right:20px;cursor:pointer}
      .proficiency-option input[type="radio"]{margin-right:8px;transform:scale(1.2)}
      .proficiency-option span{font-family:'Nunito',sans-serif;font-size:0.9em;padding:4px 12px;border-radius:15px;transition:all .2s ease}
      .proficiency-not-started{background-color:#e9ecef;color:#6c757d}
      .proficiency-developing{background-color:#fff3cd;color:#856404}
      .proficiency-proficient{background-color:#d1ecf1;color:#0c5460}
      .proficiency-mastered{background-color:#d1e7dd;color:#0f5132}
      
      /* Portfolio Toggle Styles */
      .portfolio-toggle-wrapper{position:absolute;bottom:8px;right:8px;z-index:10}
      .portfolio-inline-toggle{position:relative;display:inline-block;width:32px;height:18px}
      .portfolio-inline-toggle input{opacity:0;width:0;height:0}
      .portfolio-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.2s;border-radius:18px}
      .portfolio-slider:before{position:absolute;content:"";height:14px;width:14px;left:2px;bottom:2px;background-color:white;transition:.2s;border-radius:50%}
      .portfolio-inline-toggle input:checked + .portfolio-slider{background-color:#28a745}
      .portfolio-inline-toggle input:checked + .portfolio-slider:before{transform:translateX(14px)}

      /* Three-Phase Proficiency Styles */
      .proficiency-phases-container{display:flex;flex-direction:column;gap:30px;margin-top:20px}
      .proficiency-phase-section{background-color:#f8f9fa;border-radius:15px;padding:25px;border:2px solid #dee2e6;position:relative}
      .phase-header{text-align:center;margin-bottom:20px;position:relative}
      .phase-title{font-family:'Patrick Hand',cursive;font-size:2em;color:#2c3e50;margin:0;text-shadow:1px 1px 2px rgba(0,0,0,0.1)}
      .phase-subtitle{font-family:'Nunito',sans-serif;font-size:1em;color:#6c757d;margin-top:5px;font-style:italic}
      .phase-beginning{border-color:#ffc107;background-color:#fff8e1}
      .phase-beginning .phase-title{color:#f57c00}
      .phase-middle{border-color:#17a2b8;background-color:#e3f2fd}
      .phase-middle .phase-title{color:#0277bd}
      .phase-end{border-color:#28a745;background-color:#e8f5e8}
      .phase-end .phase-title{color:#2e7d32}
      .phase-targets-grid{display:grid;gap:15px}
      .phase-learning-target{background-color:#fff;border-radius:10px;padding:15px;border:1px solid #e0e0e0;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
      .phase-target-title{font-family:'Patrick Hand',cursive;font-size:1.2em;color:#2c3e50;margin-bottom:8px;font-weight:bold}
      .phase-target-description{font-family:'Nunito',sans-serif;font-size:0.95em;color:#495057;margin-bottom:12px;line-height:1.4}
      .phase-proficiency-selector{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
      .phase-proficiency-selector select{font-family:'Nunito',sans-serif;padding:8px 12px;border:2px solid #dee2e6;border-radius:8px;background-color:#fff;color:#495057;font-size:0.9em;cursor:pointer;transition:all .2s ease;min-width:140px}
      .phase-proficiency-selector select:focus{outline:none;border-color:#007bff;box-shadow:0 0 5px rgba(0,123,255,0.3)}
      .phase-proficiency-selector select option{padding:5px}
      .phase-save-indicator{position:absolute;top:15px;right:15px;font-size:0.8em;color:#28a745;opacity:0;transition:opacity .3s ease}
      .phase-save-indicator.visible{opacity:1}

      /* Unit 1 Grid Table Styles */
      .unit1-proficiency-table {
        font-family: 'Nunito', sans-serif;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      .unit1-proficiency-table .target-row {
        transition: background-color 0.2s ease;
      }
      .unit1-proficiency-table .target-row:hover {
        background-color: #f8f9fa;
      }
      .unit1-proficiency-table .target-name {
        padding: 15px;
        border: 1px solid #dee2e6;
        vertical-align: top;
        background-color: #fff;
        min-width: 200px;
      }
      .unit1-proficiency-table .target-title {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.1em;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
      }
      .unit1-proficiency-table .phase-cell {
        padding: 15px;
        border: 1px solid #dee2e6;
        text-align: center;
        vertical-align: middle;
        width: 150px;
      }
      .unit1-proficiency-table select {
        font-family: 'Nunito', sans-serif;
        font-size: 0.9em;
      }

      /* Independent Reading Button Hover */
      #independent-reading-btn:hover {
        background-color: #e1bee7 !important;
        border-color: #8e24aa !important;
      }
      /* MCA Practice Button Hover */
      #mca-practice-btn:hover {
        background-color: #ffe0b2 !important;
        border-color: #f57c00 !important;
      }

      /* Independent Reading Styles */
      .ir-semester-section {
        background-color: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        border: 2px solid #dee2e6;
      }
      .ir-semester-title {
        font-family: 'Patrick Hand', cursive;
        font-size: 2em;
        color: #2c3e50;
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #7b1fa2;
        padding-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }
      .ir-semester-title:hover {
        color: #7b1fa2;
      }
      .ir-semester-title::after {
        content: '▼';
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        transition: transform 0.3s ease;
        font-size: 0.7em;
      }
      .ir-semester-title.collapsed::after {
        transform: translateY(-50%) rotate(-90deg);
      }
      .ir-semester-content {
        transition: all 0.3s ease;
        max-height: 2000px;
        overflow: hidden;
      }
      .ir-semester-content.collapsed {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        margin-top: 0;
        margin-bottom: 0;
      }
      .ir-book-info {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
      }
      .ir-reflections h4 {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.5em;
        color: #2c3e50;
        margin-bottom: 15px;
        text-align: center;
      }
      .ir-reflection-item {
        background-color: #fff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .ir-reflection-item h5 {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.3em;
        color: #7b1fa2;
        margin-bottom: 15px;
        text-align: center;
      }
      .ir-reflection-fields {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }
      .ir-reflection-fields .form-group {
        margin-bottom: 0;
      }
      .save-reflection-btn {
        font-family: 'Nunito', sans-serif;
        font-weight: 700;
        color: #fff;
        background-color: #7b1fa2;
        border: none;
        padding: 12px 24px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all .2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,.1);
        display: block;
        margin: 15px auto 0;
      }
      .save-reflection-btn:hover {
        background-color: #6a1b9a;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,.15);
      }
      .save-reflection-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
      }
      
      /* Teacher IR View Styles */
      .teacher-ir-student {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
      }
      .teacher-ir-student-name {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.4em;
        color: #2c3e50;
        margin-bottom: 10px;
      }
      .teacher-ir-book {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #7b1fa2;
      }
      .teacher-ir-book-title {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
      }
      .teacher-ir-reflection {
        background-color: #f0f8ff;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        font-size: 0.9em;
      }
      .teacher-ir-reflection-header {
        font-weight: bold;
        color: #7b1fa2;
        margin-bottom: 5px;
      }
      
      /* Teacher Dashboard Styles */
      .ir-teacher-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }
      .ir-view-toggle {
        font-family: 'Nunito', sans-serif;
        font-weight: 600;
        color: #fff;
        background-color: #6c757d;
        border: none;
        padding: 12px 24px;
        border-radius: 50px;
        cursor: pointer;
        transition: all .2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,.1);
      }
      .ir-view-toggle.active {
        background-color: #7b1fa2;
      }
      .ir-view-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,.15);
      }
      .ir-dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .ir-stat-card {
        background-color: #fff;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .ir-stat-number {
        font-family: 'Patrick Hand', cursive;
        font-size: 3em;
        color: #7b1fa2;
        margin: 0;
      }
      .ir-stat-label {
        font-family: 'Nunito', sans-serif;
        color: #6c757d;
        margin-top: 5px;
      }
      .ir-student-table {
        background-color: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .ir-student-table table {
        width: 100%;
        border-collapse: collapse;
      }
      .ir-student-table th {
        background-color: #7b1fa2;
        color: #fff;
        padding: 15px;
        font-family: 'Nunito', sans-serif;
        font-weight: 600;
        text-align: left;
      }
      .ir-student-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #dee2e6;
        font-family: 'Nunito', sans-serif;
      }
      .ir-student-table tr:hover {
        background-color: #f8f9fa;
      }
      .ir-progress-bar {
        background-color: #e9ecef;
        border-radius: 10px;
        height: 20px;
        overflow: hidden;
        position: relative;
      }
      .ir-progress-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 0.8em;
        font-weight: bold;
      }
      .ir-progress-semester1 {
        background-color: #28a745;
      }
      .ir-progress-semester2 {
        background-color: #007bff;
      }
      .ir-status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
        color: #fff;
      }
      .ir-status-not-started {
        background-color: #6c757d;
      }
      .ir-status-in-progress {
        background-color: #ffc107;
        color: #212529;
      }
      .ir-status-completed {
        background-color: #28a745;
      }

      /* Teacher Independent Reading Modal Styles */
      .ir-teacher-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .ir-teacher-modal.show {
        display: flex;
      }
      .ir-teacher-modal-content {
        background-color: #fff;
        border-radius: 15px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
      }
      .ir-teacher-modal h3 {
        font-family: 'Patrick Hand', cursive;
        font-size: 2em;
        color: #2c3e50;
        margin-bottom: 20px;
      }
      .ir-teacher-modal-buttons {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
      }
      .ir-teacher-modal-btn {
        font-family: 'Nunito', sans-serif;
        font-weight: 600;
        border: none;
        padding: 15px 25px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1.1em;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .ir-teacher-modal-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
      }
      /* Grammar Practice Modal Button Styles - Match Learning Targets */
      .ir-modal-student-view {
        background-color: #28a745;
        color: #fff;
        border: none;
      }
      .ir-modal-student-view:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,.15);
      }
      .ir-modal-dashboard {
        background-color: #007bff;
        color: #fff;
        border: none;
      }
      .ir-modal-dashboard:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,.15);
      }
      .ir-modal-edit-mca {
        background-color: #6f42c1;
        color: #fff;
        border: none;
      }
      .ir-modal-edit-mca:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,.15);
      }
      .ir-modal-teach-exemplars {
        background-color: #fd7e14;
        color: #fff;
        border: none;
      }
      .ir-modal-teach-exemplars:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,.15);
      }
      .ir-modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: #6c757d;
        padding: 5px;
      }
      .ir-modal-close:hover {
        color: #495057;
      }

      /* Independent Reading Semester Choice Styles */
      .ir-semester1-choice {
        background-color: #e3f2fd;
        color: #1565c0;
        border: 2px solid #2196f3;
      }
      .ir-semester1-choice:hover {
        background-color: #bbdefb;
        border-color: #1976d2;
      }
      .ir-semester2-choice {
        background-color: #fff3e0;
        color: #e65100;
        border: 2px solid #ff9800;
      }
      .ir-semester2-choice:hover {
        background-color: #ffe0b2;
        border-color: #f57c00;
      }

      /* Dynamic Body Background Colors - Using Darker Border Colors */
      body.body-learning-portfolio {
        background-color: #2196f3 !important;
      }
      body.body-grammar-practice {
        background-color: #4caf50 !important;
      }
      body.body-independent-reading {
        background-color: #9c27b0 !important;
      }
      body.body-mca-practice {
        background-color: #ff9800 !important;
      }
      body.body-default {
        background-color: #87CEEB !important;
      }
      body.body-standards {
        background-color: #faf9f7 !important;
      }

      /* State Standards Alignment Styles */
      #standards-alignment-screen {
        text-align: center;
        padding: 0 20px;
        max-width: 1600px;
        margin: 0 auto;
      }

      /* Modern Header Design */
      .standards-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }

      .standards-header h1 {
        margin: 0 0 20px 0;
        font-size: 2.5em;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      }

      .standards-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .summary-stat {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        transition: transform 0.2s ease;
      }

      .summary-stat:hover {
        transform: translateY(-3px);
      }

      .stat-number {
        display: block;
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .stat-label {
        display: block;
        font-size: 0.9em;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .summary-stat.covered .stat-number { color: #4caf50; }
      .summary-stat.partial .stat-number { color: #ff9800; }
      .summary-stat.not-covered .stat-number { color: #f44336; }
      
      .standards-nav {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }
      
      .standards-nav-btn {
        font-family: 'Nunito', sans-serif;
        font-weight: 600;
        padding: 12px 24px;
        border: 2px solid #f9a825;
        background-color: #fff;
        color: #f57f17;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1em;
      }
      
      .standards-nav-btn:hover {
        background-color: #f9a825;
        color: #fff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(249, 168, 37, 0.3);
      }
      
      .standards-nav-btn.active {
        background-color: #f9a825;
        color: #fff;
        box-shadow: 0 2px 4px rgba(249, 168, 37, 0.2);
      }

      /* Standards Stats Grid */
      .standards-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .standards-stat-card {
        background-color: #fff;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        border: 2px solid #f9a825;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
      }
      
      .standards-stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
      }
      
      .standards-stat-number {
        font-family: 'Patrick Hand', cursive;
        font-size: 3em;
        margin: 0;
        color: #f57f17;
      }
      
      .standards-stat-label {
        font-family: 'Nunito', sans-serif;
        color: #6c757d;
        margin-top: 8px;
        font-size: 1em;
      }

      /* Unit Summary Grid */
      .unit-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }
      
      .unit-summary-card {
        background-color: #fff;
        border-radius: 12px;
        padding: 20px;
        border: 2px solid #f9a825;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease;
      }
      
      .unit-summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }
      
      .unit-summary-title {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.4em;
        color: #f57f17;
        margin-bottom: 10px;
        text-align: center;
      }
      
      .unit-summary-count {
        font-family: 'Nunito', sans-serif;
        font-size: 2em;
        color: #f9a825;
        text-align: center;
        margin: 10px 0;
      }
      
      .unit-summary-status {
        font-family: 'Nunito', sans-serif;
        font-size: 0.9em;
        color: #6c757d;
        text-align: center;
      }

      /* Categories Breakdown */
      .categories-breakdown {
        margin: 40px 0;
      }
      
      .categories-breakdown h3 {
        font-family: 'Patrick Hand', cursive;
        font-size: 2em;
        color: #f57f17;
        text-align: center;
        margin-bottom: 20px;
      }
      
      .categories-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      
      .category-stat-card {
        background-color: #fff9c4;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        border: 1px solid #f9a825;
        transition: transform 0.2s ease;
      }
      
      .category-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(249, 168, 37, 0.2);
      }
      
      .category-name {
        font-family: 'Nunito', sans-serif;
        font-weight: 600;
        color: #f57f17;
        margin-bottom: 8px;
      }
      
      .category-count {
        font-family: 'Patrick Hand', cursive;
        font-size: 2em;
        color: #f9a825;
        margin: 0;
      }

      /* Standards by Unit View */
      .unit-standards-container {
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .search-filter-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .standards-search-input, .standards-filter-select {
        font-family: 'Nunito', sans-serif;
        padding: 12px 16px;
        border: 2px solid #f9a825;
        border-radius: 25px;
        font-size: 1em;
        background-color: #fff;
        color: #333;
        min-width: 200px;
      }
      
      .standards-search-input:focus, .standards-filter-select:focus {
        outline: none;
        border-color: #f57f17;
        box-shadow: 0 0 5px rgba(245, 127, 23, 0.3);
      }
      
      .unit-standards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
      }
      
      /* Standards Control Styles */
      .standards-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 25px;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }

      /* Table Filter Controls */
      .table-filter-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: center;
        justify-content: space-between;
        margin: 20px 0 30px 0;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 160px;
      }

      .filter-group label {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .filter-select {
        padding: 10px 15px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        background: white;
        color: #2c3e50;
        font-size: 0.95em;
        cursor: pointer;
        transition: all 0.3s ease;
        outline: none;
      }

      .filter-select:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
      }

      .filter-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .results-counter {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        padding: 10px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9em;
        white-space: nowrap;
      }

      /* Enhanced Table Styles */
      .standards-table-view {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-top: 20px;
      }

      .standards-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
      }

      .standards-table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 18px 15px;
        text-align: left;
        font-weight: 600;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
        white-space: nowrap;
      }

      .standards-table th.sortable {
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
      }

      .standards-table th.sortable:hover {
        background: linear-gradient(135deg, #7b8df0 0%, #8657b8 100%);
      }

      .sort-indicator {
        margin-left: 5px;
        font-size: 0.8em;
        opacity: 0.7;
        transition: opacity 0.2s ease;
      }

      .standards-table th.sorted-asc .sort-indicator::after {
        content: " ↑";
        color: #fff;
        font-weight: bold;
      }

      .standards-table th.sorted-desc .sort-indicator::after {
        content: " ↓";
        color: #fff;
        font-weight: bold;
      }

      .standards-table td {
        padding: 15px;
        border-bottom: 1px solid #f8f9fa;
        vertical-align: top;
        transition: background-color 0.2s ease;
      }

      .standards-table tr:hover td {
        background-color: #f8f9fa;
      }

      .standards-table tr:last-child td {
        border-bottom: none;
      }

      .standards-table tbody tr {
        transition: all 0.2s ease;
      }

      .standards-table tbody tr.filtered-out {
        display: none;
      }

      /* Status and Assessment Badges */
      .status-badge, .assessment-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
      }

      .status-badge.covered {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
      }

      .status-badge.not-covered {
        background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
      }

      .status-badge.partial {
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
      }

      .assessment-badge.formative {
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
      }

      .assessment-badge.summative {
        background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(156, 39, 176, 0.3);
      }

      .assessment-badge.both {
        background: linear-gradient(135deg, #ff5722 0%, #d84315 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(255, 87, 34, 0.3);
      }

      .assessment-badge.none {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
      }

      /* Table Loading State */
      .table-loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .table-loading-state p {
        color: #6c757d;
        font-size: 1.1em;
        margin: 0;
      }

      /* Standard Code Styling */
      .standard-code {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #2c3e50;
        font-size: 0.9em;
      }

      /* Standard Description */
      .standard-description {
        line-height: 1.4;
        color: #495057;
      }

      /* List View Styles */
      .standards-list-view {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      }

      .list-item:last-child {
        border-bottom: none;
      }

      /* Keyboard Focus Styles */
      .keyboard-focused {
        position: relative;
      }

      .keyboard-focused::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        border-radius: 15px;
        z-index: -1;
        opacity: 0.3;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .standards-header {
          padding: 20px;
        }
        
        .standards-header h1 {
          font-size: 2em;
        }
        
        .standards-summary {
          grid-template-columns: repeat(2, 1fr);
          gap: 15px;
        }
        
        .unit-buttons-grid {
          grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
          gap: 10px;
        }
        
        .standards-controls {
          flex-direction: column;
          align-items: stretch;
        }
        
        .table-filter-controls {
          flex-direction: column;
          align-items: stretch;
          gap: 15px;
        }

        .filter-group {
          min-width: auto;
        }
        
        .standards-table {
          font-size: 0.85em;
        }
        
        .standards-table th, 
        .standards-table td {
          padding: 10px 8px;
        }
        
        .standards-table th {
          font-size: 0.75em;
        }
        
        /* Make table horizontally scrollable on mobile */
        .standards-table-view {
          overflow-x: auto;
        }
        
        .status-badge, 
        .assessment-badge {
          font-size: 0.7em;
          padding: 4px 8px;
        }
      }

      @media (max-width: 480px) {
        .standards-summary {
          grid-template-columns: 1fr;
        }
        
        .stat-number {
          font-size: 2em;
        }
        
        .unit-buttons-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      
      .search-container {
        position: relative;
        flex: 1;
        min-width: 250px;
      }
      
      .clear-search-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        font-size: 1.2em;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .clear-search-btn:hover {
        background-color: #e9ecef;
        color: #495057;
      }
      
      .filter-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      
      .control-btn {
        padding: 8px 15px;
        border: 2px solid #007bff;
        background-color: #fff;
        color: #007bff;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s ease;
      }
      
      .control-btn:hover {
        background-color: #007bff;
        color: #fff;
      }
      
      #standards-search:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
      }
      
      .unit-standards-card {
        background-color: #fff;
        border-radius: 10px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
        cursor: pointer;
      }
      
      .unit-standards-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.15);
        border-color: #007bff;
      }
      
      .unit-standards-card.selected {
        background-color: #e3f2fd;
        border-color: #007bff;
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
      }
      
      .unit-standards-title {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.2em;
        color: #2c3e50;
        margin-bottom: 8px;
        font-weight: bold;
        text-align: left;
      }
      
      .standards-list {
        max-height: 300px;
        overflow-y: auto;
        text-align: left;
      }
      
      .standard-item {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        border-left: 4px solid #007bff;
        transition: all 0.2s ease;
        position: relative;
        padding-left: 15px;
      }
      
      .standard-item::before {
        content: '\2022';
        position: absolute;
        left: 8px;
        top: 12px;
        color: #007bff;
        font-weight: bold;
      }
      
      .standard-item:hover {
        background: #e9ecef;
        transform: translateX(3px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .standard-code {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        color: #495057;
        font-size: 0.95em;
        background: white;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 5px;
        border: 1px solid #dee2e6;
      }
      
      .standard-description {
        font-family: 'Nunito', sans-serif;
        color: #495057;
        margin: 3px 0;
        line-height: 1.4;
        font-size: 0.85em;
      }

      /* Coverage Analysis Styles */
      .coverage-analysis-container {
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .coverage-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .coverage-stat-card {
        background-color: #fff;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      
      .coverage-stat-number {
        font-family: 'Patrick Hand', cursive;
        font-size: 3em;
        margin: 0;
        color: #007bff;
      }
      
      .coverage-stat-label {
        font-family: 'Nunito', sans-serif;
        color: #6c757d;
        margin-top: 8px;
        font-size: 1em;
      }
      
      .unit-coverage-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .unit-coverage-card {
        background-color: #fff;
        border-radius: 12px;
        padding: 20px;
        border: 2px solid #f9a825;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      
      .unit-coverage-title {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.3em;
        color: #f57f17;
        margin-bottom: 10px;
        text-align: center;
      }
      
      .coverage-details {
        font-family: 'Nunito', sans-serif;
        color: #495057;
        line-height: 1.5;
      }

      /* Duplicate Standards Section */
      .duplicate-standards-section {
        margin-top: 40px;
      }
      
      .duplicate-standards-section h4 {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.8em;
        color: #f57f17;
        text-align: center;
        margin-bottom: 20px;
      }
      
      .duplicate-standards-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
      }
      
      .duplicate-standard-item {
        background-color: #fff9c4;
        border-radius: 10px;
        padding: 15px;
        border: 2px solid #f9a825;
      }
      
      .duplicate-standard-code {
        font-family: 'Nunito', sans-serif;
        font-weight: bold;
        color: #f57f17;
        margin-bottom: 8px;
      }
      
      .duplicate-units-list {
        font-family: 'Nunito', sans-serif;
        color: #495057;
        font-size: 0.9em;
      }

      /* Standards Reference Styles */
      .reference-container {
        max-width: 1000px;
        margin: 0 auto;
      }
      
      .reference-search-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .standards-reference-list {
        text-align: left;
      }
      
      .reference-standard-item {
        background-color: #fff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border: 2px solid #f9a825;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      
      .reference-standard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      
      .reference-standard-code {
        font-family: 'Nunito', sans-serif;
        font-weight: bold;
        color: #f57f17;
        font-size: 1.1em;
      }
      
      .reference-standard-category {
        font-family: 'Nunito', sans-serif;
        background-color: #fff9c4;
        color: #f57f17;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 600;
      }
      
      .reference-standard-description {
        font-family: 'Nunito', sans-serif;
        color: #495057;
        line-height: 1.5;
        margin-bottom: 10px;
      }
      
      .reference-units-covered {
        font-family: 'Nunito', sans-serif;
        color: #6c757d;
        font-size: 0.9em;
        font-style: italic;
      }

      /* General Section Styles */
      .standards-section {
        margin-top: 30px;
      }
      
      .standards-section h3 {
        font-family: 'Patrick Hand', cursive;
        font-size: 2em;
        color: #f57f17;
        text-align: center;
        margin-bottom: 20px;
      }

      /* New Simplified Standards Interface Styles */
      .unit-selector-container {
        margin: 30px 0;
        text-align: center;
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      }

      .unit-selector-container h3 {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.8em;
        color: #2c3e50;
        margin-bottom: 25px;
      }

      .unit-buttons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .unit-selector-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        padding: 15px 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Nunito', sans-serif;
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        color: white;
        position: relative;
        overflow: hidden;
      }

      .unit-selector-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        background: linear-gradient(135deg, #7b8df0 0%, #8657b8 100%);
      }

      .unit-selector-btn.active {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4);
      }

      .unit-selector-btn.loading {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        position: relative;
        overflow: hidden;
      }

      .unit-selector-btn.loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        animation: loading-shimmer 1.5s infinite;
      }

      @keyframes loading-shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      .unit-number {
        font-size: 1.8em;
        font-weight: bold;
        color: white;
        margin-bottom: 3px;
        font-family: 'Patrick Hand', cursive;
      }

      .unit-title {
        font-size: 0.9em;
        font-weight: 600;
        color: white;
        line-height: 1.2;
        opacity: 0.95;
      }

      .standards-coverage-section {
        margin-top: 40px;
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
        background-color: #faf9f7;
        border-radius: 20px;
        padding: 30px;
      }

      .standards-coverage-section h3 {
        font-family: 'Patrick Hand', cursive;
        font-size: 1.8em;
        color: #ad1457;
        text-align: center;
        margin-bottom: 25px;
      }

      .coverage-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background-color: #f5f4f2;
        border-radius: 15px;
        border: 2px solid #007bff;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: 'Nunito', sans-serif;
        font-size: 0.9em;
        font-weight: 600;
      }

      .status-indicator {
        font-size: 1.2em;
      }

      .assessment-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
        color: white;
      }

      .assessment-badge.formative {
        background-color: #2196f3;
      }

      .assessment-badge.summative {
        background-color: #ff9800;
      }

      .assessment-badge.both {
        background: linear-gradient(45deg, #2196f3 50%, #ff9800 50%);
      }

      .standards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .standard-item {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 2px solid #e1e1e1;
        transition: all 0.2s ease;
        position: relative;
      }

      .standard-item.covered {
        border-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
      }

      .standard-item.not-covered {
        border-color: #e0e0e0;
        background: #fafafa;
        opacity: 0.7;
      }

      .standard-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .standard-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .standard-code {
        font-family: 'Nunito', sans-serif;
        font-weight: bold;
        font-size: 1.1em;
        color: #ad1457;
      }

      .standard-status {
        font-size: 1.3em;
      }

      .standard-description {
        font-family: 'Nunito', sans-serif;
        font-size: 0.95em;
        line-height: 1.4;
        color: #333;
        margin-bottom: 15px;
      }

      .assessment-info {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .assessment-info .assessment-badge {
        font-size: 0.8em;
        padding: 4px 10px;
      }

      /* New grouped standards layout styles */
      .standards-section-group {
        margin-bottom: 35px;
      }

      .section-header {
        background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
        border: 2px solid #4caf50;
        border-radius: 12px;
        padding: 15px 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
      }

      .not-covered-section .section-header {
        background: linear-gradient(135deg, #f5f5f5 0%, #eeeeee 100%);
        border-color: #9e9e9e;
        box-shadow: 0 2px 8px rgba(158, 158, 158, 0.1);
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-family: 'Patrick Hand', cursive;
        font-size: 1.4em;
        font-weight: bold;
        color: #2e7d32;
      }

      .not-covered-section .section-title {
        color: #616161;
      }

      .section-icon {
        font-size: 1.2em;
      }

      .section-name {
        flex-grow: 1;
      }

      .section-count {
        background-color: #4caf50;
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.85em;
        font-family: 'Nunito', sans-serif;
        font-weight: 600;
      }

      .not-covered-section .section-count {
        background-color: #9e9e9e;
      }

      .collapsible-header {
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .collapsible-header:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(158, 158, 158, 0.15);
      }

      .toggle-icon {
        font-size: 0.8em;
        margin-left: 8px;
        transition: transform 0.2s ease;
      }

      .section-standards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .section-standards-grid.collapsed {
        display: none;
      }

      .covered-section .standard-item {
        border-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
        box-shadow: 0 3px 10px rgba(76, 175, 80, 0.1);
      }

      .covered-section .standard-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
      }

      .not-covered-section .standard-item {
        opacity: 0.6;
        border-color: #e0e0e0;
        background: #f9f9f9;
      }

      .not-covered-text {
        font-style: italic;
        color: #757575;
        font-size: 0.9em;
      }

      .assessment-badge.unspecified {
        background-color: #607d8b;
      }

      /* Enhanced assessment badge styling for grouped view */
      .covered-section .assessment-badge {
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Assessment Type Section Styles */
      .assessment-type-section {
        margin-bottom: 40px;
        border: 2px solid #2196f3;
        border-radius: 15px;
        padding: 20px;
        background: linear-gradient(135deg, #faf9f7 0%, #f5f4f2 100%);
      }

      .both-section {
        border-color: #4caf50;
        background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
      }

      .summative-section {
        border-color: #dc3545;
        background: linear-gradient(135deg, #ffebee 0%, #fde7e9 100%);
      }

      .formative-section {
        border-color: #28a745;
        background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);
      }

      .assessment-type-header {
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid;
      }

      .both-section .assessment-type-header {
        border-bottom-color: #4caf50;
      }

      .summative-section .assessment-type-header {
        border-bottom-color: #dc3545;
      }

      .formative-section .assessment-type-header {
        border-bottom-color: #28a745;
      }

      .assessment-type-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-family: 'Patrick Hand', cursive;
        font-size: 1.6em;
        font-weight: bold;
        color: #1565c0;
      }

      .assessment-icon {
        font-size: 1.3em;
      }

      .assessment-name {
        flex-grow: 1;
      }

      .assessment-count {
        background-color: #2196f3;
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8em;
        font-family: 'Nunito', sans-serif;
        font-weight: 600;
      }

      .standards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .standard-item {
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
        border: 1px solid #e1e8ed;
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
      }

      .standard-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
      }

      .standard-item.covered {
        border-left: 4px solid #4caf50;
        background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);
      }

      .standard-item.not-covered {
        border-left: 4px solid #f44336;
        background: linear-gradient(135deg, #fff3e0 0%, #ffebee 100%);
      }

      .standard-item.partial {
        border-left: 4px solid #ff9800;
        background: linear-gradient(135deg, #fff8e1 0%, #fff3c4 100%);
      }

      .standard-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .standard-code {
        font-family: 'Nunito', sans-serif;
        font-weight: bold;
        font-size: 1.1em;
        color: #1565c0;
      }

      .standard-status {
        font-size: 1.2em;
      }

      .standard-description {
        font-family: 'Nunito', sans-serif;
        font-size: 0.95em;
        line-height: 1.4;
        color: #333;
        margin-bottom: 12px;
      }

      .standard-meta {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .assessment-badge {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: 600;
        color: white;
      }

      .both-badge {
        background-color: #4caf50;
      }

      .summative-badge {
        background-color: #dc3545;
      }

      .formative-badge {
        background-color: #28a745;
      }

      .anchor-strand-tag {
        background-color: #e3f2fd;
        color: #1565c0;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 500;
        border: 1px solid #bbdefb;
      }

      .no-standards-message {
        text-align: center;
        font-family: 'Nunito', sans-serif;
        font-size: 1.2em;
        color: #666;
        padding: 40px;
        background: #f5f5f5;
        border-radius: 10px;
        border: 2px dashed #ccc;
      }

      /* Button Styles */
      #try-again-btn,#main-menu-btn,#back-to-home-btn,#register-btn,#back-to-units-btn,#back-to-units-from-results-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;border:none;padding:12px 24px;border-radius:50px;cursor:pointer;margin-top:10px;transition:all .2s ease;box-shadow:0 2px 5px rgba(0,0,0,.1)}
      #try-again-btn:hover,#main-menu-btn:hover,#back-to-home-btn:hover,#register-btn:hover,#back-to-units-btn:hover,#back-to-units-from-results-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
      #try-again-btn{background-color:#198754;margin-right:10px}
      #main-menu-btn,#back-to-home-btn,#back-to-units-btn,#back-to-units-from-results-btn{background-color:#6c757d}
      #register-btn{background-color:#0d6efd}

      /* Common Styles */
      .loading-indicator{padding:40px;text-align:center}
      .spinner{border:8px solid #f3f3f3;border-radius:50%;border-top:8px solid #3498db;width:60px;height:60px;animation:spin 1s linear infinite;margin:0 auto 20px}
      @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
      .form-group{margin-bottom:1.5em;text-align:left}.form-group label{display:block;margin-bottom:.5em;font-weight:700}.form-group input,.form-group select{width:100%;padding:10px;border-radius:5px;border:1px solid #ccc;font-size:1em;box-sizing: border-box;}
    </style>
  </head>
  <body>
    <div class="container">
      <h1>English 9 Learning Hub</h1>
      
      <!-- Main Landing Screen -->
      <div id="main-landing-screen">
        <h2 id="main-welcome-message">Welcome to English 9</h2>
        <div class="choice-container">
          <p>What would you like to do today?</p>
          <div class="choice-buttons">
            <button id="learning-portfolio-btn" class="choice-btn exemplars-choice">
              📚 Learning Portfolio
              <span class="choice-description">Track your progress and proficiency levels</span>
            </button>
            <button id="grammar-practice-btn" class="choice-btn practice-choice">
              🎯 Grammar Practice
              <span class="choice-description">Practice grammar concepts with interactive quizzes</span>
            </button>
            <button id="independent-reading-btn" class="choice-btn" style="background-color:#f3e5f5; color:#7b1fa2; border:2px solid #9c27b0;">
              📖 Independent Reading
              <span class="choice-description">Track your independent reading progress</span>
            </button>
            <button id="mca-practice-btn" class="choice-btn" style="background-color:#fff3e0; color:#e65100; border:2px solid #ff9800;">
              📝 MCA Practice
              <span class="choice-description">Practice MCA test questions by unit</span>
            </button>
            <button id="standards-alignment-btn" class="choice-btn hidden" style="background-color:#faf9f7; color:#5d4e37; border:2px solid #8d6e63;">
              📊 State Standards Alignment
              <span class="choice-description">View curriculum standards coverage and alignment</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Shared Unit Selection Screen -->
      <div id="unit-selection-screen" class="hidden">
        <h2 id="welcome-message">Choose a Unit to Practice</h2>
        <div id="unit-grid">Loading units...</div>
        <button id="back-to-main-btn" class="exemplar-nav-btn" style="margin-top: 20px;">← Back to Main Menu</button>
      </div>
      <!-- MCA Unit Selection Screen -->
      <div id="mca-unit-selection-screen" class="hidden">
        <h2 id="mca-welcome-message">Choose a Unit for MCA Practice</h2>
        <div id="mca-unit-grid">Loading MCA units...</div>
        <button id="back-to-main-from-mca-btn" class="exemplar-nav-btn" style="margin-top: 20px;">← Back to Main Menu</button>
      </div>

      <!-- Learning Portfolio Unit Selection Screen -->
      <div id="learning-portfolio-screen" class="hidden">
        <h2 id="portfolio-welcome-message">Learning Portfolio - Choose a Unit</h2>
        <p>Track your learning progress and set proficiency goals for each unit.</p>
        
        <div id="portfolio-unit-grid">Loading portfolio...</div>
        <button id="back-to-main-from-portfolio-btn" class="exemplar-nav-btn" style="margin-top: 20px;">← Back to Main Menu</button>
      </div>

      <!-- Learning Portfolio Teacher Choice Screen -->
      <div id="portfolio-teacher-choice-screen" class="hidden">
        <h2>Learning Portfolio - <span id="portfolio-choice-unit-title">Unit</span></h2>
        <p>Choose how you'd like to interact with this unit's learning targets.</p>
        
        <div class="choice-container">
          <div class="choice-buttons">
            <button id="portfolio-view-as-student-btn" class="choice-btn exemplars-choice">
              <span style="font-size: 2em;">👤</span>
              <span style="font-size: 1.2em; font-weight: bold;">View as Student</span>
              <span style="font-size: 0.9em; color: #666;">See the learning targets interface as students do</span>
            </button>
            
            <button id="portfolio-teacher-dashboard-btn" class="choice-btn practice-choice">
              <span style="font-size: 2em;">📊</span>
              <span style="font-size: 1.2em; font-weight: bold;">View Dashboard</span>
              <span style="font-size: 0.9em; color: #666;">See student progress and proficiency data</span>
            </button>
            
            <button id="portfolio-edit-targets-btn" class="choice-btn" style="background-color: #f3e5f5; color: #6a1b9a; border: 2px solid #9c27b0;">
              <span style="font-size: 2em;">✏️</span>
              <span style="font-size: 1.2em; font-weight: bold;">Edit Learning Targets</span>
              <span style="font-size: 0.9em; color: #666;">Modify the learning targets for this unit</span>
            </button>
          </div>
          
          <button id="back-to-portfolio-units-btn" class="exemplar-nav-btn" style="margin-top: 20px;">← Back to Unit Selection</button>
        </div>
      </div>

      <!-- Individual Unit Portfolio Screen -->
      <div id="unit-portfolio-screen" class="hidden">
        <h2 id="unit-portfolio-title">Unit Portfolio</h2>
        <div id="learning-targets-container">
          <div id="loading-targets" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading learning targets...</p>
          </div>
          <div id="targets-content"></div>
        </div>
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
          <button id="back-to-portfolio-btn" class="exemplar-nav-btn">← Back to Portfolio</button>
          <button id="save-portfolio-btn" class="got-it-btn">💾 Save Progress</button>
        </div>
      </div>

      <!-- Learning Portfolio Teacher Dashboard Screen -->
      <div id="portfolio-teacher-dashboard-screen" class="hidden">
        <h2>Learning Portfolio Dashboard - <span id="dashboard-unit-title">Unit</span></h2>
        <p>View student progress and proficiency data for learning targets.</p>
        
        <div id="portfolio-dashboard-content">
          <div id="loading-dashboard" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading student data...</p>
          </div>
          <div id="dashboard-results-container" class="hidden">
            <table id="portfolio-dashboard-table">
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Learning Target</th>
                  <th>Phase</th>
                  <th>Proficiency Level</th>
                  <th>Last Updated</th>
                </tr>
              </thead>
              <tbody id="dashboard-table-body">
                <!-- Student data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
          <button id="back-to-portfolio-choice-btn" class="exemplar-nav-btn">← Back to Options</button>
          <button id="export-dashboard-btn" class="got-it-btn">📁 Export Data</button>
        </div>
      </div>

      <!-- Learning Portfolio Edit Targets Screen -->
      <div id="portfolio-edit-targets-screen" class="hidden">
        <h2>Edit Learning Targets - <span id="edit-targets-unit-title">Unit</span></h2>
        <p>Add, edit, or remove learning targets for this unit.</p>
        
        <div id="edit-targets-content">
          <div id="loading-edit-targets" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading learning targets...</p>
          </div>
          <div id="edit-targets-container" class="hidden">
            <div id="existing-targets-list">
              <!-- Existing targets will be populated here -->
            </div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
              <h3>Add New Learning Target</h3>
              <div style="display: flex; flex-direction: column; gap: 15px; max-width: 600px; margin: 0 auto;">
                <input type="text" id="new-target-text" placeholder="Enter learning target description..." style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                <div style="display: flex; gap: 10px; align-items: center;">
                  <label style="font-weight: bold;">Phases:</label>
                  <label><input type="checkbox" id="new-target-beginning" checked> Beginning</label>
                  <label><input type="checkbox" id="new-target-middle" checked> Middle</label>
                  <label><input type="checkbox" id="new-target-end" checked> End</label>
                  <label><input type="checkbox" id="new-target-single"> Single Phase</label>
                </div>
                <button id="add-new-target-btn" class="got-it-btn" style="align-self: flex-start;">+ Add Target</button>
              </div>
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
          <button id="back-to-portfolio-choice-from-edit-btn" class="exemplar-nav-btn">← Back to Options</button>
          <button id="save-targets-changes-btn" class="got-it-btn">💾 Save All Changes</button>
        </div>
      </div>

      <!-- Independent Reading Screen -->
      <div id="independent-reading-screen" class="hidden">
        <h2>Independent Reading</h2>
        <p>Track your independent reading progress and reflections throughout the year.</p>
        
        <div id="independent-reading-content">
          <div id="loading-ir" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading independent reading data...</p>
          </div>
          
          <!-- Teacher Controls -->
          <div id="teacher-ir-controls" class="hidden ir-teacher-controls">
            <button id="ir-dashboard-btn" class="ir-view-toggle active">📊 Dashboard</button>
            <button id="ir-student-view-btn" class="ir-view-toggle">👤 Student View</button>
          </div>
          
          <!-- Teacher Dashboard -->
          <div id="ir-dashboard-container" class="hidden">
            <div id="ir-dashboard-stats" class="ir-dashboard-stats">
              <!-- Stats cards will be populated by JavaScript -->
            </div>
            <div id="ir-student-progress-table" class="ir-student-table">
              <!-- Student progress table will be populated by JavaScript -->
            </div>
          </div>
          
          <!-- Semester Sections -->
          <div id="ir-semesters-container" class="hidden">
            <!-- Semester 1 -->
            <div class="ir-semester-section">
              <h3 class="ir-semester-title" onclick="toggleSemester('semester1')">Semester 1</h3>
              <div id="semester1-content" class="ir-semester-content">
                <div class="ir-book-info">
                <div class="form-group">
                  <label for="s1-book-title">Book Title:</label>
                  <input type="text" id="s1-book-title" placeholder="Enter the title of your book">
                </div>
                <div class="form-group">
                  <label for="s1-book-author">Author:</label>
                  <input type="text" id="s1-book-author" placeholder="Enter the author's name">
                </div>
              </div>
              
              <div class="ir-reflections">
                <h4>Reading Reflections</h4>
                <!-- Reflection 1 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 1</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s1-r1-date">Date:</label>
                      <input type="date" id="s1-r1-date">
                    </div>
                    <div class="form-group">
                      <label for="s1-r1-pages-read">Pages Read:</label>
                      <input type="number" id="s1-r1-pages-read" placeholder="150">
                    </div>
                    <div class="form-group">
                      <label for="s1-r1-total-pages">Total Pages:</label>
                      <input type="number" id="s1-r1-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s1-r1-text">Reflection:</label>
                    <textarea id="s1-r1-text" rows="4" placeholder="Write your thoughts about the book so far..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 1', 0)">💾 Save Reflection 1</button>
                </div>
                
                <!-- Reflection 2 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 2</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s1-r2-date">Date:</label>
                      <input type="date" id="s1-r2-date">
                    </div>
                    <div class="form-group">
                      <label for="s1-r2-pages-read">Pages Read:</label>
                      <input type="number" id="s1-r2-pages-read" placeholder="250">
                    </div>
                    <div class="form-group">
                      <label for="s1-r2-total-pages">Total Pages:</label>
                      <input type="number" id="s1-r2-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s1-r2-text">Reflection:</label>
                    <textarea id="s1-r2-text" rows="4" placeholder="Write your thoughts about the book so far..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 1', 1)">💾 Save Reflection 2</button>
                </div>
                
                <!-- Reflection 3 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 3</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s1-r3-date">Date:</label>
                      <input type="date" id="s1-r3-date">
                    </div>
                    <div class="form-group">
                      <label for="s1-r3-pages-read">Pages Read:</label>
                      <input type="number" id="s1-r3-pages-read" placeholder="300">
                    </div>
                    <div class="form-group">
                      <label for="s1-r3-total-pages">Total Pages:</label>
                      <input type="number" id="s1-r3-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s1-r3-text">Reflection:</label>
                    <textarea id="s1-r3-text" rows="4" placeholder="Write your final thoughts about the book..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 1', 2)">💾 Save Reflection 3</button>
                </div>
              </div>
              </div>
            </div>
            
            <!-- Semester 2 -->
            <div class="ir-semester-section">
              <h3 class="ir-semester-title" onclick="toggleSemester('semester2')">Semester 2</h3>
              <div id="semester2-content" class="ir-semester-content">
                <div class="ir-book-info">
                <div class="form-group">
                  <label for="s2-book-title">Book Title:</label>
                  <input type="text" id="s2-book-title" placeholder="Enter the title of your book">
                </div>
                <div class="form-group">
                  <label for="s2-book-author">Author:</label>
                  <input type="text" id="s2-book-author" placeholder="Enter the author's name">
                </div>
              </div>
              
              <div class="ir-reflections">
                <h4>Reading Reflections</h4>
                <!-- Reflection 1 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 1</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s2-r1-date">Date:</label>
                      <input type="date" id="s2-r1-date">
                    </div>
                    <div class="form-group">
                      <label for="s2-r1-pages-read">Pages Read:</label>
                      <input type="number" id="s2-r1-pages-read" placeholder="150">
                    </div>
                    <div class="form-group">
                      <label for="s2-r1-total-pages">Total Pages:</label>
                      <input type="number" id="s2-r1-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s2-r1-text">Reflection:</label>
                    <textarea id="s2-r1-text" rows="4" placeholder="Write your thoughts about the book so far..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 2', 0)">💾 Save Reflection 1</button>
                </div>
                
                <!-- Reflection 2 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 2</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s2-r2-date">Date:</label>
                      <input type="date" id="s2-r2-date">
                    </div>
                    <div class="form-group">
                      <label for="s2-r2-pages-read">Pages Read:</label>
                      <input type="number" id="s2-r2-pages-read" placeholder="250">
                    </div>
                    <div class="form-group">
                      <label for="s2-r2-total-pages">Total Pages:</label>
                      <input type="number" id="s2-r2-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s2-r2-text">Reflection:</label>
                    <textarea id="s2-r2-text" rows="4" placeholder="Write your thoughts about the book so far..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 2', 1)">💾 Save Reflection 2</button>
                </div>
                
                <!-- Reflection 3 -->
                <div class="ir-reflection-item">
                  <h5>Reflection 3</h5>
                  <div class="ir-reflection-fields">
                    <div class="form-group">
                      <label for="s2-r3-date">Date:</label>
                      <input type="date" id="s2-r3-date">
                    </div>
                    <div class="form-group">
                      <label for="s2-r3-pages-read">Pages Read:</label>
                      <input type="number" id="s2-r3-pages-read" placeholder="300">
                    </div>
                    <div class="form-group">
                      <label for="s2-r3-total-pages">Total Pages:</label>
                      <input type="number" id="s2-r3-total-pages" placeholder="300">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="s2-r3-text">Reflection:</label>
                    <textarea id="s2-r3-text" rows="4" placeholder="Write your final thoughts about the book..."></textarea>
                  </div>
                  <button class="save-reflection-btn" onclick="saveReflection('Semester 2', 2)">💾 Save Reflection 3</button>
                </div>
              </div>
              </div>
            </div>
          </div>
        </div>
        
        <button id="back-to-main-from-reading-btn" class="exemplar-nav-btn" style="margin-top: 20px;">← Back to Main Menu</button>
      </div>

      <!-- Teacher Independent Reading Modal -->
      <div id="ir-teacher-modal" class="ir-teacher-modal">
        <div class="ir-teacher-modal-content">
          <button class="ir-modal-close" onclick="closeIRTeacherModal()">✕</button>
          <h3>📖 Independent Reading</h3>
          <p>Choose how you'd like to view Independent Reading:</p>
          <div class="ir-teacher-modal-buttons">
            <button class="ir-teacher-modal-btn ir-modal-student-view" onclick="irModalSelectOption('student-view')">
              👤 View as Student
            </button>
            <button class="ir-teacher-modal-btn ir-modal-dashboard" onclick="irModalSelectOption('dashboard')">
              📊 View Dashboard
            </button>
            <button class="ir-teacher-modal-btn ir-modal-edit-mca" onclick="irModalSelectOption('edit-ir')">
              ✏️ Edit Independent Reading
            </button>
          </div>
        </div>
      </div>

      <!-- Teacher Grammar Practice Modal -->
      <div id="gp-teacher-modal" class="ir-teacher-modal">
        <div class="ir-teacher-modal-content">
          <button class="ir-modal-close" onclick="closeGPTeacherModal()">✕</button>
          <h3 id="gp-modal-title">🎯 Grammar Practice - Unit Name</h3>
          <p>Choose how you'd like to work with this unit:</p>
          <div class="ir-teacher-modal-buttons">
            <button class="ir-teacher-modal-btn ir-modal-student-view" onclick="gpModalSelectOption('student-view')">
              👤 View as Student
            </button>
            <button class="ir-teacher-modal-btn ir-modal-dashboard" onclick="gpModalSelectOption('dashboard')">
              📊 View Dashboard
            </button>
            <button class="ir-teacher-modal-btn ir-modal-edit-mca" onclick="gpModalSelectOption('edit-questions')">
              ✏️ Edit Questions
            </button>
            <button class="ir-teacher-modal-btn ir-modal-teach-exemplars" onclick="gpModalSelectOption('teach-exemplars')">
              📖 Teach with Exemplars
            </button>
          </div>
        </div>
      </div>

      <!-- Teacher Independent Reading Semester Selection Screen -->
      <div id="ir-semester-selection-screen" class="hidden">
        <h2>📖 Independent Reading</h2>
        <p>Select which semester you'd like to work with:</p>
        
        <div class="choice-container">
          <div class="choice-buttons">
            <button class="choice-btn ir-semester1-choice" onclick="selectIRSemester('semester1')">
              📚 Semester 1
              <span class="choice-description">Fall semester independent reading</span>
            </button>
            <button class="choice-btn ir-semester2-choice" onclick="selectIRSemester('semester2')">
              📖 Semester 2
              <span class="choice-description">Spring semester independent reading</span>
            </button>
          </div>
        </div>
        
        <button id="back-to-main-from-ir-semester-btn" class="exemplar-nav-btn" style="margin-top: 20px;">← Back to Main Menu</button>
      </div>
      
      <!-- Teacher Independent Reading View Screen -->
      <div id="teacher-ir-screen" class="hidden">
        <h2>All Student Independent Reading</h2>
        <div id="teacher-ir-content">
          <div id="loading-teacher-ir" class="loading-indicator">
            <div class="spinner"></div>
            <p>Loading student reading data...</p>
          </div>
          <div id="teacher-ir-data"></div>
        </div>
        <button id="back-to-ir-from-teacher-btn" class="exemplar-nav-btn" style="margin-top: 20px;">← Back to Independent Reading</button>
      </div>

      <!-- Student Registration Screen -->
      <div id="registration-screen" class="hidden">
        <h2>Welcome! Let's get you set up.</h2>
        <p>Since this is your first time here, please enter your full name and select your teacher.</p>
        <div class="form-group">
            <label for="student-name">Full Name</label>
            <input type="text" id="student-name" placeholder="e.g., Jane Doe">
        </div>
        <div class="form-group">
            <label for="teacher-select">Teacher</label>
            <select id="teacher-select">
                <option value="">-- Please Select --</option>
            </select>
        </div>
        <button id="register-btn">Complete Registration</button>
        <button id="back-to-units-btn">Back to Units</button>
      </div>

      <!-- Student Choice Screen -->
      <div id="student-choice-screen" class="hidden">
        <h2 id="choice-unit-title">Unit Title</h2>
        <div class="choice-container">
          <p>How would you like to approach this unit?</p>
          <div class="choice-buttons">
            <button id="learn-exemplars-btn" class="choice-btn exemplars-choice">
              📖 Learn with exemplars
              <span class="choice-description">View examples and explanations first</span>
            </button>
            <button id="begin-practice-btn" class="choice-btn practice-choice">
              🎯 Begin practice
              <span class="choice-description">Start with questions immediately</span>
            </button>
          </div>
          <button id="back-from-choice-btn" class="exemplar-nav-btn">← Back to Units</button>
        </div>
        <div id="choice-teacher-banner"></div>
      </div>

      <!-- Exemplars Screen -->
      <div id="exemplars-screen" class="hidden">
        <h2 id="exemplars-unit-title">Unit Exemplars</h2>
        <div class="exemplar-container">
          <div class="exemplar-header">
            <h3 id="exemplar-title">Exemplar Title</h3>
            <div class="exemplar-progress" id="exemplar-progress">1 of 3</div>
          </div>
          <div id="exemplar-content" class="exemplar-content">
            <!-- Exemplar content will be loaded here -->
          </div>
          <div id="exemplar-explanation" class="exemplar-explanation">
            <h4>Why this works:</h4>
            <div id="exemplar-explanation-text">
              <!-- Explanation will be loaded here -->
            </div>
          </div>
          <div class="exemplar-buttons">
            <button id="exemplar-back-btn" class="exemplar-nav-btn">← Back to Units</button>
            <button id="got-it-btn" class="got-it-btn">I've got it!</button>
          </div>
        </div>
        <div id="exemplar-teacher-banner"></div>
      </div>

      <!-- Quiz Screen -->
      <div id="quiz-screen" class="hidden"></div>
      
      <!-- Results Screen -->
      <div id="results-screen" class="hidden">
        <div id="results-teacher-banner"></div>
      </div>

      <!-- Teacher Action Modal -->
      <div id="teacher-modal" class="modal hidden">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h3 id="modal-unit-title"></h3>
          <div class="teacher-actions">
            <button id="practice-as-student-btn" class="action-btn practice-btn">
              📝 View practice as student
            </button>
            <button id="view-results-btn" class="action-btn results-btn">
              📊 View results as teacher
            </button>
            <button id="teach-with-exemplars-btn" class="action-btn" style="background-color:#17a2b8">
              📖 Teach with exemplars
            </button>
            <button id="edit-questions-btn" class="action-btn edit-btn">
              ✏️ Edit questions
            </button>
          </div>
        </div>
      </div>

      <!-- Portfolio Teacher Modal -->
      <div id="portfolio-teacher-modal" class="modal hidden">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h3 id="portfolio-modal-unit-title"></h3>
          <div class="teacher-actions">
            <button id="portfolio-view-student-btn" class="action-btn practice-btn">
              👤 View as Student
            </button>
            <button id="portfolio-dashboard-btn" class="action-btn results-btn">
              📊 View Dashboard
            </button>
            <button id="portfolio-edit-btn" class="action-btn edit-btn">
              ✏️ Edit Learning Targets
            </button>
          </div>
        </div>
      </div>
      <!-- MCA Teacher Modal -->
      <div id="mca-teacher-modal" class="ir-teacher-modal">
        <div class="ir-teacher-modal-content">
          <button class="ir-modal-close" onclick="closeMCATeacherModal()">✕</button>
          <h3 id="mca-modal-title">📝 MCA Practice - Unit Name</h3>
          <p>Choose how you'd like to work with this unit:</p>
          <div class="ir-teacher-modal-buttons">
            <button class="ir-teacher-modal-btn ir-modal-student-view" onclick="mcaModalSelectOption('student-view')">
              👤 View as Student
            </button>
            <button class="ir-teacher-modal-btn ir-modal-dashboard" onclick="mcaModalSelectOption('dashboard')">
              📊 View Dashboard
            </button>
            <button class="ir-teacher-modal-btn ir-modal-edit-mca" onclick="mcaModalSelectOption('edit-questions')">
              ✏️ Edit MCA Questions
            </button>
          </div>
        </div>
      </div>

      <!-- Teacher Results Screen -->
      <div id="teacher-results-screen" class="hidden">
        <button id="back-to-units-from-results-btn">← Back to Units</button>
        <h3 id="teacher-results-title"></h3>
        <div id="loading-indicator-teacher" class="loading-indicator hidden">
          <div class="spinner"></div>
          <p>Loading results...</p>
        </div>
        <table id="teacher-results-table">
          <thead><tr><th>Student Name</th><th>Best Score</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- State Standards Alignment Screen -->
      <div id="standards-alignment-screen" class="hidden">
        <!-- Standards Header with Summary Statistics -->
        <div class="standards-header">
          <h1>📊 State Standards Alignment</h1>
          <div class="standards-summary">
            <div class="summary-stat">
              <span class="stat-number" id="total-standards">0</span>
              <span class="stat-label">Total Standards</span>
            </div>
            <div class="summary-stat covered">
              <span class="stat-number" id="covered-standards">0</span>
              <span class="stat-label">Covered</span>
            </div>
            <div class="summary-stat partial">
              <span class="stat-number" id="partial-standards">0</span>
              <span class="stat-label">Partial</span>
            </div>
            <div class="summary-stat not-covered">
              <span class="stat-number" id="not-covered-standards">0</span>
              <span class="stat-label">Not Covered</span>
            </div>
          </div>
        </div>
        
        <!-- Diagnostic Test Section -->
        <div style="margin-bottom: 20px;">
          <button id="diagnostic-test-btn" onclick="runDiagnosticTest()" style="
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-family: 'Nunito', sans-serif;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
            margin-bottom: 8px;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255, 107, 53, 0.4)';" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(255, 107, 53, 0.3)';">
            🔧 Run Diagnostic Test
          </button>
          <div style="font-size: 12px; color: #666; max-width: 400px; margin: 0 auto;">
            <strong>Troubleshooting:</strong> If standards aren't loading, click this button and check your browser console (F12 → Console) for detailed diagnostic information.
          </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="standards-loading" class="loading-indicator hidden">
          <div class="spinner"></div>
          <p>Loading standards data...</p>
        </div>

        <!-- Unit Selector -->
        <div class="unit-selector-container">
          <h3>📚 Select a Unit to View Standards Coverage</h3>
          <div class="unit-buttons-grid">
            <button class="unit-selector-btn" onclick="selectUnit('Unit 1: Coming of Age')">
              <div class="unit-number">1</div>
              <div class="unit-title">Coming of Age</div>
            </button>
            <button class="unit-selector-btn" onclick="selectUnit('Unit 2: Personal Narrative')">
              <div class="unit-number">2</div>
              <div class="unit-title">Personal Narrative</div>
            </button>
            <button class="unit-selector-btn" onclick="selectUnit('Unit 3: Novel Study')">
              <div class="unit-number">3</div>
              <div class="unit-title">Novel Study</div>
            </button>
            <button class="unit-selector-btn" onclick="selectUnit('Unit 4: Short Story')">
              <div class="unit-number">4</div>
              <div class="unit-title">Short Story</div>
            </button>
            <button class="unit-selector-btn" onclick="selectUnit('Unit 5: Romeo and Juliet')">
              <div class="unit-number">5</div>
              <div class="unit-title">Romeo and Juliet</div>
            </button>
            <button class="unit-selector-btn" onclick="selectUnit('Unit 5 (Enriched): Macbeth')">
              <div class="unit-number">5E</div>
              <div class="unit-title">Macbeth (Enriched)</div>
            </button>
            <button class="unit-selector-btn" onclick="selectUnit('Unit 6: Nonfiction')">
              <div class="unit-number">6</div>
              <div class="unit-title">Nonfiction</div>
            </button>
            <button class="unit-selector-btn" onclick="selectUnit('Unit 6 (Enriched): Frankenstein')">
              <div class="unit-number">6E</div>
              <div class="unit-title">Frankenstein (Enriched)</div>
            </button>
            <button class="unit-selector-btn" onclick="selectUnit('Unit 7: Resilience')">
              <div class="unit-number">7</div>
              <div class="unit-title">Resilience</div>
            </button>
          </div>
        </div>

        <!-- Standards Coverage Display -->
        <div id="standards-coverage-display" class="standards-coverage-section hidden">
          <h3 id="selected-unit-title">Unit Standards Coverage</h3>
          
          <!-- Search and Filter Controls -->
          <div class="standards-controls">
            <div class="search-container">
              <input type="text" id="standards-search" placeholder="🔍 Search standards by code or description..." style="
                width: 100%;
                max-width: 400px;
                padding: 12px 20px;
                border: 2px solid #e1e8ed;
                border-radius: 25px;
                font-size: 1em;
                outline: none;
                transition: all 0.3s ease;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
              ">
              <button id="clear-search" class="clear-search-btn" title="Clear search">✕</button>
            </div>
            <div class="filter-controls">
              <select id="category-filter" style="
                padding: 8px 12px;
                border: 2px solid #dee2e6;
                border-radius: 8px;
                background-color: #fff;
                margin-left: 10px;
              ">
                <option value="">All Categories</option>
              </select>
              <button id="expand-all-btn" class="control-btn">Expand All</button>
              <button id="collapse-all-btn" class="control-btn">Collapse All</button>
            </div>
          </div>
          
          <div class="coverage-legend">
            <div class="legend-item">
              <span class="status-indicator covered">✅</span>
              <span class="legend-text">Covered in this unit</span>
            </div>
            <div class="legend-item">
              <span class="status-indicator not-covered">❌</span>
              <span class="legend-text">Not covered in this unit</span>
            </div>
            <div class="legend-item">
              <span class="assessment-badge formative">📝 Formative</span>
            </div>
            <div class="legend-item">
              <span class="assessment-badge summative">📊 Summative</span>
            </div>
            <div class="legend-item">
              <span class="assessment-badge both">📝📊 Both</span>
            </div>
          </div>
          
          <!-- Table Filter Controls -->
          <div class="table-filter-controls">
            <div class="filter-group">
              <label for="coverage-filter">Coverage Status:</label>
              <select id="coverage-filter" class="filter-select">
                <option value="">All Standards</option>
                <option value="covered">Covered</option>
                <option value="not-covered">Not Covered</option>
                <option value="partial">Partial Coverage</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="assessment-filter">Assessment Type:</label>
              <select id="assessment-filter" class="filter-select">
                <option value="">All Types</option>
                <option value="formative">Formative</option>
                <option value="summative">Summative</option>
                <option value="both">Both</option>
                <option value="none">None</option>
              </select>
            </div>
            <div class="results-counter">
              <span id="filtered-count">0</span> of <span id="total-count">0</span> standards shown
            </div>
          </div>
          
          <!-- Standards Table -->
          <div id="standards-table-container" class="standards-table-view">
            <table id="standards-table" class="standards-table">
              <thead>
                <tr>
                  <th class="sortable" data-column="code">
                    Standard Code
                    <span class="sort-indicator">↕️</span>
                  </th>
                  <th class="sortable" data-column="description">
                    Description
                    <span class="sort-indicator">↕️</span>
                  </th>
                  <th class="sortable" data-column="coverage">
                    Coverage Status
                    <span class="sort-indicator">↕️</span>
                  </th>
                  <th class="sortable" data-column="assessment">
                    Assessment Type
                    <span class="sort-indicator">↕️</span>
                  </th>
                </tr>
              </thead>
              <tbody id="standards-table-body">
                <!-- Standards will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
        
        <button id="back-to-main-from-standards-btn" class="exemplar-nav-btn" style="margin-top: 20px;">← Back to Main Menu</button>
      </div>

      <!-- Loading/Error -->
      <div id="loading-indicator" class="hidden">
        <div class="spinner"></div>
        <p>Loading...</p>
      </div>
      <div id="error-message" class="hidden"></div>
    </div>

    <script>
      // Global variables
      let allQuestions = [], currentQuestionIndex = 0, score = 0, userAnswers = [], currentUnit = '';
      let userInfo = {};
      let isTeacher = false;
      let isTeacherViewer = false; // Track if user is a teacher viewer
      let isTeacherViewingAsStudent = false; // Track if teacher is in student view mode
      let availableUnits = []; // This will be populated based on user type and teacher settings
      let teacherUnitSettings = {}; // Store teacher's unit enable/disable settings
      let teacherMCAUnitSettings = {}; // Store teacher's MCA unit enable/disable settings
      let currentMCAUnit = '';
      
      // Exemplar variables
      let allExemplars = [], currentExemplarIndex = 0;
      
      // Learning Portfolio variables
      let portfolioUnits = []; // Units available in portfolio
      let portfolioUnitSettings = {}; // Store portfolio unit enable/disable settings for teachers
      let currentPortfolioUnit = '';
      let learningTargetsData = [];
      let studentProficiencyData = {};
      
      document.addEventListener('DOMContentLoaded', initializeApp);

      function initializeApp() {
        showScreen('loading-indicator');
        google.script.run.withSuccessHandler(onAppDataLoaded).withFailureHandler(onLoadError).getRoleAndUserInfo();
      }

      function onAppDataLoaded(response) {
        hideScreen('loading-indicator');
        
        if (response.error) {
          onLoadError({ message: response.error });
          return;
        }
        
        userInfo = response;
        isTeacher = response.isTeacher;
        
        // Set available units based on user type
        if (isTeacher) {
          // Teachers see all units
          availableUnits = ["Unit 1: Coming of Age", "Unit 2: Personal Narrative", "Unit 3: Novel Study", "Unit 4: Short Story", "Unit 5: Romeo and Juliet", "Unit 5 (Enriched): Macbeth", "Unit 6: Nonfiction", "Unit 6 (Enriched): Frankenstein", "Unit 7: Resilience", "Unit 8: Annotated Bibliography & Documentary"];
        } else if (response.isRegistered && response.enabledUnits) {
          // Registered students see only their teacher's enabled units
          availableUnits = response.enabledUnits;
        } else {
          // Unregistered students see all units
          availableUnits = ["Unit 1: Coming of Age", "Unit 2: Personal Narrative", "Unit 3: Novel Study", "Unit 4: Short Story", "Unit 5: Romeo and Juliet", "Unit 5 (Enriched): Macbeth", "Unit 6: Nonfiction", "Unit 6 (Enriched): Frankenstein", "Unit 7: Resilience", "Unit 8: Annotated Bibliography & Documentary"];
        }
        
        // Update welcome messages based on user type
        // TEMPORARY: Always show Standards Alignment button for testing
        document.getElementById('standards-alignment-btn').classList.remove('hidden');
        
        if (isTeacher) {
          document.getElementById('main-welcome-message').textContent = `Welcome, ${userInfo.teacherName}!`;
          document.getElementById('welcome-message').textContent = `Welcome, ${userInfo.teacherName}! Choose a Unit`;
          document.getElementById('portfolio-welcome-message').textContent = `${userInfo.teacherName}'s Learning Portfolio`;
        } else if (response.isRegistered) {
          document.getElementById('main-welcome-message').textContent = `Welcome, ${userInfo.name}!`;
          document.getElementById('welcome-message').textContent = `Welcome, ${userInfo.name}! Choose a Unit to Practice`;
          document.getElementById('portfolio-welcome-message').textContent = `${userInfo.name}'s Learning Portfolio`;
        } else {
          document.getElementById('main-welcome-message').textContent = `Welcome to English 9`;
          document.getElementById('welcome-message').textContent = `Choose a Unit to Practice`;
          document.getElementById('portfolio-welcome-message').textContent = `Learning Portfolio`;
        }
        
        // Set up main landing page button handlers
        setupMainLandingHandlers();
        
        // Show main landing page
        showScreen('main-landing-screen');
      }

      function setupMainLandingHandlers() {
        document.getElementById('grammar-practice-btn').onclick = () => {
          loadUnitsForSharedView();
        };
        
        document.getElementById('learning-portfolio-btn').onclick = () => {
          showLearningPortfolio();
        };
        
        document.getElementById('independent-reading-btn').onclick = () => {
          showIndependentReading();
        };
        
        document.getElementById('mca-practice-btn').onclick = () => {
          loadMCAUnitsForSharedView();
        };
        
        document.getElementById('standards-alignment-btn').onclick = () => {
          showStandardsAlignmentScreen();
        };
      }

      function loadUnitsForSharedView() {
        const container = document.getElementById('unit-grid');
        container.innerHTML = '';
        
        if (isTeacher) {
          // For teachers, load unit settings first, then display
          loadTeacherUnitSettings();
        } else if (userInfo.isRegistered) {
          // For students, load progress data
          google.script.run.withSuccessHandler(displayUnitsWithProgress).withFailureHandler(onLoadError).getStudentProgress();
        } else {
          // For unregistered students, show simple unit buttons
          displayUnitsWithProgress({ success: true, progress: {} });
        }
      }

      function loadMCAUnitsForSharedView() {
        const container = document.getElementById('mca-unit-grid');
        container.innerHTML = '';
        
        if (isTeacher) {
          // For teachers, load MCA unit settings first, then display
          loadTeacherMCAUnitSettings();
        } else if (userInfo.isRegistered) {
          // For students, load MCA progress data
          google.script.run.withSuccessHandler(displayMCAUnitsWithProgress).withFailureHandler(onLoadError).getMCAStudentProgress();
        } else {
          // For unregistered students, show simple unit buttons
          displayMCAUnitsWithProgress({ success: true, progress: {} });
        }
      }

      function loadTeacherUnitSettings() {
        google.script.run
          .withSuccessHandler(onTeacherUnitSettingsLoaded)
          .withFailureHandler(onLoadError)
          .getTeacherUnitSettings();
      }

      function loadTeacherMCAUnitSettings() {
        google.script.run
          .withSuccessHandler(onTeacherMCAUnitSettingsLoaded)
          .withFailureHandler(onLoadError)
          .getTeacherMCAUnitSettings();
      }

      function onTeacherUnitSettingsLoaded(response) {
        if (!response.success) {
          onLoadError({ message: response.error });
          return;
        }
        
        teacherUnitSettings = response.settings;
        isTeacherViewer = response.isViewer || false; // Track viewer status
        // Now display units with toggle controls
        displayUnitsWithProgress({ success: true, progress: {} });
      }

      function onTeacherMCAUnitSettingsLoaded(response) {
        if (!response.success) {
          onLoadError({ message: response.error });
          return;
        }
        
        teacherMCAUnitSettings = response.settings;
        isTeacherViewer = response.isViewer || false; // Track viewer status for MCA too
        // Now display MCA units with toggle controls
        displayMCAUnitsWithProgress({ success: true, progress: {} });
      }

      function displayUnitsWithProgress(progressResponse) {
        const container = document.getElementById('unit-grid');
        container.innerHTML = '';
        
        const progressData = progressResponse.progress || {};
        
        availableUnits.forEach(unit => {
          const bestScore = progressData[unit] || 0;
          let progressText = isTeacher ? 'Click to select action' : 'Not attempted';
          
          if (!isTeacher && bestScore > 0) {
            if (bestScore >= 90) progressText = `Mastered (${bestScore}%)`;
            else if (bestScore >= 70) progressText = `Proficient (${bestScore}%)`;
            else progressText = `Developing (${bestScore}%)`;
          }
          
          const button = document.createElement('div');
          button.className = 'unit-button';
          button.onclick = (e) => handleUnitClick(unit, e);
          
          let toggleHTML = '';
          if (isTeacher) {
            const isEnabled = teacherUnitSettings[unit] !== false; // Default to true if not set
            
            if (isTeacherViewer) {
              // Viewers see a "View Only" badge instead of toggle
              toggleHTML = `
                <div class="viewer-badge" title="View Only Access">
                  <span style="font-size: 0.8em; background: #007bff; color: white; padding: 4px 8px; border-radius: 12px;">👁 Viewer</span>
                </div>
              `;
            } else {
              toggleHTML = `
                <div class="unit-toggle-wrapper" onclick="event.stopPropagation()">
                  <label class="unit-inline-toggle">
                    <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="handleInlineUnitToggle('${unit}', this.checked, this)">
                    <span class="unit-inline-slider"></span>
                  </label>
                </div>
              `;
            }
          }
          
          button.innerHTML = `
            ${toggleHTML}
            <div class="unit-title">${unit}</div>
            <div class="unit-progress">${progressText}</div>
          `;
          container.appendChild(button);
        });
        
        // Set up back to main button
        document.getElementById('back-to-main-btn').onclick = () => {
          showScreen('main-landing-screen');
        };
        
        showScreen('unit-selection-screen');
      }

      function displayMCAUnitsWithProgress(progressResponse) {
        const container = document.getElementById('mca-unit-grid');
        container.innerHTML = '';
        
        const progressData = progressResponse.progress || {};
        
        availableUnits.forEach(unit => {
          const bestScore = progressData[unit] || 0;
          let progressText = isTeacher ? 'Click to select action' : 'Not attempted';
          
          if (!isTeacher && bestScore > 0) {
            if (bestScore >= 90) progressText = `Mastered (${bestScore}%)`;
            else if (bestScore >= 70) progressText = `Proficient (${bestScore}%)`;
            else progressText = `Developing (${bestScore}%)`;
          }
          
          const button = document.createElement('div');
          button.className = 'unit-button';
          button.onclick = (e) => handleMCAUnitClick(unit, e);
          
          let toggleHTML = '';
          if (isTeacher) {
            const isEnabled = teacherMCAUnitSettings[unit] !== false; // Default to true if not set
            
            if (isTeacherViewer) {
              // Viewers see a "View Only" badge instead of toggle for MCA too
              toggleHTML = `
                <div class="viewer-badge" title="View Only Access">
                  <span style="font-size: 0.8em; background: #007bff; color: white; padding: 4px 8px; border-radius: 12px;">👁 Viewer</span>
                </div>
              `;
            } else {
              toggleHTML = `
                <div class="unit-toggle-wrapper" onclick="event.stopPropagation()">
                  <label class="unit-inline-toggle">
                    <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="handleInlineMCAUnitToggle('${unit}', this.checked, this)">
                    <span class="unit-inline-slider"></span>
                  </label>
                </div>
              `;
            }
          }
          
          button.innerHTML = `
            ${toggleHTML}
            <div class="unit-title">${unit}</div>
            <div class="unit-progress">${progressText}</div>
          `;
          container.appendChild(button);
        });
        
        // Set up back to main button
        document.getElementById('back-to-main-from-mca-btn').onclick = () => {
          showScreen('main-landing-screen');
        };
        
        showScreen('mca-unit-selection-screen');
      }

      function handleUnitClick(unitName, event) {
        // Prevent click if it's from the toggle area
        if (event && event.target.closest('.unit-toggle-wrapper')) {
          return;
        }
        
        currentUnit = unitName;
        
        if (isTeacher) {
          showTeacherModal(unitName);
        } else {
          // For students - check if registered, then show choice screen
          if (userInfo.isRegistered) {
            showStudentChoiceScreen(unitName);
          } else {
            // Show registration screen first
            populateTeacherDropdown(userInfo.teachers);
            showScreen('registration-screen');
            document.getElementById('register-btn').onclick = submitRegistration;
            document.getElementById('back-to-units-btn').onclick = () => showScreen('main-landing-screen');
          }
        }
      }

      // Inline Unit Toggle Handler
      function handleInlineUnitToggle(unitName, isEnabled, toggleElement) {
        // Update local settings immediately for UI responsiveness
        teacherUnitSettings[unitName] = isEnabled;
        
        // Save to backend
        google.script.run
          .withSuccessHandler(() => {
            // Success - settings already updated locally
            console.log(`Unit ${unitName} ${isEnabled ? 'enabled' : 'disabled'}`);
          })
          .withFailureHandler((error) => {
            // Revert on error
            teacherUnitSettings[unitName] = !isEnabled;
            toggleElement.checked = !isEnabled;
            onLoadError({ message: error.message });
          })
          .updateTeacherUnitSettings(unitName, isEnabled);
      }

      function handleMCAUnitClick(unitName, event) {
        // Prevent click if it's from the toggle area
        if (event && event.target.closest('.unit-toggle-wrapper')) {
          return;
        }
        
        currentMCAUnit = unitName;
        
        if (isTeacher) {
          showMCATeacherModal(unitName);
        } else {
          startMCAQuiz(unitName);
        }
      }

      // Inline MCA Unit Toggle Handler
      function handleInlineMCAUnitToggle(unitName, isEnabled, toggleElement) {
        // Update local settings immediately for UI responsiveness
        teacherMCAUnitSettings[unitName] = isEnabled;
        
        // Save to backend
        google.script.run
          .withSuccessHandler(() => {
            // Success - settings already updated locally
            console.log(`MCA Unit ${unitName} ${isEnabled ? 'enabled' : 'disabled'}`);
          })
          .withFailureHandler((error) => {
            // Revert on error
            teacherMCAUnitSettings[unitName] = !isEnabled;
            toggleElement.checked = !isEnabled;
            onLoadError({ message: error.message });
          })
          .updateTeacherMCAUnitSettings(unitName, isEnabled);
      }

      // Teacher Modal Functions
      function showTeacherModal(unitName) {
        showGPTeacherModal(unitName);
      }

      let selectedGPUnit = '';

      function showGPTeacherModal(unitName) {
        selectedGPUnit = unitName;
        document.getElementById('gp-modal-title').textContent = `🎯 Grammar Practice - ${unitName}`;
        document.getElementById('gp-teacher-modal').classList.add('show');
        
        // Add click handler to close modal when clicking outside
        document.getElementById('gp-teacher-modal').onclick = (e) => {
          if (e.target === document.getElementById('gp-teacher-modal')) {
            closeGPTeacherModal();
          }
        };
      }

      function closeGPTeacherModal() {
        document.getElementById('gp-teacher-modal').classList.remove('show');
      }

      function gpModalSelectOption(option) {
        closeGPTeacherModal();
        
        switch(option) {
          case 'student-view':
            enterStudentView(selectedGPUnit);
            break;
          case 'dashboard':
            showTeacherResults(selectedGPUnit);
            break;
          case 'edit-questions':
            editQuestions(selectedGPUnit);
            break;
          case 'teach-exemplars':
            startExemplars(selectedGPUnit);
            break;
        }
      }

      function editQuestions(unitName) {
        // This function will be implemented to show question editing interface
        alert(`Edit Questions functionality for ${unitName} will be implemented here.`);
        // For now, redirect back to unit selection
        showScreen('unit-selection-screen');
      }

      let selectedMCAUnit = '';

      function showMCATeacherModal(unitName) {
        selectedMCAUnit = unitName;
        document.getElementById('mca-modal-title').textContent = `📝 MCA Practice - ${unitName}`;
        document.getElementById('mca-teacher-modal').classList.add('show');
        
        // Add click handler to close modal when clicking outside
        document.getElementById('mca-teacher-modal').onclick = (e) => {
          if (e.target === document.getElementById('mca-teacher-modal')) {
            closeMCATeacherModal();
          }
        };
      }

      function closeMCATeacherModal() {
        document.getElementById('mca-teacher-modal').classList.remove('show');
      }

      function mcaModalSelectOption(option) {
        closeMCATeacherModal();
        
        switch(option) {
          case 'student-view':
            enterMCAStudentView(selectedMCAUnit);
            break;
          case 'dashboard':
            showMCATeacherResults(selectedMCAUnit);
            break;
          case 'edit-questions':
            editMCAQuestions(selectedMCAUnit);
            break;
        }
      }

      function editMCAQuestions(unitName) {
        // This function will be implemented to show MCA question editing interface
        alert(`Edit MCA Questions functionality for ${unitName} will be implemented here.`);
        // For now, redirect back to MCA unit selection
        showScreen('mca-unit-selection-screen');
      }


      function showTeacherResults(unitName) {
        document.getElementById('teacher-results-title').textContent = `Results for: ${unitName}`;
        document.getElementById('loading-indicator-teacher').classList.remove('hidden');
        document.getElementById('teacher-results-table').classList.add('hidden');
        showScreen('teacher-results-screen');
        
        document.getElementById('back-to-units-from-results-btn').onclick = () => showScreen('unit-selection-screen');
        
        google.script.run
          .withSuccessHandler(onTeacherResultsLoaded)
          .withFailureHandler(onLoadError)
          .getUnitDetailsForTeacher(unitName);
      }

      function showMCATeacherResults(unitName) {
        document.getElementById('teacher-results-title').textContent = `MCA Results for: ${unitName}`;
        document.getElementById('loading-indicator-teacher').classList.remove('hidden');
        document.getElementById('teacher-results-table').classList.add('hidden');
        showScreen('teacher-results-screen');
        
        document.getElementById('back-to-units-from-results-btn').onclick = () => showScreen('mca-unit-selection-screen');
        
        google.script.run
          .withSuccessHandler(onTeacherResultsLoaded)
          .withFailureHandler(onLoadError)
          .getMCAUnitDetailsForTeacher(unitName);
      }

      function onTeacherResultsLoaded(response) {
        document.getElementById('loading-indicator-teacher').classList.add('hidden');
        document.getElementById('teacher-results-table').classList.remove('hidden');
        
        if (!response.success) {
          onLoadError({ message: response.error });
          return;
        }

        const tbody = document.getElementById('teacher-results-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        
        if (!response.details || response.details.length === 0) {
          tbody.innerHTML = '<tr><td colspan="2">No data found for this unit.</td></tr>';
          return;
        }

        response.details.forEach(student => {
          let scoreCell = '<span class="score-unattempted">Not Attempted</span>';
          if (student.bestScore !== undefined && student.bestScore !== null) {
            let scoreClass = 'developing';
            if (student.bestScore >= 90) scoreClass = 'mastered';
            else if (student.bestScore >= 70) scoreClass = 'proficient';
            scoreCell = `<span class="score-${scoreClass}">${student.bestScore}%</span>`;
          }

          const row = tbody.insertRow();
          row.innerHTML = `<td>${student.studentName}</td><td>${scoreCell}</td>`;
        });
      }

      // Student Registration Functions
      function populateTeacherDropdown(teachers) {
        const select = document.getElementById('teacher-select');
        select.innerHTML = '<option value="">-- Please Select --</option>';
        teachers.forEach(teacher => {
          const option = document.createElement('option');
          option.value = teacher;
          option.textContent = teacher;
          select.appendChild(option);
        });
      }

      function submitRegistration() {
        const name = document.getElementById('student-name').value.trim();
        const teacher = document.getElementById('teacher-select').value;
        if (!name || !teacher) {
          alert('Please enter your full name and select a teacher.');
          return;
        }
        
        showScreen('loading-indicator');
        const studentData = { name: name, teacher: teacher };
        google.script.run
          .withSuccessHandler(onRegistrationSuccess)
          .withFailureHandler(onLoadError)
          .registerStudent(studentData);
      }

      function onRegistrationSuccess(response) {
        if (!response || !response.success) {
          onLoadError({ message: response.error || 'Registration failed unexpectedly.' });
          return;
        }
        
        // Update user info and restart app
        userInfo.isRegistered = true;
        userInfo.name = response.name;
        userInfo.teacher = response.teacher;
        
        // Start the quiz they originally clicked on
        showStudentChoiceScreen(currentUnit);
      }

      // Student Choice Screen Functions
      function showStudentChoiceScreen(unitName) {
        currentUnit = unitName;
        document.getElementById('choice-unit-title').textContent = unitName;
        
        // Add teacher banner if in teacher view mode
        document.getElementById('choice-teacher-banner').innerHTML = addTeacherBanner();
        
        showScreen('student-choice-screen');
        
        // Set up button handlers
        document.getElementById('learn-exemplars-btn').onclick = () => {
          startExemplars(unitName);
        };
        
        document.getElementById('begin-practice-btn').onclick = () => {
          startQuiz(unitName);
        };
        
        document.getElementById('back-from-choice-btn').onclick = () => {
          if (isTeacherViewingAsStudent) {
            returnToTeacherView();
          } else {
            showScreen('unit-selection-screen');
          }
        };
      }

      // Exemplar Functions

      function startExemplars(unitName) {
        currentUnit = unitName;
        showScreen('loading-indicator');
        google.script.run
          .withSuccessHandler(onExemplarsLoaded)
          .withFailureHandler(onLoadError)
          .getExemplarsForUnit(unitName);
      }

      function onExemplarsLoaded(response) {
        // Log debug information
        if (response.debugInfo) {
          console.log('[onExemplarsLoaded] Debug info:', response.debugInfo);
        }
        
        if (!response.success) {
          let errorMessage = response.error || 'Failed to load exemplars';
          
          // Show detailed error information if available
          if (response.debugInfo && response.debugInfo.missingColumns) {
            errorMessage = response.error; // Use the full detailed error message
            console.error('[Exemplars Error] Detailed debug info:', response.debugInfo);
          }
          
          onLoadError({ message: errorMessage });
          return;
        }

        allExemplars = response.exemplars || [];
        
        currentExemplarIndex = 0;
        document.getElementById('exemplars-unit-title').textContent = `${currentUnit} - Exemplars`;
        
        // Add teacher banner
        document.getElementById('exemplar-teacher-banner').innerHTML = addTeacherBanner();
        
        showScreen('exemplars-screen');
        
        if (allExemplars.length === 0) {
          // No exemplars found, show empty state with debug info
          displayEmptyExemplarState(response.debugInfo);
        } else {
          displayExemplar();
        }
      }

      function displayEmptyExemplarState(debugInfo) {
        document.getElementById('exemplar-title').textContent = 'No Exemplars Available';
        document.getElementById('exemplar-progress').textContent = '';
        
        let contentHTML = '';
        
        if (isTeacher) {
          contentHTML = '<p>No exemplars have been added for this unit yet.</p>';
          contentHTML += '<p><strong>Teachers:</strong> To add exemplars for this unit:</p>';
          contentHTML += '<ol>';
          contentHTML += '<li>Open your Google Sheets document</li>';
          contentHTML += '<li>Go to the "Exemplars" tab (it will be created automatically if it doesn\'t exist)</li>';
          contentHTML += '<li>Add your exemplars with these exact column headers:</li>';
          contentHTML += '</ol>';
          contentHTML += '<div style="background-color:#f8f9fa; padding:10px; border-radius:5px; margin:10px 0;">';
          contentHTML += '<strong>Required Columns:</strong><br>';
          contentHTML += 'Unit | Topic | Use | Source Text | Exemplars | How It Works<br><br>';
          contentHTML += `<strong>Unit name to use:</strong> "${currentUnit}"<br>`;
          contentHTML += '<strong>Each row represents one exemplar</strong>';
          contentHTML += '</div>';
          
          if (debugInfo) {
            contentHTML += '<details style="margin-top:15px; font-size:0.9em; color:#666;">';
            contentHTML += '<summary>Debug Information (click to expand)</summary>';
            contentHTML += `<pre style="background:#f0f0f0; padding:10px; margin:5px 0; border-radius:3px; font-size:0.8em;">${JSON.stringify(debugInfo, null, 2)}</pre>`;
            contentHTML += '</details>';
          }
        } else {
          // Simple message for students
          contentHTML = '<p>No exemplars available yet. Please check back at a later time.</p>';
        }
        
        document.getElementById('exemplar-content').innerHTML = contentHTML;
        
        document.getElementById('exemplar-explanation-text').innerHTML = `
          <p>Exemplars are examples that help students understand key concepts before practicing.</p>
        `;
        
        // Update buttons for empty state
        const buttonsContainer = document.querySelector('.exemplar-buttons');
        buttonsContainer.innerHTML = `
          <button id="exemplar-back-btn" class="exemplar-nav-btn">← Back to Units</button>
          ${isTeacher ? '<button id="edit-exemplars-btn" class="exemplar-edit-btn">📝 Open Google Sheets</button>' : ''}
          ${!isTeacher ? '<button id="continue-to-quiz-btn" class="got-it-btn">Continue to Practice</button>' : ''}
        `;
        
        // Set up button handlers
        document.getElementById('exemplar-back-btn').onclick = () => {
          if (isTeacherViewingAsStudent) {
            returnToTeacherView();
          } else {
            showScreen('unit-selection-screen');
          }
        };
        
        if (isTeacher && document.getElementById('edit-exemplars-btn')) {
          document.getElementById('edit-exemplars-btn').onclick = () => {
            // Direct link to Google Sheets would be ideal, but we'll show instructions
            showExemplarEditInterface();
          };
        }
        
        if (!isTeacher && document.getElementById('continue-to-quiz-btn')) {
          document.getElementById('continue-to-quiz-btn').onclick = () => {
            completeExemplars();
          };
        }
      }

      function displayExemplar() {
        if (currentExemplarIndex >= allExemplars.length) {
          // All exemplars completed, save progress and start quiz
          completeExemplars();
          return;
        }

        const exemplar = allExemplars[currentExemplarIndex];
        
        // Update title and progress - progress is now positioned in top right
        document.getElementById('exemplar-title').textContent = exemplar.topic || `Exemplar ${currentExemplarIndex + 1}`;
        document.getElementById('exemplar-progress').textContent = `${currentExemplarIndex + 1} of ${allExemplars.length}`;
        
        // Create subtitle section for Use and Source Text (centered under the title)
        const headerContainer = document.querySelector('.exemplar-header');
        let existingSubtitle = headerContainer.querySelector('.exemplar-subtitle');
        if (existingSubtitle) {
          existingSubtitle.remove();
        }
        
        let subtitleHTML = '';
        if (exemplar.use) {
          subtitleHTML += `Use: ${exemplar.use}`;
        }
        if (exemplar.sourceText) {
          if (subtitleHTML) subtitleHTML += '<br>';
          subtitleHTML += `Source: ${exemplar.sourceText}`;
        }
        
        if (subtitleHTML) {
          const subtitleDiv = document.createElement('div');
          subtitleDiv.className = 'exemplar-subtitle';
          subtitleDiv.innerHTML = subtitleHTML;
          // Insert after the title but before the progress indicator
          const titleElement = document.getElementById('exemplar-title');
          titleElement.insertAdjacentElement('afterend', subtitleDiv);
        }
        
        // Main content now only shows the exemplar itself (bigger and more prominent)
        document.getElementById('exemplar-content').innerHTML = exemplar.exemplars || "No exemplar provided.";
        
        // Show "How It Works" in the explanation section
        document.getElementById('exemplar-explanation-text').innerHTML = exemplar.howItWorks || "No explanation provided.";
        
        // Update buttons for normal exemplar display
        const isLastExemplar = currentExemplarIndex === allExemplars.length - 1;
        const buttonText = isLastExemplar ? "Start Practice" : "I've got it!";
        
        const buttonsContainer = document.querySelector('.exemplar-buttons');
        buttonsContainer.innerHTML = `
          <button id="exemplar-back-btn" class="exemplar-nav-btn">← Back to Units</button>
          <button id="got-it-btn" class="got-it-btn">${buttonText}</button>
          ${isTeacher ? '<button id="edit-exemplars-btn" class="exemplar-edit-btn">📝 Edit Exemplars</button>' : ''}
        `;
        
        // Set up button handlers
        document.getElementById('exemplar-back-btn').onclick = () => {
          if (isTeacherViewingAsStudent) {
            returnToTeacherView();
          } else {
            showScreen('unit-selection-screen');
          }
        };
        document.getElementById('got-it-btn').onclick = () => {
          if (isLastExemplar) {
            // Save exemplar completion and start quiz
            completeExemplars();
          } else {
            // Move to next exemplar
            currentExemplarIndex++;
            displayExemplar();
          }
        };
        
        if (isTeacher && document.getElementById('edit-exemplars-btn')) {
          document.getElementById('edit-exemplars-btn').onclick = () => showExemplarEditInterface();
        }
      }

      function completeExemplars() {
        // After exemplars, show choice screen again so student can decide next step
        showStudentChoiceScreen(currentUnit);
      }

      function showExemplarEditInterface() {
        const message = `Exemplar Management for ${currentUnit}:

TO ADD EXEMPLARS:
1. Open your Google Sheets document at:
   https://docs.google.com/spreadsheets/d/173tUIsQFYL8QeI-65DW62SeyOuBEK8v2t5Lhtmq5qSo/edit

2. Go to the "Exemplars" tab (created automatically if missing)

3. Add rows with these exact column headers:
   • Unit: "${currentUnit}"
   • Topic: The topic/concept being taught
   • Use: How this exemplar is used
   • Source Text: The original text (if applicable)
   • Exemplars: The actual example
   • How It Works: Explanation of why it works

4. Refresh this page after adding exemplars

EXAMPLE ROW:
Unit: ${currentUnit}
Topic: Strong Opening Sentences
Use: To engage readers from the first line
Source Text: Coming-of-age narrative
Exemplars: "The first day of high school changed everything I thought I knew about myself."
How It Works: This opening immediately establishes the theme of personal growth, creates intrigue, and draws the reader into the narrator's transformation journey.

Each row represents one exemplar. Add multiple rows for multiple exemplars.`;

        alert(message);
      }

      // Quiz Functions
      function startQuiz(unitName) {
        currentUnit = unitName;
        showScreen('loading-indicator');
        google.script.run.withSuccessHandler(onQuestionsLoaded).withFailureHandler(onLoadError).getQuestionsForUnit(unitName);
      }

      function startMCAQuiz(unitName) {
        currentMCAUnit = unitName;
        showScreen('loading-indicator');
        google.script.run.withSuccessHandler(onMCAQuestionsLoaded).withFailureHandler(onLoadError).getMCAQuestionsForUnit(unitName);
      }

      function onQuestionsLoaded(questions) {
        if (!questions || questions.error || questions.length === 0) {
          const errorMessage = questions?.error ? questions.message : `No questions found for "${currentUnit}".`;
          onLoadError({ message: errorMessage });
          return;
        }
        
        allQuestions = questions.map(q => ({...q, options: shuffleArray(q.options)}));
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = [];
        showScreen('quiz-screen');
        displayQuestion();
      }

      function onMCAQuestionsLoaded(questions) {
        if (!questions || questions.error || questions.length === 0) {
          const errorMessage = questions?.error ? questions.message : `No MCA questions found for "${currentMCAUnit}".`;
          onLoadError({ message: errorMessage });
          return;
        }
        
        allQuestions = questions.map(q => ({...q, options: shuffleArray(q.options)}));
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = [];
        showScreen('quiz-screen');
        displayQuestion();
      }

      function displayQuestion() {
        const question = allQuestions[currentQuestionIndex];
        
        const isLastQuestion = currentQuestionIndex === allQuestions.length - 1;
        const nextButtonText = isLastQuestion ? "See Results" : "Go to next question";
        
        // Build the passage section if it exists
        const passageSection = question.passage && question.passage.trim() ? `
          <div id="passage-container" style="background-color: #f8f9fa; border-radius: 10px; padding: 20px; margin: 20px 0; border-left: 4px solid #007bff;">
            <h3 style="color: #007bff; margin-top: 0; font-family: 'Patrick Hand', cursive;">📖 Reading Passage</h3>
            <div style="font-family: 'Nunito', sans-serif; line-height: 1.6; color: #495057; white-space: pre-wrap;">${question.passage}</div>
          </div>
        ` : '';
        
        document.getElementById('quiz-screen').innerHTML = `
          <div id="progress-container"><p>Question ${currentQuestionIndex + 1} of ${allQuestions.length}</p></div>
          ${passageSection}
          <h2 id="question-text">${question.question}</h2>
          <div id="answer-options">${question.options.map(opt => `<button class="option-btn">${opt}</button>`).join('')}</div>
          <div id="question-answer-result" style="margin: 20px 0; min-height: 60px;"></div>
          <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
            <button id="back-to-home-btn" class="exemplar-nav-btn">Back to Units</button>
            <button id="next-question-btn" class="got-it-btn" disabled>${nextButtonText}</button>
          </div>
          ${addTeacherBanner()}
        `;
        
        document.querySelectorAll('.option-btn').forEach(btn => {
          btn.onclick = () => handleAnswer(btn.textContent, btn);
        });
        
        
        document.getElementById('back-to-home-btn').onclick = () => {
          if (isTeacherViewingAsStudent) {
            returnToTeacherView();
          } else {
            showScreen('unit-selection-screen');
          }
        };
        
        document.getElementById('next-question-btn').onclick = () => {
          currentQuestionIndex++;
          if (currentQuestionIndex < allQuestions.length) {
            displayQuestion();
          } else {
            showResults();
          }
        };
      }

      function handleAnswer(selectedOption, buttonElement) {
        const question = allQuestions[currentQuestionIndex];
        const isCorrect = selectedOption === question.answer;
        
        userAnswers.push({
          question: question.question,
          selected: selectedOption,
          correctAnswer: question.answer,
          isCorrect: isCorrect
        });
        
        if (isCorrect) score++;
        
        buttonElement.classList.add(isCorrect ? 'correct' : 'incorrect');
        document.querySelectorAll('.option-btn').forEach(btn => {
          btn.disabled = true;
          if (btn.textContent === question.answer) btn.classList.add('correct');
        });
        
        // Show result and enable next button
        const resultDiv = document.getElementById('question-answer-result');
        resultDiv.innerHTML = `
          <p style="font-weight: 600; color: ${isCorrect ? '#28a745' : '#dc3545'};">
            ${isCorrect ? '✓ Correct!' : '✗ Incorrect'}
          </p>
          ${!isCorrect ? `<p style="color: #6c757d;">The correct answer is: <strong>${question.answer}</strong></p>` : ''}
        `;
        
        document.getElementById('next-question-btn').disabled = false;
      }

      function showResults() {
        const unitName = currentMCAUnit || currentUnit;
        const resultData = { unit: unitName, score: score, total: allQuestions.length };
        
        // Save results for registered students
        if (!isTeacher && userInfo.isRegistered) {
          if (currentMCAUnit) {
            google.script.run.withFailureHandler(err => console.error('Failed to save MCA result:', err)).saveMCAQuizResult(resultData);
          } else {
            google.script.run.withFailureHandler(err => console.error('Failed to save result:', err)).saveQuizResult(resultData);
          }
        }
        
        document.getElementById('results-screen').innerHTML = `
          <h2>Quiz Complete!</h2>
          <p id="final-score">You scored ${score} out of ${allQuestions.length}!</p>
          <h3>Review Your Answers:</h3>
          <div id="review-container">
            ${userAnswers.map(ua => `
              <div class="review-item">
                <p class="review-question">${ua.question}</p>
                ${ua.isCorrect ? 
                  `<p>Your answer: <span class="review-answer-correct">${ua.selected} (Correct)</span></p>` : 
                  `<p>Your answer: <span class="review-answer-incorrect">${ua.selected}</span></p>
                   <p>Correct answer: <span class="review-answer-correct">${ua.correctAnswer}</span></p>`
                }
              </div>
            `).join('')}
          </div>
          <button id="try-again-btn">Practice this Unit Again</button>
          <button id="main-menu-btn">Back to Units</button>
          <div id="results-teacher-banner">${addTeacherBanner()}</div>
        `;
        
        showScreen('results-screen');
        
        document.getElementById('try-again-btn').onclick = () => {
          if (currentMCAUnit) {
            startMCAQuiz(currentMCAUnit);
          } else {
            startQuiz(currentUnit);
          }
        };
        document.getElementById('main-menu-btn').onclick = () => {
          if (isTeacherViewingAsStudent) {
            returnToTeacherView();
          } else {
            if (currentMCAUnit) {
              showScreen('mca-unit-selection-screen');
            } else {
              showScreen('unit-selection-screen');
            }
          }
        };
      }

      // Utility Functions
      function updateBodyBackground(screenId) {
        // Remove all existing background classes
        document.body.classList.remove('body-learning-portfolio', 'body-grammar-practice', 'body-independent-reading', 'body-mca-practice', 'body-default');
        
        // Add appropriate background class based on screen
        if (screenId === 'learning-portfolio-screen' || 
            screenId === 'portfolio-teacher-choice-screen' || 
            screenId === 'unit-portfolio-screen' || 
            screenId === 'portfolio-teacher-dashboard-screen' || 
            screenId === 'portfolio-edit-targets-screen') {
          document.body.classList.add('body-learning-portfolio');
        } else if (screenId === 'unit-selection-screen' || 
                   screenId === 'student-choice-screen' || 
                   screenId === 'exemplars-screen' || 
                   screenId === 'quiz-screen' || 
                   screenId === 'results-screen' || 
                   screenId === 'teacher-results-screen') {
          document.body.classList.add('body-grammar-practice');
        } else if (screenId === 'independent-reading-screen' || 
                   screenId === 'ir-semester-selection-screen' || 
                   screenId === 'teacher-ir-screen') {
          document.body.classList.add('body-independent-reading');
        } else if (screenId === 'mca-unit-selection-screen') {
          document.body.classList.add('body-mca-practice');
        } else {
          // Default background for main screen, registration, etc.
          document.body.classList.add('body-default');
        }
      }

      function showScreen(screenId) {
        document.querySelectorAll('.container > div:not(.hidden)').forEach(el => el.classList.add('hidden'));
        document.getElementById(screenId).classList.remove('hidden');
        updateBodyBackground(screenId);
      }

      function hideScreen(screenId) {
        document.getElementById(screenId).classList.add('hidden');
      }

      function onLoadError(error) {
        hideScreen('loading-indicator');
        const errorDiv = document.getElementById('error-message');
        errorDiv.innerHTML = `<h2>An Error Occurred</h2><p>${error.message}</p><button onclick="initializeApp()">Try Again</button>`;
        showScreen('error-message');
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      // Teacher View Functions
      function addTeacherBanner() {
        if (isTeacherViewingAsStudent) {
          return `
            <div class="teacher-banner">
              🎓 Viewing as Student
              <button onclick="returnToTeacherView()">Return to Teacher View</button>
            </div>
          `;
        }
        return '';
      }

      function enterStudentView(unitName) {
        isTeacherViewingAsStudent = true;
        currentUnit = unitName;
        // Show the student choice screen just like a real student would see
        showStudentChoiceScreen(unitName);
      }

      function enterMCAStudentView(unitName) {
        isTeacherViewingAsStudent = true;
        currentMCAUnit = unitName;
        // Start MCA quiz directly (no exemplars for MCA)
        startMCAQuiz(unitName);
      }

      function returnToTeacherView() {
        isTeacherViewingAsStudent = false;
        if (currentMCAUnit) {
          currentMCAUnit = '';
          showScreen('mca-unit-selection-screen');
        } else {
          showScreen('unit-selection-screen');
        }
      }
      
      // Independent Reading Functions
      let currentIRView = 'dashboard'; // dashboard, student, detailed
      
      function showIndependentReading() {
        // For teachers, show semester selection first
        if (isTeacher) {
          showIRSemesterSelection();
        } else {
          // For students, go directly to their individual view
          showStudentIndependentReading();
        }
      }

      function showIRSemesterSelection() {
        showScreen('ir-semester-selection-screen');
        
        // Set up navigation button
        document.getElementById('back-to-main-from-ir-semester-btn').onclick = () => {
          showScreen('main-landing-screen');
        };
      }

      let selectedIRSemester = '';

      function selectIRSemester(semester) {
        selectedIRSemester = semester;
        showIRTeacherModal();
      }

      function showIRTeacherModal() {
        document.getElementById('ir-teacher-modal').classList.add('show');
        
        // Add click handler to close modal when clicking outside
        document.getElementById('ir-teacher-modal').onclick = (e) => {
          if (e.target === document.getElementById('ir-teacher-modal')) {
            closeIRTeacherModal();
          }
        };
      }

      function closeIRTeacherModal() {
        document.getElementById('ir-teacher-modal').classList.remove('show');
      }

      function irModalSelectOption(option) {
        closeIRTeacherModal();
        
        switch(option) {
          case 'student-view':
            showStudentIndependentReading();
            break;
          case 'dashboard':
            showTeacherIndependentReadingDashboard();
            break;
          case 'edit-ir':
            showEditIndependentReading();
            break;
        }
      }

      function showStudentIndependentReading() {
        showScreen('independent-reading-screen');
        
        // Show loading and hide all containers
        document.getElementById('loading-ir').classList.remove('hidden');
        document.getElementById('ir-semesters-container').classList.add('hidden');
        document.getElementById('teacher-ir-controls').classList.add('hidden');
        document.getElementById('ir-dashboard-container').classList.add('hidden');
        
        // Set up navigation buttons
        document.getElementById('back-to-main-from-reading-btn').onclick = () => {
          if (isTeacher) {
            showIRSemesterSelection();
          } else {
            showScreen('main-landing-screen');
          }
        };
        
        document.getElementById('back-to-ir-from-teacher-btn').onclick = () => {
          showIRSemesterSelection();
        };
        
        // Load student view data
        loadStudentIndependentReading();
      }

      function showTeacherIndependentReadingDashboard() {
        showScreen('independent-reading-screen');
        
        // Show loading and hide all containers
        document.getElementById('loading-ir').classList.remove('hidden');
        document.getElementById('ir-semesters-container').classList.add('hidden');
        document.getElementById('teacher-ir-controls').classList.add('hidden');
        document.getElementById('ir-dashboard-container').classList.add('hidden');
        
        // Set up navigation buttons
        document.getElementById('back-to-main-from-reading-btn').onclick = () => {
          showIRSemesterSelection();
        };
        
        document.getElementById('back-to-ir-from-teacher-btn').onclick = () => {
          showIRSemesterSelection();
        };
        
        // Set up teacher control buttons
        document.getElementById('ir-dashboard-btn').onclick = () => switchIRView('dashboard');
        document.getElementById('ir-student-view-btn').onclick = () => switchIRView('student');
        
        // Load teacher dashboard data
        loadTeacherIndependentReading();
      }

      function showEditIndependentReading() {
        // This function will be implemented to show Independent Reading editing interface
        alert(`Edit Independent Reading functionality for ${selectedIRSemester} will be implemented here.`);
        // For now, redirect back to semester selection
        showIRSemesterSelection();
      }
      
      function loadTeacherIndependentReading() {
        // Show teacher controls
        document.getElementById('teacher-ir-controls').classList.remove('hidden');
        
        // Load dashboard by default
        switchIRView('dashboard');
      }
      
      function loadStudentIndependentReading() {
        // Load student data
        google.script.run
          .withSuccessHandler(onIndependentReadingDataLoaded)
          .withFailureHandler(onIndependentReadingError)
          .getIndependentReadingData();
      }
      
      function switchIRView(view) {
        currentIRView = view;
        
        // Update button states
        document.querySelectorAll('.ir-view-toggle').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`ir-${view}-btn`).classList.add('active');
        
        // Hide all containers
        document.getElementById('ir-semesters-container').classList.add('hidden');
        document.getElementById('ir-dashboard-container').classList.add('hidden');
        
        if (view === 'dashboard') {
          loadIRDashboard();
        } else if (view === 'student') {
          loadTeacherStudentView();
        }
      }
      
      function loadTeacherStudentView() {
        // Show a demo student view for teachers
        document.getElementById('loading-ir').classList.remove('hidden');
        
        // Create demo data for teacher to see
        const demoData = {
          success: true,
          semester1: {
            title: "Example Book Title",
            author: "Example Author",
            reflections: [
              { date: "2024-01-15", pagesRead: "50", totalPages: "200", text: "This is an example reflection..." },
              { date: "", pagesRead: "", totalPages: "", text: "" },
              { date: "", pagesRead: "", totalPages: "", text: "" }
            ]
          },
          semester2: {
            title: "",
            author: "",
            reflections: [
              { date: "", pagesRead: "", totalPages: "", text: "" },
              { date: "", pagesRead: "", totalPages: "", text: "" },
              { date: "", pagesRead: "", totalPages: "", text: "" }
            ]
          }
        };
        
        // Simulate loading delay then show student interface
        setTimeout(() => {
          document.getElementById('loading-ir').classList.add('hidden');
          document.getElementById('ir-semesters-container').classList.remove('hidden');
          
          // Add teacher demo banner
          const existingBanner = document.getElementById('teacher-demo-banner');
          if (existingBanner) existingBanner.remove();
          
          const banner = document.createElement('div');
          banner.id = 'teacher-demo-banner';
          banner.style.cssText = `
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            border: 2px solid #2196f3;
          `;
          banner.innerHTML = '🎓 Teacher Demo Mode - This is how students see the Independent Reading interface';
          
          const container = document.getElementById('ir-semesters-container');
          container.insertBefore(banner, container.firstChild);
          
          // Populate with demo data
          populateIndependentReadingData(demoData.semester1, demoData.semester2);
          
          // Restore collapsed state
          setTimeout(() => restoreCollapsedState(), 100);
        }, 500);
      }
      
      function loadIRDashboard() {
        document.getElementById('loading-ir').classList.remove('hidden');
        google.script.run
          .withSuccessHandler(onIRDashboardLoaded)
          .withFailureHandler(onIndependentReadingError)
          .getIndependentReadingDashboard();
      }
      
      function onIRDashboardLoaded(response) {
        document.getElementById('loading-ir').classList.add('hidden');
        
        if (!response.success) {
          onIndependentReadingError({ message: response.error });
          return;
        }
        
        // Show dashboard container
        document.getElementById('ir-dashboard-container').classList.remove('hidden');
        
        // Populate stats
        const statsContainer = document.getElementById('ir-dashboard-stats');
        statsContainer.innerHTML = `
          <div class="ir-stat-card">
            <div class="ir-stat-number">${response.stats.totalStudents}</div>
            <div class="ir-stat-label">Total Students</div>
          </div>
          <div class="ir-stat-card">
            <div class="ir-stat-number">${response.stats.semester1Students}</div>
            <div class="ir-stat-label">Semester 1 Books</div>
          </div>
          <div class="ir-stat-card">
            <div class="ir-stat-number">${response.stats.semester2Students}</div>
            <div class="ir-stat-label">Semester 2 Books</div>
          </div>
          <div class="ir-stat-card">
            <div class="ir-stat-number">${response.stats.completedSemester1}</div>
            <div class="ir-stat-label">S1 Completed</div>
          </div>
          <div class="ir-stat-card">
            <div class="ir-stat-number">${response.stats.completedSemester2}</div>
            <div class="ir-stat-label">S2 Completed</div>
          </div>
        `;
        
        // Populate student table
        const tableContainer = document.getElementById('ir-student-progress-table');
        if (response.students.length === 0) {
          tableContainer.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <h3>No Student Data</h3>
              <p>No students have submitted independent reading data yet.</p>
            </div>
          `;
        } else {
          let tableHTML = `
            <table>
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Semester 1</th>
                  <th>S1 Progress</th>
                  <th>Semester 2</th>
                  <th>S2 Progress</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          response.students.forEach(student => {
            const s1Status = getProgressStatus(student.semester1);
            const s2Status = getProgressStatus(student.semester2);
            const s1Progress = student.semester1.reflectionsCompleted || 0;
            const s2Progress = student.semester2.reflectionsCompleted || 0;
            
            tableHTML += `
              <tr>
                <td><strong>${student.name}</strong></td>
                <td>
                  ${student.semester1.hasBook ? 
                    `"${student.semester1.bookTitle}" by ${student.semester1.bookAuthor}` : 
                    '<span style="color: #6c757d;">No book selected</span>'}
                </td>
                <td>
                  <div class="ir-progress-bar">
                    <div class="ir-progress-fill ir-progress-semester1" style="width: ${(s1Progress / 3) * 100}%">
                      ${s1Progress}/3
                    </div>
                  </div>
                </td>
                <td>
                  ${student.semester2.hasBook ? 
                    `"${student.semester2.bookTitle}" by ${student.semester2.bookAuthor}` : 
                    '<span style="color: #6c757d;">No book selected</span>'}
                </td>
                <td>
                  <div class="ir-progress-bar">
                    <div class="ir-progress-fill ir-progress-semester2" style="width: ${(s2Progress / 3) * 100}%">
                      ${s2Progress}/3
                    </div>
                  </div>
                </td>
              </tr>
            `;
          });
          
          tableHTML += `</tbody></table>`;
          tableContainer.innerHTML = tableHTML;
        }
      }
      
      function getProgressStatus(semesterData) {
        if (!semesterData.hasBook) return 'not-started';
        if (semesterData.reflectionsCompleted === 3) return 'completed';
        return 'in-progress';
      }
      
      function toggleSemester(semesterId) {
        const content = document.getElementById(`${semesterId}-content`);
        const title = document.querySelector(`[onclick="toggleSemester('${semesterId}')"]`);
        
        content.classList.toggle('collapsed');
        title.classList.toggle('collapsed');
        
        // Save collapsed state to localStorage
        const collapsedSemesters = JSON.parse(localStorage.getItem('collapsedSemesters') || '[]');
        const isCollapsed = content.classList.contains('collapsed');
        
        if (isCollapsed && !collapsedSemesters.includes(semesterId)) {
          collapsedSemesters.push(semesterId);
        } else if (!isCollapsed && collapsedSemesters.includes(semesterId)) {
          const index = collapsedSemesters.indexOf(semesterId);
          collapsedSemesters.splice(index, 1);
        }
        
        localStorage.setItem('collapsedSemesters', JSON.stringify(collapsedSemesters));
      }
      
      function restoreCollapsedState() {
        const collapsedSemesters = JSON.parse(localStorage.getItem('collapsedSemesters') || '[]');
        collapsedSemesters.forEach(semesterId => {
          const content = document.getElementById(`${semesterId}-content`);
          const title = document.querySelector(`[onclick="toggleSemester('${semesterId}')"]`);
          if (content && title) {
            content.classList.add('collapsed');
            title.classList.add('collapsed');
          }
        });
      }
      
      function onIndependentReadingDataLoaded(response) {
        document.getElementById('loading-ir').classList.add('hidden');
        
        if (!response.success) {
          onIndependentReadingError({ message: response.error });
          return;
        }
        
        // Show teacher controls if user is teacher
        if (isTeacher) {
          document.getElementById('teacher-ir-controls').classList.remove('hidden');
        }
        
        // Show semester containers
        document.getElementById('ir-semesters-container').classList.remove('hidden');
        
        // Populate data
        populateIndependentReadingData(response.semester1, response.semester2);
        
        // Restore collapsed state
        setTimeout(() => restoreCollapsedState(), 100);
      }
      
      function onIndependentReadingError(error) {
        document.getElementById('loading-ir').classList.add('hidden');
        document.getElementById('ir-semesters-container').innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h3>Error Loading Independent Reading</h3>
            <p>${error.message}</p>
            <button onclick="showIndependentReading()" class="got-it-btn">Try Again</button>
          </div>
        `;
        document.getElementById('ir-semesters-container').classList.remove('hidden');
      }
      
      function populateIndependentReadingData(semester1Data, semester2Data) {
        // Populate Semester 1
        if (semester1Data && semester1Data.title) {
          document.getElementById('s1-book-title').value = semester1Data.title;
          document.getElementById('s1-book-author').value = semester1Data.author || '';
          
          if (semester1Data.reflections) {
            semester1Data.reflections.forEach((reflection, index) => {
              const prefix = `s1-r${index + 1}`;
              document.getElementById(`${prefix}-date`).value = reflection.date || '';
              document.getElementById(`${prefix}-pages-read`).value = reflection.pagesRead || '';
              document.getElementById(`${prefix}-total-pages`).value = reflection.totalPages || '';
              document.getElementById(`${prefix}-text`).value = reflection.text || '';
            });
          }
        }
        
        // Populate Semester 2
        if (semester2Data && semester2Data.title) {
          document.getElementById('s2-book-title').value = semester2Data.title;
          document.getElementById('s2-book-author').value = semester2Data.author || '';
          
          if (semester2Data.reflections) {
            semester2Data.reflections.forEach((reflection, index) => {
              const prefix = `s2-r${index + 1}`;
              document.getElementById(`${prefix}-date`).value = reflection.date || '';
              document.getElementById(`${prefix}-pages-read`).value = reflection.pagesRead || '';
              document.getElementById(`${prefix}-total-pages`).value = reflection.totalPages || '';
              document.getElementById(`${prefix}-text`).value = reflection.text || '';
            });
          }
        }
      }
      
      function saveReflection(semester, reflectionIndex) {
        const semesterCode = semester === 'Semester 1' ? 's1' : 's2';
        const reflectionCode = `r${reflectionIndex + 1}`;
        
        // Get book info
        const bookTitle = document.getElementById(`${semesterCode}-book-title`).value.trim();
        const bookAuthor = document.getElementById(`${semesterCode}-book-author`).value.trim();
        
        // Get reflection info
        const date = document.getElementById(`${semesterCode}-${reflectionCode}-date`).value;
        const pagesRead = document.getElementById(`${semesterCode}-${reflectionCode}-pages-read`).value;
        const totalPages = document.getElementById(`${semesterCode}-${reflectionCode}-total-pages`).value;
        const reflectionText = document.getElementById(`${semesterCode}-${reflectionCode}-text`).value.trim();
        
        // Validation
        if (!bookTitle) {
          alert('Please enter a book title before saving reflections.');
          document.getElementById(`${semesterCode}-book-title`).focus();
          return;
        }
        
        if (!bookAuthor) {
          alert('Please enter the book author before saving reflections.');
          document.getElementById(`${semesterCode}-book-author`).focus();
          return;
        }
        
        if (!date || !pagesRead || !totalPages || !reflectionText) {
          alert('Please fill in all fields for this reflection.');
          return;
        }
        
        // Find the save button and show saving state
        const saveBtn = event.target;
        const originalText = saveBtn.textContent;
        saveBtn.textContent = '💾 Saving...';
        saveBtn.disabled = true;
        
        // Save to backend
        google.script.run
          .withSuccessHandler(() => {
            saveBtn.textContent = '✅ Saved!';
            setTimeout(() => {
              saveBtn.textContent = originalText;
              saveBtn.disabled = false;
            }, 2000);
          })
          .withFailureHandler((error) => {
            saveBtn.textContent = '❌ Save Failed';
            setTimeout(() => {
              saveBtn.textContent = originalText;
              saveBtn.disabled = false;
            }, 2000);
            console.error('Save failed:', error);
            alert('Save failed: ' + error.message);
          })
          .saveIndependentReadingData(semester, bookTitle, bookAuthor, reflectionIndex, date, pagesRead, totalPages, reflectionText);
      }
      
      function showAllStudentReading() {
        showScreen('teacher-ir-screen');
        
        // Show loading
        document.getElementById('loading-teacher-ir').classList.remove('hidden');
        document.getElementById('teacher-ir-data').classList.add('hidden');
        
        // Load all student data
        google.script.run
          .withSuccessHandler(onAllStudentReadingLoaded)
          .withFailureHandler(onAllStudentReadingError)
          .getAllIndependentReadingData();
      }
      
      function onAllStudentReadingLoaded(response) {
        document.getElementById('loading-teacher-ir').classList.add('hidden');
        
        if (!response.success) {
          onAllStudentReadingError({ message: response.error });
          return;
        }
        
        const container = document.getElementById('teacher-ir-data');
        
        if (!response.students || response.students.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <h3>No Student Data</h3>
              <p>No students have submitted independent reading data yet.</p>
            </div>
          `;
        } else {
          // Group students by name and semester
          const studentGroups = {};
          response.students.forEach(entry => {
            const key = entry.studentName;
            if (!studentGroups[key]) {
              studentGroups[key] = { semester1: null, semester2: null };
            }
            if (entry.semester === 'Semester 1') {
              studentGroups[key].semester1 = entry;
            } else if (entry.semester === 'Semester 2') {
              studentGroups[key].semester2 = entry;
            }
          });
          
          let html = '';
          Object.entries(studentGroups).forEach(([studentName, data]) => {
            html += `
              <div class="teacher-ir-student">
                <div class="teacher-ir-student-name">${studentName}</div>
            `;
            
            // Semester 1
            if (data.semester1) {
              html += `
                <div class="teacher-ir-book">
                  <div class="teacher-ir-book-title">Semester 1: "${data.semester1.bookTitle}" by ${data.semester1.bookAuthor}</div>
                  ${data.semester1.reflections.map((reflection, index) => {
                    if (reflection.date || reflection.text) {
                      return `
                        <div class="teacher-ir-reflection">
                          <div class="teacher-ir-reflection-header">Reflection ${index + 1} - ${reflection.date} (${reflection.pagesRead}/${reflection.totalPages} pages)</div>
                          <div>${reflection.text || 'No reflection text'}</div>
                        </div>
                      `;
                    }
                    return '';
                  }).join('')}
                </div>
              `;
            }
            
            // Semester 2
            if (data.semester2) {
              html += `
                <div class="teacher-ir-book">
                  <div class="teacher-ir-book-title">Semester 2: "${data.semester2.bookTitle}" by ${data.semester2.bookAuthor}</div>
                  ${data.semester2.reflections.map((reflection, index) => {
                    if (reflection.date || reflection.text) {
                      return `
                        <div class="teacher-ir-reflection">
                          <div class="teacher-ir-reflection-header">Reflection ${index + 1} - ${reflection.date} (${reflection.pagesRead}/${reflection.totalPages} pages)</div>
                          <div>${reflection.text || 'No reflection text'}</div>
                        </div>
                      `;
                    }
                    return '';
                  }).join('')}
                </div>
              `;
            }
            
            if (!data.semester1 && !data.semester2) {
              html += `<p style="color: #666; font-style: italic;">No reading data submitted yet.</p>`;
            }
            
            html += `</div>`;
          });
          
          container.innerHTML = html;
        }
        
        document.getElementById('teacher-ir-data').classList.remove('hidden');
      }
      
      function onAllStudentReadingError(error) {
        document.getElementById('loading-teacher-ir').classList.add('hidden');
        document.getElementById('teacher-ir-data').innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h3>Error Loading Student Data</h3>
            <p>${error.message}</p>
            <button onclick="showAllStudentReading()" class="got-it-btn">Try Again</button>
          </div>
        `;
        document.getElementById('teacher-ir-data').classList.remove('hidden');
      }
      
      // Learning Portfolio Functions
      
      function showLearningPortfolio() {
        showScreen('learning-portfolio-screen');
        loadPortfolioUnits();
      }
      
      
      
      function loadPortfolioUnits() {
        // Show loading state within the portfolio screen instead of switching screens
        const container = document.getElementById('portfolio-unit-grid');
        container.innerHTML = '<div class="loading-indicator"><div class="spinner"></div><p>Loading portfolio units...</p></div>';
        
        google.script.run
          .withSuccessHandler(onPortfolioSummaryLoaded)
          .withFailureHandler(onLoadError)
          .getPortfolioSummary();
      }
      
      function onPortfolioSummaryLoaded(response) {
        if (!response.success) {
          onLoadError({ message: response.error });
          return;
        }
        
        portfolioUnits = response.enabledUnits;
        displayPortfolioUnits(response.unitSummaries);
        
        // Ensure the portfolio unit grid is visible
        document.getElementById('portfolio-unit-grid').style.display = 'grid';
      }
      
      function displayPortfolioUnits(unitSummaries) {
        const container = document.getElementById('portfolio-unit-grid');
        container.innerHTML = '';
        
        unitSummaries.forEach(unitData => {
          const button = document.createElement('a');
          button.className = 'unit-button';
          button.href = '#';
          button.onclick = (e) => {
            e.preventDefault();
            handlePortfolioUnitClick(unitData.unit, e);
          };
          
          let toggleHTML = '';
          if (isTeacher) {
            const isEnabled = portfolioUnitSettings[unitData.unit] !== false; // Default to true if not set
            
            toggleHTML = `
              <div class="unit-toggle-wrapper" onclick="event.stopPropagation()">
                <label class="unit-inline-toggle">
                  <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="handlePortfolioUnitToggle('${unitData.unit}', this.checked, this)">
                  <span class="unit-inline-slider"></span>
                </label>
              </div>
            `;
          }
          
          let progressText = unitData.status;
          if (unitData.targetCount) {
            progressText += ` (${unitData.targetCount} targets)`;
          }
          
          button.innerHTML = `
            ${toggleHTML}
            <div class="unit-title">${unitData.unit}</div>
            <div class="unit-progress">${progressText}</div>
          `;
          container.appendChild(button);
        });
        
        // Set up back to main button
        document.getElementById('back-to-main-from-portfolio-btn').onclick = () => {
          showScreen('main-landing-screen');
        };
        
        showScreen('learning-portfolio-screen');
      }
      
      function handlePortfolioUnitClick(unitName, event) {
        // Prevent click if it's from the toggle area
        if (event && event.target.closest('.unit-toggle-wrapper')) {
          return;
        }
        
        currentPortfolioUnit = unitName;
        
        if (isTeacher) {
          // Show teacher modal
          showPortfolioTeacherModal(unitName);
        } else {
          // Students go directly to learning targets
          showUnitPortfolio(unitName);
        }
      }
      
      function showUnitPortfolio(unitName) {
        currentPortfolioUnit = unitName;
        document.getElementById('unit-portfolio-title').textContent = `${unitName} - Learning Portfolio`;
        
        // Show loading state
        document.getElementById('loading-targets').classList.remove('hidden');
        document.getElementById('targets-content').innerHTML = '';
        showScreen('unit-portfolio-screen');
        
        // All units now use the three-phase system
        const promises = [
          new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getLearningTargetsFromSheet(unitName);
          })
        ];
        
        // Only load student proficiency data for students, not teachers
        if (!isTeacher) {
          promises.push(
            new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .getLearningPortfolioData(unitName);
            })
          );
        }
        
        Promise.all(promises).then((responses) => {
          document.getElementById('loading-targets').classList.add('hidden');
          
          const targetsResponse = responses[0];
          const proficiencyResponse = responses[1] || { success: true, proficiencyData: {} };
          
          if (!targetsResponse.success) {
            throw new Error(targetsResponse.error);
          }
          if (!proficiencyResponse.success) {
            throw new Error(proficiencyResponse.error);
          }
          
          learningTargetsData = targetsResponse.targets;
          studentProficiencyData = proficiencyResponse.proficiencyData || {};
          
          console.log(`[initializeApp] studentProficiencyData initialized:`, studentProficiencyData);
          console.log(`[initializeApp] proficiencyResponse:`, proficiencyResponse);
          
          // Store proficiency options for display
          window.proficiencyOptions = targetsResponse.proficiencyOptions;
          
          displayThreePhases();
        }).catch(error => {
          document.getElementById('loading-targets').classList.add('hidden');
          onLoadError({ message: error.message || error.toString() });
        });
      }
      
      function displayThreePhases() {
        const container = document.getElementById('targets-content');
        
        if (learningTargetsData.length === 0) {
          container.innerHTML = '<p>No learning targets have been set up for this unit yet.</p>';
          return;
        }
        
        const phases = ['Beginning', 'Middle', 'End'];
        
        // Create table-style layout with learning targets as rows and phases as columns
        const targetsRowsHTML = learningTargetsData.map(target => {
          const phaseCellsHTML = phases.map(phase => {
            const currentLevel = (studentProficiencyData[target.target] && studentProficiencyData[target.target][phase]) || 0;
            
            if (isTeacher) {
              // Teacher view - interactive dropdowns that don't save
              return `
                <td class="phase-cell">
                  <select onchange="teacherDemoDropdown(this)" 
                          data-target="${target.target}" data-phase="${phase}"
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa;">
                    <option value="0">Not Started</option>
                    ${window.proficiencyOptions ? window.proficiencyOptions.map(option => 
                      `<option value="${option.value}">${option.label}</option>`
                    ).join('') : 
                    `<option value="1">Beginning</option>
                     <option value="2">Developing</option>
                     <option value="3">Proficient</option>
                     <option value="4">Mastery</option>`}
                  </select>
                </td>
              `;
            } else {
              // Student view - interactive dropdowns that save
              return `
                <td class="phase-cell">
                  <select onchange="updateThreePhaseProficiencyLevel('${target.target}', '${phase}', this.value)" 
                          data-target="${target.target}" data-phase="${phase}"
                          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="0" ${currentLevel == 0 ? 'selected' : ''}>Not Started</option>
                    ${window.proficiencyOptions ? window.proficiencyOptions.map(option => 
                      `<option value="${option.value}" ${currentLevel == option.value ? 'selected' : ''}>${option.label}</option>`
                    ).join('') : 
                    `<option value="1" ${currentLevel == 1 ? 'selected' : ''}>Beginning</option>
                     <option value="2" ${currentLevel == 2 ? 'selected' : ''}>Developing</option>
                     <option value="3" ${currentLevel == 3 ? 'selected' : ''}>Proficient</option>
                     <option value="4" ${currentLevel == 4 ? 'selected' : ''}>Mastery</option>`}
                  </select>
                </td>
              `;
            }
          }).join('');
          
          return `
            <tr class="target-row">
              <td class="target-name">
                <div class="target-title">${target.target}</div>
              </td>
              ${phaseCellsHTML}
            </tr>
          `;
        }).join('');
        
        container.innerHTML = `
          ${isTeacher ? 
            '<div style="background-color: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;"><strong>Teacher View:</strong> You can interact with the dropdowns to see how they work for students. Your selections are for demonstration only and will not be saved.</div>' : 
            ''}
          <div class="unit1-grid-container">
            <table class="unit1-proficiency-table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
              <thead>
                <tr>
                  <th style="text-align: left; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; font-family: 'Patrick Hand', cursive; font-size: 1.2em;">Learning Target</th>
                  <th style="text-align: center; padding: 15px; background-color: #fff8e1; border: 1px solid #ffc107; font-family: 'Patrick Hand', cursive; font-size: 1.2em; color: #f57c00;">Beginning</th>
                  <th style="text-align: center; padding: 15px; background-color: #e3f2fd; border: 1px solid #2196f3; font-family: 'Patrick Hand', cursive; font-size: 1.2em; color: #0277bd;">Middle</th>
                  <th style="text-align: center; padding: 15px; background-color: #e8f5e8; border: 1px solid #4caf50; font-family: 'Patrick Hand', cursive; font-size: 1.2em; color: #2e7d32;">End</th>
                </tr>
              </thead>
              <tbody>
                ${targetsRowsHTML}
              </tbody>
            </table>
          </div>
        `;
        
        // Set up navigation buttons
        document.getElementById('back-to-portfolio-btn').onclick = () => {
          // Both teachers and students go back to the portfolio unit selection
          showScreen('learning-portfolio-screen');
        };
        
        if (isTeacher) {
          // Hide save button for teachers and update back button text
          document.getElementById('save-portfolio-btn').style.display = 'none';
          document.getElementById('back-to-portfolio-btn').textContent = '← Back to Portfolio';
        } else {
          document.getElementById('save-portfolio-btn').onclick = () => {
            saveAllProficiencyLevels();
          };
        }
      }

      function displayLearningTargets() {
        console.log(`[displayLearningTargets] currentPortfolioUnit: "${currentPortfolioUnit}"`);
        console.log(`[displayLearningTargets] studentProficiencyData:`, studentProficiencyData);
        
        const container = document.getElementById('targets-content');
        const unitProficiencyData = studentProficiencyData[currentPortfolioUnit] || {};
        
        if (learningTargetsData.length === 0) {
          container.innerHTML = '<p>No learning targets have been set up for this unit yet.</p>';
          return;
        }
        
        container.innerHTML = learningTargetsData.map(target => {
          const currentLevel = unitProficiencyData[target.target] || 0;
          
          return `
            <div class="learning-target-item">
              <div class="target-title">${target.target}</div>
              <div class="target-description">${target.description}</div>
              <div class="proficiency-selector">
                <label>My current level:</label>
                <div class="proficiency-option">
                  <input type="radio" name="proficiency-${target.target}" value="0" ${currentLevel == 0 ? 'checked' : ''} onchange="updateProficiencyLevel('${target.target}', 0)">
                  <span class="proficiency-not-started">Not Started</span>
                </div>
                <div class="proficiency-option">
                  <input type="radio" name="proficiency-${target.target}" value="1" ${currentLevel == 1 ? 'checked' : ''} onchange="updateProficiencyLevel('${target.target}', 1)">
                  <span class="proficiency-developing">Developing</span>
                </div>
                <div class="proficiency-option">
                  <input type="radio" name="proficiency-${target.target}" value="2" ${currentLevel == 2 ? 'checked' : ''} onchange="updateProficiencyLevel('${target.target}', 2)">
                  <span class="proficiency-proficient">Proficient</span>
                </div>
                <div class="proficiency-option">
                  <input type="radio" name="proficiency-${target.target}" value="3" ${currentLevel == 3 ? 'checked' : ''} onchange="updateProficiencyLevel('${target.target}', 3)">
                  <span class="proficiency-mastered">Mastered</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        // Set up navigation buttons
        document.getElementById('back-to-portfolio-btn').onclick = () => {
          showLearningPortfolio();
        };
        
        document.getElementById('save-portfolio-btn').onclick = () => {
          saveAllProficiencyLevels();
        };
      }
      
      function updateProficiencyLevel(learningTarget, level) {
        // Update local data
        if (!studentProficiencyData[currentPortfolioUnit]) {
          studentProficiencyData[currentPortfolioUnit] = {};
        }
        studentProficiencyData[currentPortfolioUnit][learningTarget] = parseInt(level);
        
        // Auto-save to backend (optional - can be disabled for manual save only)
        google.script.run
          .withSuccessHandler(() => {
            console.log(`Auto-saved ${learningTarget}: ${level}`);
          })
          .withFailureHandler((error) => {
            console.error('Auto-save failed:', error);
          })
          .saveStudentProficiency(currentPortfolioUnit, learningTarget, parseInt(level));
      }
      
      function saveAllProficiencyLevels() {
        const saveButton = document.getElementById('save-portfolio-btn');
        const originalText = saveButton.textContent;
        saveButton.textContent = '💾 Saving...';
        saveButton.disabled = true;
        
        // Get all current selections and save them
        const targets = learningTargetsData;
        const savePromises = targets.map(target => {
          const selectedRadio = document.querySelector(`input[name="proficiency-${target.target}"]:checked`);
          if (selectedRadio) {
            const level = parseInt(selectedRadio.value);
            return new Promise((resolve, reject) => {
              google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                .saveStudentProficiency(currentPortfolioUnit, target.target, level);
            });
          }
          return Promise.resolve();
        });
        
        Promise.all(savePromises).then(() => {
          saveButton.textContent = '✅ Saved!';
          setTimeout(() => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          }, 2000);
        }).catch(error => {
          saveButton.textContent = '❌ Save Failed';
          setTimeout(() => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          }, 2000);
          console.error('Save failed:', error);
        });
      }
      
      function handlePortfolioUnitToggle(unitName, isEnabled, toggleElement) {
        // This function is for teachers to toggle portfolio units (similar to regular unit toggles)
        portfolioUnitSettings[unitName] = isEnabled;
        
        // For now, we'll use the same backend as regular unit settings
        // In a full implementation, you might want separate portfolio unit settings
        google.script.run
          .withSuccessHandler(() => {
            console.log(`Portfolio unit ${unitName} ${isEnabled ? 'enabled' : 'disabled'}`);
          })
          .withFailureHandler((error) => {
            portfolioUnitSettings[unitName] = !isEnabled;
            toggleElement.checked = !isEnabled;
            onLoadError({ message: error.message });
          })
          .updateTeacherUnitSettings(unitName, isEnabled);
      }
      
      // Portfolio Teacher Choice Functions
      function showPortfolioTeacherChoice(unitName) {
        document.getElementById('portfolio-choice-unit-title').textContent = unitName;
        
        // Set up button handlers
        document.getElementById('portfolio-view-as-student-btn').onclick = () => {
          showUnitPortfolio(unitName);
        };
        
        document.getElementById('portfolio-teacher-dashboard-btn').onclick = () => {
          showPortfolioTeacherDashboard(unitName);
        };
        
        document.getElementById('portfolio-edit-targets-btn').onclick = () => {
          showPortfolioEditTargets(unitName);
        };
        
        document.getElementById('back-to-portfolio-units-btn').onclick = () => {
          showScreen('learning-portfolio-screen');
        };
        
        showScreen('portfolio-teacher-choice-screen');
      }
      
      // Portfolio Teacher Modal Functions
      function showPortfolioTeacherModal(unitName) {
        document.getElementById('portfolio-modal-unit-title').textContent = unitName;
        document.getElementById('portfolio-teacher-modal').classList.add('show');
        
        // Set up modal event handlers
        document.querySelector('#portfolio-teacher-modal .close').onclick = closePortfolioTeacherModal;
        document.getElementById('portfolio-view-student-btn').onclick = () => {
          closePortfolioTeacherModal();
          showUnitPortfolio(unitName);
        };
        document.getElementById('portfolio-dashboard-btn').onclick = () => {
          closePortfolioTeacherModal();
          showPortfolioTeacherDashboard(unitName);
        };
        document.getElementById('portfolio-edit-btn').onclick = () => {
          closePortfolioTeacherModal();
          showPortfolioEditTargets(unitName);
        };
        
        // Close modal when clicking outside
        window.onclick = (event) => {
          if (event.target === document.getElementById('portfolio-teacher-modal')) {
            closePortfolioTeacherModal();
          }
        };
      }

      function closePortfolioTeacherModal() {
        document.getElementById('portfolio-teacher-modal').classList.remove('show');
      }
      
      function showPortfolioTeacherDashboard(unitName) {
        document.getElementById('dashboard-unit-title').textContent = unitName;
        
        // Show loading state
        document.getElementById('loading-dashboard').classList.remove('hidden');
        document.getElementById('dashboard-results-container').classList.add('hidden');
        showScreen('portfolio-teacher-dashboard-screen');
        
        // Load student proficiency data for this unit
        google.script.run
          .withSuccessHandler(onPortfolioDashboardLoaded)
          .withFailureHandler(onPortfolioDashboardError)
          .getPortfolioStudentData(unitName);
      }
      
      function onPortfolioDashboardLoaded(response) {
        document.getElementById('loading-dashboard').classList.add('hidden');
        
        if (!response.success) {
          onLoadError({ message: response.error });
          return;
        }
        
        displayPortfolioDashboard(response.data);
        document.getElementById('dashboard-results-container').classList.remove('hidden');
        
        // Set up dashboard button handlers
        document.getElementById('back-to-portfolio-choice-btn').onclick = () => {
          showScreen('learning-portfolio-screen');
        };
        
        document.getElementById('export-dashboard-btn').onclick = () => {
          exportDashboardData();
        };
      }
      
      function onPortfolioDashboardError(error) {
        document.getElementById('loading-dashboard').classList.add('hidden');
        onLoadError({ message: error.message || error.toString() });
      }
      
      function displayPortfolioDashboard(data) {
        const tableBody = document.getElementById('dashboard-table-body');
        tableBody.innerHTML = '';
        
        if (!data || data.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No student data found for this unit.</td></tr>';
          return;
        }
        
        data.forEach(entry => {
          const row = document.createElement('tr');
          
          const proficiencyText = getProficiencyText(entry.proficiencyLevel);
          const proficiencyClass = getProficiencyClass(entry.proficiencyLevel);
          const lastUpdated = entry.lastUpdated ? new Date(entry.lastUpdated).toLocaleDateString() : 'Never';
          
          row.innerHTML = `
            <td>${entry.studentName}</td>
            <td>${entry.learningTarget}</td>
            <td>${entry.phase}</td>
            <td class="${proficiencyClass}">${proficiencyText}</td>
            <td>${lastUpdated}</td>
          `;
          
          tableBody.appendChild(row);
        });
      }
      
      function getProficiencyText(level) {
        switch(parseInt(level)) {
          case 0: return 'Not Started';
          case 1: return 'Beginning';
          case 2: return 'Developing';
          case 3: return 'Proficient';
          case 4: return 'Mastery';
          default: return 'Unknown';
        }
      }
      
      function getProficiencyClass(level) {
        switch(parseInt(level)) {
          case 0: return 'proficiency-beginning';
          case 1: return 'proficiency-beginning';
          case 2: return 'proficiency-developing';
          case 3: return 'proficiency-proficient';
          case 4: return 'proficiency-mastery';
          default: return '';
        }
      }
      
      function showPortfolioEditTargets(unitName) {
        document.getElementById('edit-targets-unit-title').textContent = unitName;
        
        // Show loading state
        document.getElementById('loading-edit-targets').classList.remove('hidden');
        document.getElementById('edit-targets-container').classList.add('hidden');
        showScreen('portfolio-edit-targets-screen');
        
        // Load learning targets for editing
        google.script.run
          .withSuccessHandler(onEditTargetsLoaded)
          .withFailureHandler(onEditTargetsError)
          .getLearningTargetsFromSheet(unitName);
      }
      
      function onEditTargetsLoaded(response) {
        document.getElementById('loading-edit-targets').classList.add('hidden');
        
        if (!response.success) {
          onLoadError({ message: response.error });
          return;
        }
        
        displayEditTargets(response.targets);
        setupEditTargetsHandlers();
        document.getElementById('edit-targets-container').classList.remove('hidden');
      }
      
      function onEditTargetsError(error) {
        document.getElementById('loading-edit-targets').classList.add('hidden');
        onLoadError({ message: error.message || error.toString() });
      }
      
      function displayEditTargets(targets) {
        const container = document.getElementById('existing-targets-list');
        container.innerHTML = '';
        
        if (targets.length === 0) {
          container.innerHTML = '<p>No learning targets found for this unit.</p>';
          return;
        }
        
        targets.forEach((target, index) => {
          const targetDiv = document.createElement('div');
          targetDiv.className = 'target-edit-item';
          targetDiv.innerHTML = `
            <input type="text" class="target-edit-text" value="${target.target}" data-index="${index}">
            <div class="target-phases">
              <label><input type="checkbox" ${target.beginning ? 'checked' : ''} data-index="${index}" data-phase="beginning"> Beginning</label>
              <label><input type="checkbox" ${target.middle ? 'checked' : ''} data-index="${index}" data-phase="middle"> Middle</label>
              <label><input type="checkbox" ${target.end ? 'checked' : ''} data-index="${index}" data-phase="end"> End</label>
              <label><input type="checkbox" ${target.single ? 'checked' : ''} data-index="${index}" data-phase="single"> Single Phase</label>
            </div>
            <div class="target-actions">
              <button class="exemplar-nav-btn" onclick="deleteTarget(${index})">🗑️ Delete</button>
            </div>
          `;
          container.appendChild(targetDiv);
        });
      }
      
      function setupEditTargetsHandlers() {
        // Set up navigation buttons
        document.getElementById('back-to-portfolio-choice-from-edit-btn').onclick = () => {
          showScreen('learning-portfolio-screen');
        };
        
        document.getElementById('back-to-portfolio-choice-btn').onclick = () => {
          showScreen('learning-portfolio-screen');
        };
        
        // Set up add new target button
        document.getElementById('add-new-target-btn').onclick = () => {
          addNewTarget();
        };
        
        // Set up save changes button
        document.getElementById('save-targets-changes-btn').onclick = () => {
          saveTargetChanges();
        };
        
        // Set up export button
        document.getElementById('export-dashboard-btn').onclick = () => {
          exportDashboardData();
        };
      }
      
      function addNewTarget() {
        const targetText = document.getElementById('new-target-text').value.trim();
        if (!targetText) {
          alert('Please enter a learning target description.');
          return;
        }
        
        const phases = {
          beginning: document.getElementById('new-target-beginning').checked,
          middle: document.getElementById('new-target-middle').checked,
          end: document.getElementById('new-target-end').checked,
          single: document.getElementById('new-target-single').checked
        };
        
        // At least one phase must be selected
        if (!phases.beginning && !phases.middle && !phases.end && !phases.single) {
          alert('Please select at least one phase for the learning target.');
          return;
        }
        
        // Add to backend
        google.script.run
          .withSuccessHandler(() => {
            // Clear form and reload targets
            document.getElementById('new-target-text').value = '';
            document.getElementById('new-target-beginning').checked = true;
            document.getElementById('new-target-middle').checked = true;
            document.getElementById('new-target-end').checked = true;
            document.getElementById('new-target-single').checked = false;
            
            // Reload the edit targets view
            showPortfolioEditTargets(currentPortfolioUnit);
          })
          .withFailureHandler(onLoadError)
          .addLearningTarget(currentPortfolioUnit, targetText, phases);
      }
      
      function deleteTarget(index) {
        if (confirm('Are you sure you want to delete this learning target?')) {
          const targetText = document.querySelector(`[data-index="${index}"]`).value;
          
          google.script.run
            .withSuccessHandler(() => {
              // Reload the edit targets view
              showPortfolioEditTargets(currentPortfolioUnit);
            })
            .withFailureHandler(onLoadError)
            .deleteLearningTarget(currentPortfolioUnit, targetText);
        }
      }
      
      function saveTargetChanges() {
        const changes = [];
        const targetInputs = document.querySelectorAll('.target-edit-text');
        
        targetInputs.forEach((input, index) => {
          const phases = {
            beginning: document.querySelector(`[data-index="${index}"][data-phase="beginning"]`).checked,
            middle: document.querySelector(`[data-index="${index}"][data-phase="middle"]`).checked,
            end: document.querySelector(`[data-index="${index}"][data-phase="end"]`).checked,
            single: document.querySelector(`[data-index="${index}"][data-phase="single"]`).checked
          };
          
          changes.push({
            index: index,
            target: input.value.trim(),
            phases: phases
          });
        });
        
        google.script.run
          .withSuccessHandler(() => {
            alert('Changes saved successfully!');
            // Reload the edit targets view
            showPortfolioEditTargets(currentPortfolioUnit);
          })
          .withFailureHandler(onLoadError)
          .updateLearningTargets(currentPortfolioUnit, changes);
      }
      
      function exportDashboardData() {
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              // Create and download CSV
              const csvContent = response.csvData;
              const blob = new Blob([csvContent], { type: 'text/csv' });
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `portfolio_dashboard_${currentPortfolioUnit}_${new Date().toISOString().split('T')[0]}.csv`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
            } else {
              onLoadError({ message: response.error });
            }
          })
          .withFailureHandler(onLoadError)
          .exportPortfolioDashboard(currentPortfolioUnit);
      }
      
      // Three-Phase Functions
      function updateThreePhaseProficiencyLevel(learningTarget, phase, level) {
        // Update local data
        if (!studentProficiencyData[learningTarget]) {
          studentProficiencyData[learningTarget] = {};
        }
        studentProficiencyData[learningTarget][phase] = parseInt(level);
        
        // Auto-save to backend using Unit 1 specific function
        google.script.run
          .withSuccessHandler(() => {
            console.log(`Auto-saved ${learningTarget} ${phase}: ${level}`);
            // Show brief visual feedback
            const selector = document.querySelector(`select[data-target="${learningTarget}"][data-phase="${phase}"]`);
            if (selector) {
              const originalBg = selector.style.backgroundColor;
              selector.style.backgroundColor = '#d1e7dd';
              setTimeout(() => {
                selector.style.backgroundColor = originalBg;
              }, 1000);
            }
          })
          .withFailureHandler((error) => {
            console.error('Auto-save failed:', error);
            // Show error feedback
            const selector = document.querySelector(`select[data-target="${learningTarget}"][data-phase="${phase}"]`);
            if (selector) {
              const originalBg = selector.style.backgroundColor;
              selector.style.backgroundColor = '#f8d7da';
              setTimeout(() => {
                selector.style.backgroundColor = originalBg;
              }, 2000);
            }
          })
          .saveLearningPortfolioProficiency(learningTarget, parseInt(level), phase);
      }
      
      function saveAllProficiencyLevels() {
        const saveButton = document.getElementById('save-portfolio-btn');
        const originalText = saveButton.textContent;
        saveButton.textContent = '💾 Saving...';
        saveButton.disabled = true;
        
        // Get all current selections from the new grid layout and save them
        const targets = learningTargetsData;
        const phases = ['Beginning', 'Middle', 'End'];
        const savePromises = [];
        
        targets.forEach(target => {
          phases.forEach(phase => {
            const selector = document.querySelector(`select[data-target="${target.target}"][data-phase="${phase}"]`);
            if (selector && selector.value !== undefined) {
              const level = parseInt(selector.value);
              savePromises.push(new Promise((resolve, reject) => {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .saveLearningPortfolioProficiency(target.target, level, phase);
              }));
            }
          });
        });
        
        Promise.all(savePromises).then(() => {
          saveButton.textContent = '✅ All Saved!';
          setTimeout(() => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          }, 2000);
        }).catch(error => {
          saveButton.textContent = '❌ Save Failed';
          setTimeout(() => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          }, 2000);
          console.error('Save failed:', error);
        });
      }
      
      // Teacher demo dropdown function (non-saving)
      function teacherDemoDropdown(selectElement) {
        // This function is called when teachers interact with dropdowns
        // It provides visual feedback but doesn't save data
        console.log(`Teacher demo: Selected ${selectElement.value} for ${selectElement.dataset.target} - ${selectElement.dataset.phase}`);
        
        // Optional: Add visual feedback that it's demo only
        selectElement.style.backgroundColor = '#fff3cd';
        setTimeout(() => {
          selectElement.style.backgroundColor = '#f8f9fa';
        }, 1000);
      }

      // --- STATE STANDARDS ALIGNMENT FUNCTIONALITY ---
      
      // Global variables for standards data
      let standardsData = {
        unitData: null,
        allStandards: []
      };
      let selectedUnit = null;




      // Global standards data cache
      let standardsDataCache = null;
      let currentSelectedUnit = null;
      let isLoadingStandards = false;
      
      // Unit-specific cache for processed table data
      let unitTableCache = new Map();
      let isTableStructureReady = false;

      // Standards Alignment Main Functions
      function showStandardsAlignmentScreen() {
        // Change body class for background styling
        document.body.className = 'body-standards';
        
        // Show the standards screen in landing page mode
        showScreen('standards-alignment-screen');
        
        // Reset to landing page state
        resetToLandingPageState();
        
        // Update summary stats with generic overview (optional - can show placeholder)
        updateSummaryStatsGeneric();
      }

      // Reset page to show only unit cards (landing page state)
      function resetToLandingPageState() {
        // Hide the standards coverage section
        const coverageDisplay = document.getElementById('standards-coverage-display');
        if (coverageDisplay) {
          coverageDisplay.classList.add('hidden');
        }
        
        // Hide loading indicators
        const loadingElement = document.getElementById('standards-loading');
        if (loadingElement) {
          loadingElement.classList.add('hidden');
        }
        
        // Clear any active unit selections
        document.querySelectorAll('.unit-selector-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // Clear any error messages
        const existingError = document.querySelector('.standards-error-message');
        if (existingError) {
          existingError.remove();
        }
        
        // Reset current selected unit
        currentSelectedUnit = null;
      }

      // Update summary stats with generic/overview information
      function updateSummaryStatsGeneric() {
        // Show placeholder stats for now, could be enhanced to show real overview stats
        document.getElementById('total-standards').textContent = '—';
        document.getElementById('covered-standards').textContent = '—';
        document.getElementById('partial-standards').textContent = '—';
        document.getElementById('not-covered-standards').textContent = '—';
      }

      // Load real standards data from the backend
      function loadStandardsDataFromBackend() {
        if (isLoadingStandards) return;
        
        isLoadingStandards = true;
        showStandardsLoading(true);
        
        google.script.run
          .withSuccessHandler(onStandardsDataLoaded)
          .withFailureHandler(onStandardsDataError)
          .getAllStandardsData();
      }

      function onStandardsDataLoaded(response) {
        isLoadingStandards = false;
        showStandardsLoading(false); // Fix: Always hide page-level loading
        
        if (response && response.success) {
          standardsDataCache = response;
          console.log('Standards data loaded:', standardsDataCache);
          
          // If a unit was selected, setup and show its standards
          if (currentSelectedUnit) {
            setupStandardsForUnit(currentSelectedUnit);
          }
        } else {
          onStandardsDataError(response ? response.error : 'Unknown error loading standards data');
        }
      }

      function onStandardsDataError(error) {
        isLoadingStandards = false;
        showStandardsLoading(false); // Fix: Always hide page-level loading
        
        console.error('Error loading standards data:', error);
        
        // Remove loading state from all buttons
        document.querySelectorAll('.unit-selector-btn').forEach(btn => {
          btn.classList.remove('loading', 'active');
        });
        
        // Clear any existing error messages first
        const existingError = document.querySelector('.standards-error-message');
        if (existingError) {
          existingError.remove();
        }
        
        // If a unit was selected, show error with better recovery options
        if (currentSelectedUnit) {
          // Show enhanced error message
          const errorMsg = document.createElement('div');
          errorMsg.className = 'standards-error-message';
          errorMsg.style.cssText = `
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
            text-align: center;
          `;
          // Create more specific error message based on unit
          let helpText = '';
          if (currentSelectedUnit === 'Unit 1: Coming of Age') {
            helpText = `
              <p><strong>Possible causes for Unit 1:</strong></p>
              <ul style="text-align: left; margin: 10px 20px;">
                <li>The Google Sheet named "Unit 1 Coming of Age State Standards" doesn't exist</li>
                <li>The sheet exists but contains no standards data</li>
                <li>No standards are marked with "X" in the Formative or Summative columns</li>
                <li>The sheet structure doesn't match expected format (columns C-G)</li>
              </ul>
              <p><em>Check the browser console for detailed debugging information.</em></p>
            `;
          } else {
            helpText = `<p>Unable to load real data for ${currentSelectedUnit}.</p>`;
          }
          
          errorMsg.innerHTML = `
            <h4 style="margin-top: 0;">⚠️ Could not load standards data from spreadsheet</h4>
            ${helpText}
            <details style="margin: 15px 0; font-size: 0.9em;">
              <summary style="cursor: pointer;">View error details</summary>
              <pre style="margin-top: 10px; text-align: left; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.8em;">${error}</pre>
            </details>
            <div style="margin-top: 15px;">
              <button onclick="retryLoadStandardsData()" style="
                background-color: #007bff;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 10px;
              ">
                🔄 Retry
              </button>
              <button onclick="resetToLandingPageState()" style="
                background-color: #6c757d;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
              ">
                ↩️ Back to Units
              </button>
            </div>
          `;
          
          const container = document.getElementById('standards-coverage-display');
          if (container) {
            container.insertBefore(errorMsg, container.firstChild);
          }
          
          // Show placeholder message instead of trying to setup without data
          const tableContainer = document.getElementById('standards-table-container');
          if (tableContainer) {
            tableContainer.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #6c757d;">
                <p>Standards data for ${currentSelectedUnit} is temporarily unavailable.</p>
                <p>Please try refreshing or contact your administrator.</p>
              </div>
            `;
          }
        }
        
        // Clear cache and reset states on error
        standardsDataCache = null;
        unitTableCache.clear();
        isTableStructureReady = false;
      }
      
      // Enhanced retry function with better error handling
      function retryLoadStandardsData() {
        // Clear any existing error state
        const errorMessage = document.querySelector('.standards-error-message');
        if (errorMessage) {
          errorMessage.remove();
        }
        
        // Reset all states
        standardsDataCache = null;
        unitTableCache.clear();
        isTableStructureReady = false;
        
        // If a unit was previously selected, try to reload it
        const unitToReload = currentSelectedUnit;
        currentSelectedUnit = null;
        
        if (unitToReload) {
          // Find the button for this unit and trigger selection
          const buttons = document.querySelectorAll('.unit-selector-btn');
          for (let button of buttons) {
            const buttonText = button.textContent.trim();
            const dataUnit = button.getAttribute('data-unit');
            if (buttonText.includes(unitToReload) || dataUnit === unitToReload) {
              // Simulate click on the button
              const event = new Event('click', { bubbles: true });
              Object.defineProperty(event, 'target', { value: button });
              button.dispatchEvent(event);
              return;
            }
          }
        }
        
        // Otherwise just load the data
        loadStandardsDataFromBackend();
      }

      // Diagnostic test function
      function runDiagnosticTest() {
        console.log('🔧 === STARTING DIAGNOSTIC TEST ===');
        const button = document.getElementById('diagnostic-test-btn');
        const originalText = button.textContent;
        
        // Update button to show testing state
        button.textContent = '⏳ Running Test...';
        button.disabled = true;
        
        // Create status display
        let statusDisplay = document.getElementById('diagnostic-status');
        if (!statusDisplay) {
          statusDisplay = document.createElement('div');
          statusDisplay.id = 'diagnostic-status';
          statusDisplay.style.cssText = `
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px auto;
            max-width: 600px;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            white-space: pre-wrap;
          `;
          button.parentNode.appendChild(statusDisplay);
        }
        
        statusDisplay.textContent = '⏳ Initializing diagnostic test...\n';
        
        // Run the backend diagnostic test
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('✅ Diagnostic test completed successfully:', result);
            
            if (result.success) {
              const diag = result.diagnostics;
              let report = '✅ DIAGNOSTIC TEST RESULTS\n';
              report += '══════════════════════════════\n\n';
              report += `📧 User: ${diag.userEmail}\n`;
              report += `📊 Spreadsheet ID: ${diag.spreadsheetId}\n`;
              report += `📋 Total Sheets: ${diag.totalSheets}\n\n`;
              
              report += '📝 STANDARDS SHEETS TEST:\n';
              report += '────────────────────────────\n';
              
              Object.entries(diag.standardsSheetTests).forEach(([unitName, test]) => {
                const status = test.sheetExists ? '✅' : '❌';
                report += `${status} ${unitName}\n`;
                report += `   Sheet: "${test.expectedSheetName}"\n`;
                
                if (test.sheetExists) {
                  report += `   Data: ${test.rowCount} rows, ${test.columnCount} cols\n`;
                  if (test.standardsWithCoverage !== undefined) {
                    report += `   Coverage: ${test.standardsWithCoverage} standards marked\n`;
                  }
                } else {
                  report += `   Status: Sheet not found\n`;
                }
                
                if (test.error) {
                  report += `   Error: ${test.error}\n`;
                }
                report += '\n';
              });
              
              report += '🎯 NEXT STEPS:\n';
              report += '─────────────\n';
              const missingSheets = Object.values(diag.standardsSheetTests).filter(t => !t.sheetExists);
              const emptySheets = Object.values(diag.standardsSheetTests).filter(t => t.sheetExists && !t.hasData);
              const uncoveredSheets = Object.values(diag.standardsSheetTests).filter(t => t.sheetExists && t.hasData && (t.standardsWithCoverage === 0));
              
              if (missingSheets.length > 0) {
                report += `• Create ${missingSheets.length} missing sheet(s) in Google Sheets\n`;
              }
              if (emptySheets.length > 0) {
                report += `• Add data to ${emptySheets.length} empty sheet(s)\n`;
              }
              if (uncoveredSheets.length > 0) {
                report += `• Mark standards with "X" in ${uncoveredSheets.length} sheet(s)\n`;
              }
              if (missingSheets.length === 0 && emptySheets.length === 0 && uncoveredSheets.length === 0) {
                report += '• All sheets look good! Try reloading the standards data.\n';
              }
              
              statusDisplay.textContent = report;
              console.log('📊 Diagnostic Report:', report);
              
            } else {
              statusDisplay.textContent = `❌ DIAGNOSTIC FAILED\nError: ${result.error}`;
            }
            
            // Reset button
            button.textContent = originalText;
            button.disabled = false;
          })
          .withFailureHandler(function(error) {
            console.error('❌ Diagnostic test failed:', error);
            statusDisplay.textContent = `❌ DIAGNOSTIC TEST FAILED\nError: ${error.toString()}\n\nThis indicates a fundamental connectivity or permission issue.`;
            
            // Reset button
            button.textContent = originalText;  
            button.disabled = false;
          })
          .testStandardsAccess();
      }

      // Helper function to show message when unit data is completely missing
      function showUnitDataMissingMessage(unitName) {
        const container = document.getElementById('standards-coverage-display');
        if (container) {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'standards-error-message';
          messageDiv.style.cssText = `
            background: #fff3cd;
            color: #856404;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
            text-align: center;
          `;
          
          let specificHelp = '';
          if (unitName === 'Unit 1: Coming of Age') {
            specificHelp = `
              <p><strong>For Unit 1, please verify:</strong></p>
              <ul style="text-align: left; margin: 10px 20px;">
                <li>A Google Sheet named <code>"Unit 1 Coming of Age State Standards"</code> exists</li>
                <li>The sheet contains data in rows 2 and beyond</li>
                <li>Column D contains benchmark codes</li>
                <li>Columns F and G contain "X" marks for covered standards</li>
              </ul>
            `;
          }
          
          messageDiv.innerHTML = `
            <h4 style="margin-top: 0;">📋 No Standards Data Found for ${unitName}</h4>
            ${specificHelp}
            <p><em>Check the console for detailed debugging information.</em></p>
          `;
          
          // Clear existing content and show message
          const tableContainer = document.getElementById('standards-table-container');
          if (tableContainer) {
            tableContainer.innerHTML = '';
            tableContainer.appendChild(messageDiv);
          }
        }
      }

      // Helper function to show message when unit has specific data issues  
      function showUnitDataIssueMessage(unitName, unitData) {
        const container = document.getElementById('standards-coverage-display');
        if (container) {
          const messageDiv = document.createElement('div');
          messageDiv.className = 'standards-error-message';
          messageDiv.style.cssText = `
            background: #fff3cd;
            color: #856404;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
            text-align: center;
          `;
          
          let issueText = '';
          if (unitData.error) {
            issueText = `<p><strong>Error:</strong> ${unitData.error}</p>`;
          } else if (!unitData.sheetExists) {
            issueText = `<p><strong>Issue:</strong> Sheet not found in spreadsheet</p>`;
          } else if (unitData.standardsCount === 0 && unitData.totalStandards === 0) {
            issueText = `<p><strong>Issue:</strong> Sheet exists but contains no standards data</p>`;
          } else if (unitData.standardsCount === 0) {
            issueText = `<p><strong>Issue:</strong> Found ${unitData.totalStandards} standards, but none are marked as covered</p>`;
          }
          
          let specificHelp = '';
          if (unitName === 'Unit 1: Coming of Age') {
            specificHelp = `
              <p><strong>To fix Unit 1 standards:</strong></p>
              <ul style="text-align: left; margin: 10px 20px;">
                <li>Ensure the sheet "Unit 1 Coming of Age State Standards" exists</li>
                <li>Add standards data starting from row 2</li>
                <li>Put benchmark codes in column D</li>
                <li>Mark covered standards with "X" in columns F (Formative) or G (Summative)</li>
              </ul>
            `;
          }
          
          messageDiv.innerHTML = `
            <h4 style="margin-top: 0;">⚠️ Standards Issue for ${unitName}</h4>
            ${issueText}
            ${specificHelp}
            <p><em>Check the console for detailed debugging information.</em></p>
          `;
          
          // Clear existing content and show message
          const tableContainer = document.getElementById('standards-table-container');
          if (tableContainer) {
            tableContainer.innerHTML = '';
            tableContainer.appendChild(messageDiv);
          }
        }
      }

      function showStandardsLoading(show) {
        const loadingElement = document.getElementById('standards-loading');
        const coverageDisplay = document.getElementById('standards-coverage-display');
        
        if (show) {
          if (loadingElement) loadingElement.classList.remove('hidden');
          if (coverageDisplay) coverageDisplay.classList.add('hidden');
        } else {
          if (loadingElement) loadingElement.classList.add('hidden');
          if (coverageDisplay) coverageDisplay.classList.remove('hidden');
        }
      }

      // Enhanced selectUnit function with lazy loading
      function selectUnit(unitName) {
        // Debounce - prevent multiple rapid clicks
        if (isLoadingStandards) return;
        
        // If same unit is already selected, do nothing
        if (currentSelectedUnit === unitName) return;
        
        currentSelectedUnit = unitName;
        
        // Update active unit button with visual feedback
        document.querySelectorAll('.unit-selector-btn').forEach(btn => {
          btn.classList.remove('active', 'loading');
        });
        const selectedButton = event.target.closest('.unit-selector-btn');
        selectedButton.classList.add('active');
        
        // Check if we have unit-specific cached data
        if (unitTableCache.has(unitName)) {
          // Instantly show cached unit data
          setupStandardsForUnit(unitName);
          return;
        }
        
        // Show unit-specific loading state
        showUnitLoadingState(selectedButton, unitName);
        
        // Load data if not cached, otherwise setup and populate immediately
        if (!standardsDataCache) {
          loadStandardsDataFromBackend();
        } else {
          // Process and cache this unit's data, then show it
          processAndCacheUnitData(unitName);
          setupStandardsForUnit(unitName);
        }
      }

      // Process and cache unit-specific table data with error handling
      function processAndCacheUnitData(unitName) {
        try {
          if (!standardsDataCache || !standardsDataCache.unitData) {
            console.warn(`No standards data cache available for unit: ${unitName}`);
            return;
          }
          
          const unitData = standardsDataCache.unitData[unitName];
          if (!unitData) {
            console.warn(`No unit data found for: ${unitName}`);
            showUnitDataMissingMessage(unitName);
            return;
          }
          
          // Check if unit has error or no standards
          if (unitData.error || (!unitData.sheetExists) || 
              (unitData.standardsCount === 0 && unitData.totalStandards === 0)) {
            showUnitDataIssueMessage(unitName, unitData);
            return;
          }
          
          // Initialize assessment groups safely
          const assessmentGroups = unitData.assessmentGroups || {};
          
          // Process standards into table rows data
          const tableRowsData = [];
          
          // Process each assessment group safely
          ['both', 'formativeOnly', 'summativeOnly', 'notCovered'].forEach(groupType => {
            const group = assessmentGroups[groupType];
            if (!group || !Array.isArray(group)) return;
            
            group.forEach((item, index) => {
              try {
                tableRowsData.push({
                  code: item.code || item.benchmarkCode || `Standard-${groupType}-${index}`,
                  description: item.description || item.benchmarkDesc || 'No description available',
                  coverage: groupType === 'notCovered' ? 'Not Covered' : 'Covered',
                  assessment: getAssessmentTypeText(groupType),
                  groupType: groupType
                });
              } catch (itemError) {
                console.warn(`Error processing item ${index} in group ${groupType}:`, itemError);
                // Skip this item and continue
              }
            });
          });
          
          // Cache the processed data
          const cacheData = {
            tableRows: tableRowsData,
            totalCount: unitData.totalCount || tableRowsData.length,
            coveredCount: (assessmentGroups.both?.length || 0) + 
                         (assessmentGroups.formativeOnly?.length || 0) + 
                         (assessmentGroups.summativeOnly?.length || 0),
            notCoveredCount: assessmentGroups.notCovered?.length || 0,
            processedAt: new Date().toISOString()
          };
          
          unitTableCache.set(unitName, cacheData);
          console.log(`Successfully cached ${tableRowsData.length} standards for ${unitName}`);
          
        } catch (error) {
          console.error(`Error processing unit data for ${unitName}:`, error);
          // Clear any partial cache for this unit
          unitTableCache.delete(unitName);
        }
      }
      
      // Get assessment type text for display
      function getAssessmentTypeText(groupType) {
        switch (groupType) {
          case 'both': return 'Both';
          case 'formativeOnly': return 'Formative';
          case 'summativeOnly': return 'Summative';
          case 'notCovered': return 'None';
          default: return 'Unknown';
        }
      }

      // Show loading state for specific unit
      function showUnitLoadingState(button, unitName) {
        // Add loading class to button
        button.classList.add('loading');
        
        // Show standards coverage section with loading message
        const coverageDisplay = document.getElementById('standards-coverage-display');
        coverageDisplay.classList.remove('hidden');
        
        // Update title
        document.getElementById('selected-unit-title').textContent = `Loading ${unitName} Standards...`;
        
        // Clear any previous error messages
        const existingError = document.querySelector('.standards-error-message');
        if (existingError) {
          existingError.remove();
        }
        
        // Show table area with loading placeholder
        const tableContainer = document.getElementById('standards-table-container');
        if (tableContainer) {
          tableContainer.innerHTML = `
            <div class="table-loading-state">
              <div class="loading-spinner"></div>
              <p>Loading standards for ${unitName}...</p>
            </div>
          `;
        }
      }

      // Setup standards display for specific unit after data is loaded
      function setupStandardsForUnit(unitName) {
        // Remove loading state from button
        document.querySelectorAll('.unit-selector-btn').forEach(btn => {
          btn.classList.remove('loading');
        });
        
        // Update title
        document.getElementById('selected-unit-title').textContent = `${unitName} - Standards Coverage`;
        
        // Ensure table structure exists (only create once)
        const tableContainer = document.getElementById('standards-table-container');
        if (tableContainer && !isTableStructureReady) {
          tableContainer.innerHTML = `
            <table id="standards-table" class="standards-table">
              <thead>
                <tr>
                  <th class="sortable" data-column="code">
                    Standard Code
                    <span class="sort-indicator">↕️</span>
                  </th>
                  <th class="sortable" data-column="description">
                    Description
                    <span class="sort-indicator">↕️</span>
                  </th>
                  <th class="sortable" data-column="coverage">
                    Coverage Status
                    <span class="sort-indicator">↕️</span>
                  </th>
                  <th class="sortable" data-column="assessment">
                    Assessment Type
                    <span class="sort-indicator">↕️</span>
                  </th>
                </tr>
              </thead>
              <tbody id="standards-table-body">
                <!-- Standards will be populated by JavaScript -->
              </tbody>
            </table>
          `;
          
          // Setup controls and filters (only once)
          setupStandardsControls();
          setupTableFilters();
          isTableStructureReady = true;
        }
        
        // If we don't have unit data cached yet, process it
        if (!unitTableCache.has(unitName) && standardsDataCache) {
          processAndCacheUnitData(unitName);
        }
        
        // Populate the table with cached unit data
        populateTableViewFromCache(unitName);
        
        // Update summary stats for this unit
        updateSummaryStatsForUnit(unitName);
      }

      // Update summary stats for specific unit
      function updateSummaryStatsForUnit(unitName) {
        if (standardsDataCache && standardsDataCache.unitData && standardsDataCache.unitData[unitName]) {
          const unitData = standardsDataCache.unitData[unitName];
          const total = unitData.totalStandards || 0;
          const covered = unitData.standardsCount || 0;
          const notCovered = unitData.notCoveredCount || 0;
          
          document.getElementById('total-standards').textContent = total;
          document.getElementById('covered-standards').textContent = covered;
          document.getElementById('not-covered-standards').textContent = notCovered;
          document.getElementById('partial-standards').textContent = '0'; // Could be enhanced
        }
      }

      // Optimized function to populate table using cached data
      function populateTableViewFromCache(unitName) {
        const container = document.getElementById('standards-table-body');
        if (!container) return;
        
        // Get cached unit data
        const cachedData = unitTableCache.get(unitName);
        if (!cachedData) {
          // Fall back to placeholder if no cached data
          container.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No standards data available for this unit.</td></tr>';
          return;
        }
        
        // Clear existing content
        container.innerHTML = '';
        
        // Populate from cached processed data
        cachedData.tableRows.forEach((rowData, index) => {
          const row = document.createElement('tr');
          row.className = 'standard-row';
          row.setAttribute('data-coverage', rowData.coverage);
          row.setAttribute('data-assessment', rowData.assessment);
          row.setAttribute('data-index', index);
          
          // Determine status badge
          let statusText, statusClass;
          if (rowData.coverage === 'Covered') {
            statusText = 'Covered';
            statusClass = 'covered';
          } else {
            statusText = 'Not Covered';
            statusClass = 'not-covered';
          }
          
          // Determine assessment badge with emojis
          let assessmentText, assessmentClass;
          switch(rowData.assessment) {
            case 'Formative':
              assessmentText = '📝 Formative';
              assessmentClass = 'formative';
              break;
            case 'Summative':
              assessmentText = '📊 Summative';
              assessmentClass = 'summative';
              break;
            case 'Both':
              assessmentText = '📝📊 Both';
              assessmentClass = 'both';
              break;
            default:
              assessmentText = '❌ None';
              assessmentClass = 'none';
          }
          
          row.innerHTML = `
            <td>
              <span class="standard-code">${rowData.code}</span>
            </td>
            <td>
              <span class="standard-description">${rowData.description}</span>
            </td>
            <td>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </td>
            <td>
              <span class="assessment-badge ${assessmentClass}">${assessmentText}</span>
            </td>
          `;
          
          container.appendChild(row);
        });
        
        // Update counters
        updateFilterCounters();
      }

      
      // Expandable/Collapsible Sections
      function makeStandardItemExpandable(standardItem, standard) {
        const header = standardItem.querySelector('.standard-header') || standardItem;
        const details = document.createElement('div');
        details.className = 'standard-details';
        details.style.cssText = `
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.3s ease;
          padding: 0 16px;
          background: rgba(0,0,0,0.02);
          border-top: 1px solid rgba(0,0,0,0.05);
          margin-top: 10px;
        `;
        
        details.innerHTML = `
          <div style="padding: 15px 0;">
            <div style="margin-bottom: 10px;">
              <strong>Assessment Type:</strong> ${standard.assessmentType || 'Not specified'}
            </div>
            <div style="margin-bottom: 10px;">
              <strong>Depth of Knowledge:</strong> ${standard.dok || 'Not specified'}
            </div>
            <div style="margin-bottom: 10px;">
              <strong>Related Standards:</strong> ${standard.relatedStandards || 'None listed'}
            </div>
            <div>
              <strong>Teaching Resources:</strong> ${standard.resources || 'See unit materials'}
            </div>
          </div>
        `;
        
        standardItem.appendChild(details);
        
        // Add expand/collapse icon
        const expandIcon = document.createElement('span');
        expandIcon.className = 'expand-icon';
        expandIcon.innerHTML = '▼';
        expandIcon.style.cssText = `
          float: right;
          transition: transform 0.3s ease;
          cursor: pointer;
          color: #667eea;
          font-size: 0.8em;
          margin-left: 10px;
        `;
        
        header.appendChild(expandIcon);
        
        // Add click handler
        standardItem.addEventListener('click', function(e) {
          e.stopPropagation();
          const isExpanded = details.style.maxHeight !== '0px' && details.style.maxHeight !== '';
          
          if (isExpanded) {
            details.style.maxHeight = '0';
            expandIcon.style.transform = 'rotate(0deg)';
            standardItem.classList.remove('expanded');
          } else {
            details.style.maxHeight = details.scrollHeight + 'px';
            expandIcon.style.transform = 'rotate(180deg)';
            standardItem.classList.add('expanded');
          }
        });
      }

      // Global keyboard navigation
      document.addEventListener('keydown', function(e) {
        // Only handle keyboard navigation when standards screen is visible
        if (!document.getElementById('standards-alignment-screen').classList.contains('hidden')) {
          switch(e.key) {
            case 'f':
            case 'F':
              if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                const searchInput = document.getElementById('standards-search');
                if (searchInput) {
                  searchInput.focus();
                  searchInput.select();
                }
              }
              break;
            case 'ArrowUp':
            case 'ArrowDown':
              if (!e.target.matches('input, select')) {
                e.preventDefault();
                navigateStandards(e.key === 'ArrowUp' ? -1 : 1);
              }
              break;
            case 'Escape':
              // Clear all filters
              if (e.target.matches('input, select')) {
                const searchInput = document.getElementById('standards-search');
                const coverageFilter = document.getElementById('coverage-filter');
                const assessmentFilter = document.getElementById('assessment-filter');
                
                if (searchInput) searchInput.value = '';
                if (coverageFilter) coverageFilter.value = '';
                if (assessmentFilter) assessmentFilter.value = '';
                
                filterStandardsTable();
                e.target.blur();
              }
              break;
          }
        }
      });

      function navigateStandards(direction) {
        const visibleRows = Array.from(document.querySelectorAll('#standards-table-body tr:not(.filtered-out)'));
        const currentIndex = visibleRows.findIndex(row => row.classList.contains('keyboard-focused'));
        
        if (visibleRows.length === 0) return;
        
        // Remove current focus
        visibleRows.forEach(row => row.classList.remove('keyboard-focused'));
        
        let newIndex;
        if (currentIndex === -1) {
          newIndex = direction > 0 ? 0 : visibleRows.length - 1;
        } else {
          newIndex = currentIndex + direction;
          if (newIndex < 0) newIndex = visibleRows.length - 1;
          if (newIndex >= visibleRows.length) newIndex = 0;
        }
        
        const newRow = visibleRows[newIndex];
        newRow.classList.add('keyboard-focused');
        newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Add visual focus indicator
        newRow.style.backgroundColor = '#e3f2fd';
        newRow.style.transform = 'scale(1.02)';
        newRow.style.boxShadow = '0 0 0 2px rgba(102, 126, 234, 0.5)';
        
        setTimeout(() => {
          if (newRow.classList.contains('keyboard-focused')) {
            newRow.style.backgroundColor = '';
            newRow.style.transform = '';
            newRow.style.boxShadow = '';
          }
        }, 2000);
      }

      // Client-side setup functions for standards functionality
      function setupStandardsBackButton() {
        const backButton = document.getElementById('back-to-main-from-standards-btn');
        if (backButton) {
          backButton.onclick = () => showScreen('main-landing-screen');
        }
      }

      function setupTableFilters() {
        // Set up coverage filter
        const coverageFilter = document.getElementById('coverage-filter');
        if (coverageFilter) {
          coverageFilter.addEventListener('change', filterStandardsTable);
        }
        
        // Set up assessment filter
        const assessmentFilter = document.getElementById('assessment-filter');
        if (assessmentFilter) {
          assessmentFilter.addEventListener('change', filterStandardsTable);
        }
        
        // Set up search input if it exists
        const searchInput = document.getElementById('standards-search');
        if (searchInput) {
          searchInput.addEventListener('input', filterStandardsTable);
        }
      }

      function filterStandardsTable() {
        const coverageFilter = document.getElementById('coverage-filter');
        const assessmentFilter = document.getElementById('assessment-filter');
        const searchInput = document.getElementById('standards-search');
        
        const coverageValue = coverageFilter ? coverageFilter.value : '';
        const assessmentValue = assessmentFilter ? assessmentFilter.value : '';
        const searchValue = searchInput ? searchInput.value.toLowerCase() : '';
        
        const tableBody = document.getElementById('standards-table-body');
        if (!tableBody) return;
        
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
          let shouldShow = true;
          
          // Apply search filter
          if (searchValue) {
            const textContent = row.textContent.toLowerCase();
            if (!textContent.includes(searchValue)) {
              shouldShow = false;
            }
          }
          
          // Apply coverage filter
          if (coverageValue && shouldShow) {
            const coverageCell = row.querySelector('.coverage-status');
            if (coverageCell) {
              const coverageStatus = coverageCell.textContent.toLowerCase();
              if (coverageValue === 'covered' && !coverageStatus.includes('covered')) shouldShow = false;
              if (coverageValue === 'not-covered' && !coverageStatus.includes('not covered')) shouldShow = false;
              if (coverageValue === 'partial' && !coverageStatus.includes('partial')) shouldShow = false;
            }
          }
          
          // Apply assessment filter
          if (assessmentValue && shouldShow) {
            const assessmentCell = row.querySelector('.assessment-type');
            if (assessmentCell) {
              const assessmentType = assessmentCell.textContent.toLowerCase();
              if (assessmentValue === 'formative' && !assessmentType.includes('formative')) shouldShow = false;
              if (assessmentValue === 'summative' && !assessmentType.includes('summative')) shouldShow = false;
              if (assessmentValue === 'both' && !assessmentType.includes('both')) shouldShow = false;
            }
          }
          
          // Show or hide the row
          if (shouldShow) {
            row.classList.remove('filtered-out');
          } else {
            row.classList.add('filtered-out');
          }
        });
        
        // Update filter counters after filtering
        updateFilterCounters();
      }

      function updateFilterCounters() {
        const tableBody = document.getElementById('standards-table-body');
        const filteredCountSpan = document.getElementById('filtered-count');
        const totalCountSpan = document.getElementById('total-count');
        
        if (!tableBody || !filteredCountSpan || !totalCountSpan) return;
        
        const allRows = tableBody.querySelectorAll('tr');
        const visibleRows = tableBody.querySelectorAll('tr:not(.filtered-out)');
        
        const totalCount = allRows.length;
        const filteredCount = visibleRows.length;
        
        filteredCountSpan.textContent = filteredCount;
        totalCountSpan.textContent = totalCount;
      }

      function setupStandardsControls() {
        // Set up all interactive elements for the standards section
        setupTableFilters();
        setupStandardsBackButton();
      }

      // Initialize standards functionality when document is ready
      document.addEventListener('DOMContentLoaded', function() {
        setupStandardsBackButton();
        setupStandardsControls();
        setupTableFilters();
      });
    </script>
  </body>
</html>