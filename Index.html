<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
      body{font-family:'Nunito',sans-serif;background-color:#87CEEB;color:#34495e;margin:0;padding:20px;display:flex;justify-content:center;align-items:center;min-height:100vh}
      
.container{background-color:#fff;padding:2em 3em;border-radius:15px;box-shadow:0 10px 25px rgba(0,0,0,.15);width:100%;max-width:1200px;text-align:center;border:1px solid #f7f7f7}
      
.hidden{display:none}h1,h2,h3{font-family:'Patrick Hand',cursive;color:#2c3e50}h1{font-size:3.5em;margin-bottom:.2em;margin-top:0}h2{font-size:2em;color:#34495e;margin-top:0}h3{font-size:1.8em;margin-top:1.5em;margin-bottom:0.5em}

      /* Shared Unit Grid Styles */
      #unit-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:2em}
      .unit-button{display:block;text-decoration:none;color:#2c3e50;background-color:#f8f9fa;border-radius:8px;padding:20px;position:relative;overflow:visible;transition:transform .2s ease,box-shadow .2s ease;border:2px solid #dee2e6;cursor:pointer;text-align:center}
      .unit-button:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,.15);border-color:#adb5bd}
      .unit-title{font-family:'Patrick Hand',cursive;font-size:1.4em;margin-bottom:10px;font-weight:bold}
      .unit-progress{font-family:'Nunito',sans-serif;font-size:0.9em;color:#6c757d}

      /* Inline Unit Toggle Styles */
      .unit-toggle-wrapper{position:absolute;bottom:8px;right:8px;z-index:10}
      .unit-inline-toggle{position:relative;display:inline-block;width:32px;height:18px}
      .unit-inline-toggle input{opacity:0;width:0;height:0}
      .unit-inline-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.2s;border-radius:18px}
      .unit-inline-slider:before{position:absolute;content:"";height:14px;width:14px;left:2px;bottom:2px;background-color:white;transition:.2s;border-radius:50%}
      .unit-inline-toggle input:checked + .unit-inline-slider{background-color:#28a745}
      .unit-inline-toggle input:checked + .unit-inline-slider:before{transform:translateX(14px)}

      /* Quiz Interface Styles */
      #question-text{font-family:'Nunito',sans-serif;font-size:1.3em;margin:1em 0;min-height:60px}
      #answer-options{display:flex;flex-direction:column;gap:15px;margin:2em 0}
      .option-btn{font-family:'Nunito',sans-serif;font-size:1em;cursor:pointer;border:2px solid #ced4da;background-color:#fff;border-radius:8px;transition:all .2s ease;padding:15px;text-align:center}
      .option-btn:not([disabled]):hover{background-color:#e9ecef;border-color:#adb5bd}
      .option-btn.correct{background-color:#d1e7dd;border-color:#28a745;color:#0f5132}
      .option-btn.incorrect{background-color:#f8d7da;border-color:#dc3545;color:#842029}
      .option-btn:disabled{cursor:not-allowed;opacity:.8}
      #progress-container{text-align:right;color:#6c757d}
      #final-score{font-family:'Patrick Hand',cursive;font-size:2.5em;font-weight:700;margin:1em 0}
      #review-container{text-align:left;margin-top:2em;max-height:400px;overflow-y:auto;border-top:1px solid #ddd}
      .review-item{padding:15px;border-bottom:1px solid #ecf0f1}
      .review-question{font-weight:700}
      .review-answer-correct{color:#198754}
      .review-answer-incorrect{color:#dc3545;text-decoration:line-through}

      /* Teacher Modal Styles */
      .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.5)}
      .modal.show{display:block}
      .modal-content{background-color:#fff;margin:10% auto;padding:30px;border-radius:15px;width:90%;max-width:500px;position:relative;box-shadow:0 10px 25px rgba(0,0,0,0.2)}
      .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer;position:absolute;right:15px;top:10px}
      .close:hover{color:#000}
      .teacher-actions{display:flex;flex-direction:column;gap:15px;margin-top:20px}
      .action-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;border:none;padding:15px 20px;border-radius:8px;cursor:pointer;font-size:1.1em;transition:all .2s ease;text-align:left}
      .action-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
      .practice-btn{background-color:#28a745}
      .results-btn{background-color:#007bff}
      .edit-btn{background-color:#6f42c1}


      /* Teacher Results Table */
      #teacher-results-table{width:100%;border-collapse:collapse;margin-top:1em}
      #teacher-results-table th,#teacher-results-table td{padding:12px 15px;border:1px solid #ddd;text-align:left}
      #teacher-results-table th{background-color:#34495e;color:#fff;font-family:'Nunito'}
      #teacher-results-table tr:nth-child(even){background-color:#f8f9fa}
      .score-mastered{color:#2ECC71;font-weight:bold}
      .score-proficient{color:#F39C12;font-weight:bold}
      .score-developing{color:#E74C3C;font-weight:bold}
      .score-unattempted{color:#95a5a6;font-style:italic}

      /* Button Styles */
      #try-again-btn,#main-menu-btn,#back-to-home-btn,#register-btn,#back-to-units-btn,#back-to-units-from-results-btn{font-family:'Nunito',sans-serif;font-weight:700;color:#fff;border:none;padding:12px 24px;border-radius:50px;cursor:pointer;margin-top:10px;transition:all .2s ease;box-shadow:0 2px 5px rgba(0,0,0,.1)}
      #try-again-btn:hover,#main-menu-btn:hover,#back-to-home-btn:hover,#register-btn:hover,#back-to-units-btn:hover,#back-to-units-from-results-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
      #try-again-btn{background-color:#198754;margin-right:10px}
      #main-menu-btn,#back-to-home-btn,#back-to-units-btn,#back-to-units-from-results-btn{background-color:#6c757d}
      #register-btn{background-color:#0d6efd}

      /* Common Styles */
      .loading-indicator{padding:40px;text-align:center}
      .spinner{border:8px solid #f3f3f3;border-radius:50%;border-top:8px solid #3498db;width:60px;height:60px;animation:spin 1s linear infinite;margin:0 auto 20px}
      @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
      .form-group{margin-bottom:1.5em;text-align:left}.form-group label{display:block;margin-bottom:.5em;font-weight:700}.form-group input,.form-group select{width:100%;padding:10px;border-radius:5px;border:1px solid #ccc;font-size:1em;box-sizing: border-box;}
    </style>
  </head>
  <body>
    <div class="container">
      <h1>English 9 Grammar Practice</h1>
      
      <!-- Shared Unit Selection Screen -->
      <div id="unit-selection-screen">
        <h2 id="welcome-message">Choose a Unit to Practice</h2>
        <div id="unit-grid">Loading units...</div>
      </div>

      <!-- Student Registration Screen -->
      <div id="registration-screen" class="hidden">
        <h2>Welcome! Let's get you set up.</h2>
        <p>Since this is your first time here, please enter your full name and select your teacher.</p>
        <div class="form-group">
            <label for="student-name">Full Name</label>
            <input type="text" id="student-name" placeholder="e.g., Jane Doe">
        </div>
        <div class="form-group">
            <label for="teacher-select">Teacher</label>
            <select id="teacher-select">
                <option value="">-- Please Select --</option>
            </select>
        </div>
        <button id="register-btn">Complete Registration</button>
        <button id="back-to-units-btn">Back to Units</button>
      </div>

      <!-- Quiz Screen -->
      <div id="quiz-screen" class="hidden"></div>
      
      <!-- Results Screen -->
      <div id="results-screen" class="hidden"></div>

      <!-- Teacher Action Modal -->
      <div id="teacher-modal" class="modal hidden">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h3 id="modal-unit-title"></h3>
          <div class="teacher-actions">
            <button id="practice-as-student-btn" class="action-btn practice-btn">
              üìù View practice as student
            </button>
            <button id="view-results-btn" class="action-btn results-btn">
              üìä View results as teacher
            </button>
            <button id="edit-questions-btn" class="action-btn edit-btn">
              ‚úèÔ∏è Edit questions
            </button>
          </div>
        </div>
      </div>

      <!-- Teacher Results Screen -->
      <div id="teacher-results-screen" class="hidden">
        <button id="back-to-units-from-results-btn">‚Üê Back to Units</button>
        <h3 id="teacher-results-title"></h3>
        <div id="loading-indicator-teacher" class="loading-indicator hidden">
          <div class="spinner"></div>
          <p>Loading results...</p>
        </div>
        <table id="teacher-results-table">
          <thead><tr><th>Student Name</th><th>Best Score</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Loading/Error -->
      <div id="loading-indicator" class="hidden">
        <div class="spinner"></div>
        <p>Loading...</p>
      </div>
      <div id="error-message" class="hidden"></div>
    </div>

    <script>
      // Global variables
      let allQuestions = [], currentQuestionIndex = 0, score = 0, userAnswers = [], currentUnit = '';
      let userInfo = {};
      let isTeacher = false;
      let availableUnits = []; // This will be populated based on user type and teacher settings
      let teacherUnitSettings = {}; // Store teacher's unit enable/disable settings
      
      document.addEventListener('DOMContentLoaded', initializeApp);

      function initializeApp() {
        showScreen('loading-indicator');
        google.script.run.withSuccessHandler(onAppDataLoaded).withFailureHandler(onLoadError).getRoleAndUserInfo();
      }

      function onAppDataLoaded(response) {
        hideScreen('loading-indicator');
        
        if (response.error) {
          onLoadError({ message: response.error });
          return;
        }
        
        userInfo = response;
        isTeacher = response.isTeacher;
        
        // Set available units based on user type
        if (isTeacher) {
          // Teachers see all units
          availableUnits = ["Unit 1: Coming of Age", "Unit 2: Personal Narrative", "Unit 3: Novel Study", "Unit 4: Short Story", "Unit 5: Romeo and Juliet", "Unit 5 (Enriched) Macbeth", "Unit 6: Nonfiction", "Unit 6 (Enriched) Frankenstein", "Unit 7: Resilience", "Unit 8: Annotated Bibliography & Documentary"];
        } else if (response.isRegistered && response.enabledUnits) {
          // Registered students see only their teacher's enabled units
          availableUnits = response.enabledUnits;
        } else {
          // Unregistered students see all units
          availableUnits = ["Unit 1: Coming of Age", "Unit 2: Personal Narrative", "Unit 3: Novel Study", "Unit 4: Short Story", "Unit 5: Romeo and Juliet", "Unit 5 (Enriched) Macbeth", "Unit 6: Nonfiction", "Unit 6 (Enriched) Frankenstein", "Unit 7: Resilience", "Unit 8: Annotated Bibliography & Documentary"];
        }
        
        // Update welcome message based on user type
        if (isTeacher) {
          document.getElementById('welcome-message').textContent = `Welcome, ${userInfo.teacherName}! Choose a Unit`;
        } else if (response.isRegistered) {
          document.getElementById('welcome-message').textContent = `Welcome, ${userInfo.name}! Choose a Unit to Practice`;
        } else {
          document.getElementById('welcome-message').textContent = `Choose a Unit to Practice`;
        }
        
        // Load and display units
        loadUnitsForSharedView();
      }

      function loadUnitsForSharedView() {
        const container = document.getElementById('unit-grid');
        container.innerHTML = '';
        
        if (isTeacher) {
          // For teachers, load unit settings first, then display
          loadTeacherUnitSettings();
        } else if (userInfo.isRegistered) {
          // For students, load progress data
          google.script.run.withSuccessHandler(displayUnitsWithProgress).withFailureHandler(onLoadError).getStudentProgress();
        } else {
          // For unregistered students, show simple unit buttons
          displayUnitsWithProgress({ success: true, progress: {} });
        }
      }

      function loadTeacherUnitSettings() {
        google.script.run
          .withSuccessHandler(onTeacherUnitSettingsLoaded)
          .withFailureHandler(onLoadError)
          .getTeacherUnitSettings();
      }

      function onTeacherUnitSettingsLoaded(response) {
        if (!response.success) {
          onLoadError({ message: response.error });
          return;
        }
        
        teacherUnitSettings = response.settings;
        // Now display units with toggle controls
        displayUnitsWithProgress({ success: true, progress: {} });
      }

      function displayUnitsWithProgress(progressResponse) {
        const container = document.getElementById('unit-grid');
        container.innerHTML = '';
        
        const progressData = progressResponse.progress || {};
        
        availableUnits.forEach(unit => {
          const bestScore = progressData[unit] || 0;
          let progressText = isTeacher ? 'Click to select action' : 'Not attempted';
          
          if (!isTeacher && bestScore > 0) {
            if (bestScore >= 90) progressText = `Mastered (${bestScore}%)`;
            else if (bestScore >= 70) progressText = `Proficient (${bestScore}%)`;
            else progressText = `Developing (${bestScore}%)`;
          }
          
          const button = document.createElement('div');
          button.className = 'unit-button';
          button.onclick = (e) => handleUnitClick(unit, e);
          
          let toggleHTML = '';
          if (isTeacher) {
            const isEnabled = teacherUnitSettings[unit] !== false; // Default to true if not set
            
            toggleHTML = `
              <div class="unit-toggle-wrapper" onclick="event.stopPropagation()">
                <label class="unit-inline-toggle">
                  <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="handleInlineUnitToggle('${unit}', this.checked, this)">
                  <span class="unit-inline-slider"></span>
                </label>
              </div>
            `;
          }
          
          button.innerHTML = `
            ${toggleHTML}
            <div class="unit-title">${unit}</div>
            <div class="unit-progress">${progressText}</div>
          `;
          container.appendChild(button);
        });
        
        showScreen('unit-selection-screen');
      }

      function handleUnitClick(unitName, event) {
        // Prevent click if it's from the toggle area
        if (event && event.target.closest('.unit-toggle-wrapper')) {
          return;
        }
        
        currentUnit = unitName;
        
        if (isTeacher) {
          showTeacherModal(unitName);
        } else {
          // For students - check if registered, then start practice
          if (userInfo.isRegistered) {
            startQuiz(unitName);
          } else {
            // Show registration screen first
            populateTeacherDropdown(userInfo.teachers);
            showScreen('registration-screen');
            document.getElementById('register-btn').onclick = submitRegistration;
            document.getElementById('back-to-units-btn').onclick = () => showScreen('unit-selection-screen');
          }
        }
      }

      // Inline Unit Toggle Handler
      function handleInlineUnitToggle(unitName, isEnabled, toggleElement) {
        // Update local settings immediately for UI responsiveness
        teacherUnitSettings[unitName] = isEnabled;
        
        // Save to backend
        google.script.run
          .withSuccessHandler(() => {
            // Success - settings already updated locally
            console.log(`Unit ${unitName} ${isEnabled ? 'enabled' : 'disabled'}`);
          })
          .withFailureHandler((error) => {
            // Revert on error
            teacherUnitSettings[unitName] = !isEnabled;
            toggleElement.checked = !isEnabled;
            onLoadError({ message: error.message });
          })
          .updateTeacherUnitSettings(unitName, isEnabled);
      }

      // Teacher Modal Functions
      function showTeacherModal(unitName) {
        document.getElementById('modal-unit-title').textContent = unitName;
        document.getElementById('teacher-modal').classList.add('show');
        
        // Set up modal event handlers
        document.querySelector('.close').onclick = closeTeacherModal;
        document.getElementById('practice-as-student-btn').onclick = () => {
          closeTeacherModal();
          startQuiz(unitName);
        };
        document.getElementById('view-results-btn').onclick = () => {
          closeTeacherModal();
          showTeacherResults(unitName);
        };
        document.getElementById('edit-questions-btn').onclick = () => {
          closeTeacherModal();
          alert('Question editing feature coming soon!');
        };
        
        // Close modal when clicking outside
        window.onclick = (event) => {
          if (event.target.classList.contains('modal')) {
            closeTeacherModal();
          }
        };
      }

      function closeTeacherModal() {
        document.getElementById('teacher-modal').classList.remove('show');
      }


      function showTeacherResults(unitName) {
        document.getElementById('teacher-results-title').textContent = `Results for: ${unitName}`;
        document.getElementById('loading-indicator-teacher').classList.remove('hidden');
        document.getElementById('teacher-results-table').classList.add('hidden');
        showScreen('teacher-results-screen');
        
        document.getElementById('back-to-units-from-results-btn').onclick = () => showScreen('unit-selection-screen');
        
        google.script.run
          .withSuccessHandler(onTeacherResultsLoaded)
          .withFailureHandler(onLoadError)
          .getUnitDetailsForTeacher(unitName);
      }

      function onTeacherResultsLoaded(response) {
        document.getElementById('loading-indicator-teacher').classList.add('hidden');
        document.getElementById('teacher-results-table').classList.remove('hidden');
        
        if (!response.success) {
          onLoadError({ message: response.error });
          return;
        }

        const tbody = document.getElementById('teacher-results-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        
        if (!response.details || response.details.length === 0) {
          tbody.innerHTML = '<tr><td colspan="2">No data found for this unit.</td></tr>';
          return;
        }

        response.details.forEach(student => {
          let scoreCell = '<span class="score-unattempted">Not Attempted</span>';
          if (student.bestScore !== undefined && student.bestScore !== null) {
            let scoreClass = 'developing';
            if (student.bestScore >= 90) scoreClass = 'mastered';
            else if (student.bestScore >= 70) scoreClass = 'proficient';
            scoreCell = `<span class="score-${scoreClass}">${student.bestScore}%</span>`;
          }

          const row = tbody.insertRow();
          row.innerHTML = `<td>${student.studentName}</td><td>${scoreCell}</td>`;
        });
      }

      // Student Registration Functions
      function populateTeacherDropdown(teachers) {
        const select = document.getElementById('teacher-select');
        select.innerHTML = '<option value="">-- Please Select --</option>';
        teachers.forEach(teacher => {
          const option = document.createElement('option');
          option.value = teacher;
          option.textContent = teacher;
          select.appendChild(option);
        });
      }

      function submitRegistration() {
        const name = document.getElementById('student-name').value.trim();
        const teacher = document.getElementById('teacher-select').value;
        if (!name || !teacher) {
          alert('Please enter your full name and select a teacher.');
          return;
        }
        
        showScreen('loading-indicator');
        const studentData = { name: name, teacher: teacher };
        google.script.run
          .withSuccessHandler(onRegistrationSuccess)
          .withFailureHandler(onLoadError)
          .registerStudent(studentData);
      }

      function onRegistrationSuccess(response) {
        if (!response || !response.success) {
          onLoadError({ message: response.error || 'Registration failed unexpectedly.' });
          return;
        }
        
        // Update user info and restart app
        userInfo.isRegistered = true;
        userInfo.name = response.name;
        userInfo.teacher = response.teacher;
        
        // Start the quiz they originally clicked on
        startQuiz(currentUnit);
      }

      // Quiz Functions
      function startQuiz(unitName) {
        currentUnit = unitName;
        showScreen('loading-indicator');
        google.script.run.withSuccessHandler(onQuestionsLoaded).withFailureHandler(onLoadError).getQuestionsForUnit(unitName);
      }

      function onQuestionsLoaded(questions) {
        if (questions.error || questions.length === 0) {
          onLoadError({ message: questions.error ? questions.message : `No questions found for "${currentUnit}".` });
          return;
        }
        
        allQuestions = questions.map(q => ({...q, options: shuffleArray(q.options)}));
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = [];
        showScreen('quiz-screen');
        displayQuestion();
      }

      function displayQuestion() {
        const question = allQuestions[currentQuestionIndex];
        document.getElementById('quiz-screen').innerHTML = `
          <div id="progress-container"><p>Question ${currentQuestionIndex + 1} of ${allQuestions.length}</p></div>
          <h2 id="question-text">${question.question}</h2>
          <div id="answer-options">${question.options.map(opt => `<button class="option-btn">${opt}</button>`).join('')}</div>
          <button id="back-to-home-btn">Back to Units</button>
        `;
        
        document.querySelectorAll('.option-btn').forEach(btn => {
          btn.onclick = () => handleAnswer(btn.textContent, btn);
        });
        
        document.getElementById('back-to-home-btn').onclick = () => showScreen('unit-selection-screen');
      }

      function handleAnswer(selectedOption, buttonElement) {
        const question = allQuestions[currentQuestionIndex];
        const isCorrect = selectedOption === question.answer;
        
        userAnswers.push({
          question: question.question,
          selected: selectedOption,
          correctAnswer: question.answer,
          isCorrect: isCorrect
        });
        
        if (isCorrect) score++;
        
        buttonElement.classList.add(isCorrect ? 'correct' : 'incorrect');
        document.querySelectorAll('.option-btn').forEach(btn => {
          btn.disabled = true;
          if (btn.textContent === question.answer) btn.classList.add('correct');
        });
        
        setTimeout(() => {
          currentQuestionIndex++;
          if (currentQuestionIndex < allQuestions.length) {
            displayQuestion();
          } else {
            showResults();
          }
        }, 2000);
      }

      function showResults() {
        const resultData = { unit: currentUnit, score: score, total: allQuestions.length };
        
        // Save results for registered students
        if (!isTeacher && userInfo.isRegistered) {
          google.script.run.withFailureHandler(err => console.error('Failed to save result:', err)).saveQuizResult(resultData);
        }
        
        document.getElementById('results-screen').innerHTML = `
          <h2>Quiz Complete!</h2>
          <p id="final-score">You scored ${score} out of ${allQuestions.length}!</p>
          <h3>Review Your Answers:</h3>
          <div id="review-container">
            ${userAnswers.map(ua => `
              <div class="review-item">
                <p class="review-question">${ua.question}</p>
                ${ua.isCorrect ? 
                  `<p>Your answer: <span class="review-answer-correct">${ua.selected} (Correct)</span></p>` : 
                  `<p>Your answer: <span class="review-answer-incorrect">${ua.selected}</span></p>
                   <p>Correct answer: <span class="review-answer-correct">${ua.correctAnswer}</span></p>`
                }
              </div>
            `).join('')}
          </div>
          <button id="try-again-btn">Practice this Unit Again</button>
          <button id="main-menu-btn">Back to Units</button>
        `;
        
        showScreen('results-screen');
        
        document.getElementById('try-again-btn').onclick = () => startQuiz(currentUnit);
        document.getElementById('main-menu-btn').onclick = () => showScreen('unit-selection-screen');
      }

      // Utility Functions
      function showScreen(screenId) {
        document.querySelectorAll('.container > div:not(.hidden)').forEach(el => el.classList.add('hidden'));
        document.getElementById(screenId).classList.remove('hidden');
      }

      function hideScreen(screenId) {
        document.getElementById(screenId).classList.add('hidden');
      }

      function onLoadError(error) {
        hideScreen('loading-indicator');
        const errorDiv = document.getElementById('error-message');
        errorDiv.innerHTML = `<h2>An Error Occurred</h2><p>${error.message}</p><button onclick="initializeApp()">Try Again</button>`;
        showScreen('error-message');
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }
    </script>
  </body>
</html>